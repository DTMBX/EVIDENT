<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Batch Upload | BarberX Legal Tech</title>
    <link rel="stylesheet" href="/static/css/legal-tech-platform.css">
    <style>
        .upload-zone {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            background: var(--bg-secondary);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-zone.drag-over {
            border-color: var(--accent-blue);
            background: var(--primary-navy-10);
        }
        
        .file-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .file-card {
            background: var(--surface-color);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .file-card.video { border-left: 4px solid var(--accent-blue); }
        .file-card.pdf { border-left: 4px solid var(--error); }
        .file-card.image { border-left: 4px solid var(--success); }
        .file-card.unknown { border-left: 4px solid var(--text-secondary); }
        
        .file-icon {
            font-size: 2rem;
            width: 48px;
            text-align: center;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .file-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0.5rem;
        }
        
        .remove-btn:hover {
            color: var(--error);
            opacity: 0.7;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            transition: width 0.3s;
        }
        
        .upload-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .summary-card {
            background: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-navy);
        }
        
        .summary-label {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .results-section {
            margin-top: 2rem;
        }
        
        .result-item {
            background: var(--surface-color);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--success);
        }
        
        .result-item.failed {
            border-left-color: var(--error);
        }
    </style>
</head>
<body>
    <div class="container" style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
        
        <!-- Header -->
        <div style="margin-bottom: 2rem;">
            <h1>Unified Batch Upload</h1>
            <p style="color: var(--text-secondary); font-size: 1.125rem;">
                Upload PDFs, BWC videos, and images together. We'll automatically sort and process them in parallel.
            </p>
        </div>

        <!-- Upload Zone -->
        <div id="uploadZone" class="upload-zone">
            <div style="font-size: 3rem; margin-bottom: 1rem;">??</div>
            <h3>Drop files here or click to browse</h3>
            <p style="color: var(--text-secondary); margin-top: 1rem;">
                Supports: MP4, MOV, AVI (BWC) • PDF (Documents) • JPG, PNG (Images)
            </p>
            <input type="file" id="fileInput" multiple accept=".pdf,.mp4,.mov,.avi,.jpg,.jpeg,.png" style="display: none;">
        </div>

        <!-- File Preview -->
        <div id="filePreview" class="file-preview" style="display: none;"></div>

        <!-- Upload Button -->
        <div style="margin-top: 2rem; text-align: center;">
            <button id="uploadBtn" class="btn btn-primary" style="display: none; padding: 1rem 3rem; font-size: 1.125rem;">
                Upload All Files
            </button>
            <button id="clearBtn" class="btn btn-secondary" style="display: none; margin-left: 1rem;">
                Clear All
            </button>
        </div>

        <!-- Upload Summary -->
        <div id="uploadSummary" class="upload-summary" style="display: none;">
            <div class="summary-card">
                <div class="summary-number" id="totalFiles">0</div>
                <div class="summary-label">Total Files</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: var(--accent-blue);" id="totalVideos">0</div>
                <div class="summary-label">BWC Videos</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: var(--error);" id="totalPdfs">0</div>
                <div class="summary-label">PDFs</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: var(--success);" id="totalImages">0</div>
                <div class="summary-label">Images</div>
            </div>
        </div>

        <!-- Progress -->
        <div id="progressSection" style="display: none; margin-top: 2rem;">
            <h3>Upload Progress</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progressText" style="text-align: center; margin-top: 0.5rem; color: var(--text-secondary);">
                Preparing upload...
            </p>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="results-section" style="display: none;">
            <h2>Upload Results</h2>
            <div id="resultsContent"></div>
        </div>

    </div>

    <script>
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const uploadSummary = document.getElementById('uploadSummary');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');

        let selectedFiles = [];

        // File type detection
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['mp4', 'mov', 'avi', 'mkv', 'webm'].includes(ext)) return 'video';
            if (['pdf'].includes(ext)) return 'pdf';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) return 'image';
            return 'unknown';
        }

        // File type icons
        function getFileIcon(type) {
            const icons = {
                'video': '??',
                'pdf': '??',
                'image': '???',
                'unknown': '?'
            };
            return icons[type] || icons['unknown'];
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }

        // Update preview
        function updatePreview() {
            if (selectedFiles.length === 0) {
                filePreview.style.display = 'none';
                uploadBtn.style.display = 'none';
                clearBtn.style.display = 'none';
                uploadSummary.style.display = 'none';
                return;
            }

            filePreview.style.display = 'grid';
            uploadBtn.style.display = 'inline-block';
            clearBtn.style.display = 'inline-block';
            uploadSummary.style.display = 'grid';

            filePreview.innerHTML = '';

            // Count by type
            const counts = {total: 0, video: 0, pdf: 0, image: 0};

            selectedFiles.forEach((file, index) => {
                const type = getFileType(file.name);
                counts.total++;
                counts[type] = (counts[type] || 0) + 1;

                const card = document.createElement('div');
                card.className = `file-card ${type}`;
                card.innerHTML = `
                    <div class="file-icon">${getFileIcon(type)}</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">${formatFileSize(file.size)} • ${type.toUpperCase()}</div>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})">×</button>
                `;
                filePreview.appendChild(card);
            });

            // Update summary
            document.getElementById('totalFiles').textContent = counts.total;
            document.getElementById('totalVideos').textContent = counts.video;
            document.getElementById('totalPdfs').textContent = counts.pdf;
            document.getElementById('totalImages').textContent = counts.image;
        }

        // Remove file
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
        }

        // Click to browse
        uploadZone.addEventListener('click', () => fileInput.click());

        // File input change
        fileInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);
            selectedFiles = [...selectedFiles, ...newFiles];
            updatePreview();
        });

        // Drag and drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            
            const newFiles = Array.from(e.dataTransfer.files);
            selectedFiles = [...selectedFiles, ...newFiles];
            updatePreview();
        });

        // Clear all
        clearBtn.addEventListener('click', () => {
            selectedFiles = [];
            updatePreview();
        });

        // Upload files
        uploadBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;

            uploadBtn.disabled = true;
            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';

            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });

            try {
                progressText.textContent = `Uploading ${selectedFiles.length} files...`;
                progressFill.style.width = '50%';

                const response = await fetch('/api/upload/batch', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                progressFill.style.width = '100%';
                progressText.textContent = 'Upload complete!';

                // Show results
                setTimeout(() => {
                    displayResults(result);
                    progressSection.style.display = 'none';
                }, 1000);

            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
                uploadBtn.disabled = false;
                progressSection.style.display = 'none';
            }
        });

        // Display results
        function displayResults(result) {
            resultsSection.style.display = 'block';
            
            const summary = result.summary;
            let html = `
                <div class="upload-summary">
                    <div class="summary-card">
                        <div class="summary-number" style="color: var(--success);">${summary.total_successful}</div>
                        <div class="summary-label">Successful</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number" style="color: var(--error);">${summary.total_failed}</div>
                        <div class="summary-label">Failed</div>
                    </div>
                </div>
            `;

            // Successful uploads
            if (summary.total_successful > 0) {
                html += '<h3 style="margin-top: 2rem;">? Successful Uploads</h3>';
                
                ['video', 'pdf', 'image'].forEach(type => {
                    const items = result.results.successful[type];
                    if (items && items.length > 0) {
                        html += `<h4>${type.toUpperCase()}s (${items.length})</h4>`;
                        items.forEach(item => {
                            html += `
                                <div class="result-item">
                                    <strong>${item.filename}</strong><br>
                                    <small>Size: ${formatFileSize(item.file_size)} • Hash: ${item.file_hash.substring(0, 16)}...</small>
                                </div>
                            `;
                        });
                    }
                });
            }

            // Failed uploads
            if (summary.total_failed > 0) {
                html += '<h3 style="margin-top: 2rem; color: var(--error);">? Failed Uploads</h3>';
                result.results.failed.forEach(item => {
                    html += `
                        <div class="result-item failed">
                            <strong>${item.filename}</strong><br>
                            <small style="color: var(--error);">Error: ${item.error}</small>
                        </div>
                    `;
                });
            }

            resultsContent.innerHTML = html;

            // Clear selected files
            selectedFiles = [];
            updatePreview();
            uploadBtn.disabled = false;

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Expose removeFile globally
        window.removeFile = removeFile;
    </script>
</body>
</html>
