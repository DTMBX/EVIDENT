{% extends "_layouts/default.html" %}

{% block title %}AI Agents - BarberX{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="glass-card">
        <div class="glass-card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="mb-2 gradient-text">AI Agent Deployment Center</h1>
              <p class="text-muted mb-0">Deploy specialized AI agents to automate legal workflows</p>
            </div>
            <button class="btn btn-glass-primary" data-bs-toggle="modal" data-bs-target="#deployAgentModal">
              <i class="fas fa-robot"></i> Deploy New Agent
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Types - Row 1: Evidence Processing -->
  <div class="row mb-4">
    <div class="col-12 mb-3">
      <h4>Evidence Processing Agents</h4>
      <p class="text-muted">Automate discovery, organization, and compliance</p>
    </div>
    
    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body text-center">
          <div class="mb-3" style="font-size: 48px;">üìÇ</div>
          <h5>Discovery Processor</h5>
          <p class="text-muted" style="font-size: 13px;">Automatically categorize, extract entities, and flag key documents</p>
          <button class="btn btn-glass btn-sm" onclick="deployAgent('discovery')">
            <i class="fas fa-rocket"></i> Deploy
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body text-center">
          <div class="mb-3" style="font-size: 48px;">üìÅ</div>
          <h5>Evidence Organizer</h5>
          <p class="text-muted" style="font-size: 13px;">Structure evidence chronologically, by party, or by issue</p>
          <button class="btn btn-glass btn-sm" onclick="deployAgent('organizer')">
            <i class="fas fa-rocket"></i> Deploy
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body text-center">
          <div class="mb-3" style="font-size: 48px;">üìÖ</div>
          <h5>Timeline Builder</h5>
          <p class="text-muted" style="font-size: 13px;">Construct comprehensive timelines with conflict detection</p>
          <button class="btn btn-glass btn-sm" onclick="deployAgent('timeline')">
            <i class="fas fa-rocket"></i> Deploy
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body text-center">
          <div class="mb-3" style="font-size: 48px;">‚úÖ</div>
          <h5>Compliance Checker</h5>
          <p class="text-muted" style="font-size: 13px;">Verify Miranda, chain of custody, and privacy compliance</p>
          <button class="btn btn-glass btn-sm" onclick="deployAgent('compliance')">
            <i class="fas fa-rocket"></i> Deploy
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Types - Row 2: Document Drafting -->
  <div class="row mb-4">
    <div class="col-12 mb-3">
      <h4>Document Drafting Agents üìù</h4>
      <p class="text-muted">Generate motions, briefs, letters with proper legal citations</p>
    </div>
    
    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body text-center">
          <div class="mb-3" style="font-size: 48px;">‚öñÔ∏è</div>
          <h5>Motion Drafter</h5>
          <p class="text-muted" style="font-size: 13px;">Draft motions with case law research and Bluebook citations</p>
          <button class="btn btn-glass btn-sm" onclick="deployAgent('motion_drafter')">
            <i class="fas fa-rocket"></i> Deploy
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body text-center">
          <div class="mb-3" style="font-size: 48px;">üìÑ</div>
          <h5>Brief Writer</h5>
          <p class="text-muted" style="font-size: 13px;">Write comprehensive legal briefs with table of authorities</p>
          <button class="btn btn-glass btn-sm" onclick="deployAgent('brief_writer')">
            <i class="fas fa-rocket"></i> Deploy
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body text-center">
          <div class="mb-3" style="font-size: 48px;">‚úâÔ∏è</div>
          <h5>Letter Writer</h5>
          <p class="text-muted" style="font-size: 13px;">Generate demand letters, cease & desist, opinion letters</p>
          <button class="btn btn-glass btn-sm" onclick="deployAgent('letter_writer')">
            <i class="fas fa-rocket"></i> Deploy
          </button>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body text-center">
          <div class="mb-3" style="font-size: 48px;">üìú</div>
          <h5>Contract Drafter</h5>
          <p class="text-muted" style="font-size: 13px;">Draft contracts, NDAs, and agreements with jurisdiction-specific terms</p>
          <button class="btn btn-glass btn-sm" onclick="deployAgent('contract_drafter')">
            <i class="fas fa-rocket"></i> Deploy
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Agents -->
  <div class="row">
    <div class="col-12">
      <div class="glass-card">
        <div class="glass-card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Your Active Agents</h5>
            <button class="btn btn-glass btn-sm" onclick="refreshAgents()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <div class="glass-card-body p-0">
          <div id="agentsTable">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Deploy Agent Modal -->
<div class="modal fade" id="deployAgentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content glass-modal">
      <div class="modal-header">
        <h5 class="modal-title">Deploy AI Agent</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Agent Type</label>
          <select id="agentType" class="glass-input" onchange="updateAgentConfig()">
            <optgroup label="Evidence Processing">
              <option value="discovery">Discovery Processor</option>
              <option value="organizer">Evidence Organizer</option>
              <option value="timeline">Timeline Builder</option>
              <option value="compliance">Compliance Checker</option>
            </optgroup>
            <optgroup label="Document Drafting">
              <option value="motion_drafter">Motion Drafter</option>
              <option value="brief_writer">Brief Writer</option>
              <option value="letter_writer">Letter Writer</option>
              <option value="contract_drafter">Contract Drafter</option>
            </optgroup>
          </select>
            <option value="organizer">Evidence Organizer</option>
            <option value="timeline">Timeline Builder</option>
            <option value="compliance">Compliance Checker</option>
          </select>
        </div>

        <div id="agentConfigOptions">
          <!-- Dynamic configuration options -->
        </div>

        <div class="mb-3">
          <label class="form-label">Agent Name (Optional)</label>
          <input type="text" id="agentName" class="glass-input" placeholder="My Discovery Agent">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-glass-primary" onclick="confirmDeployAgent()">
          <i class="fas fa-rocket"></i> Deploy Agent
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Execute Agent Modal -->
<div class="modal fade" id="executeAgentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content glass-modal">
      <div class="modal-header">
        <h5 class="modal-title">Execute Agent: <span id="execAgentName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Input Data (JSON)</label>
          <textarea id="agentInputData" class="glass-input" rows="8" placeholder='{"files": [...], "case_id": "CR-2026-001"}'></textarea>
          <small class="text-muted">Provide input data as JSON</small>
        </div>

        <div id="agentExecutionResult" style="display: none;">
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> Agent executed successfully
          </div>
          <pre id="agentResultOutput" style="background: rgba(0,0,0,0.05); padding: 16px; border-radius: 8px; max-height: 300px; overflow-y: auto;"></pre>
        </div>

        <div id="agentExecutionError" style="display: none;">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> <span id="errorMessage"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-glass-primary" onclick="executeAgent()">
          <i class="fas fa-play"></i> Execute
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// AI Agents Management
let currentAgentId = null;

const agentConfigs = {
  discovery: {
    name: 'Discovery Processor',
    description: 'Process discovery documents automatically',
    options: [
      { key: 'auto_categorize', label: 'Auto-categorize documents', type: 'checkbox', default: true },
      { key: 'extract_entities', label: 'Extract entities (names, dates, emails)', type: 'checkbox', default: true },
      { key: 'detect_privileged', label: 'Detect privileged documents', type: 'checkbox', default: true },
      { key: 'OCR_documents', label: 'OCR scanned documents', type: 'checkbox', default: true },
      { key: 'batch_size', label: 'Batch size', type: 'number', default: 50 }
    ],
    sampleInput: {
      files: [
        { name: 'email_2026-01-15.pdf', content: 'Email content here...', type: 'email' },
        { name: 'contract.pdf', content: 'Contract content...', type: 'document' }
      ],
      case_id: 'CR-2026-001234'
    }
  },
  organizer: {
    name: 'Evidence Organizer',
    description: 'Organize evidence into structured format',
    options: [
      { 
        key: 'organization_scheme', 
        label: 'Organization scheme', 
        type: 'select', 
        default: 'chronological',
        choices: ['chronological', 'by_party', 'by_issue', 'by_type']
      },
      { key: 'create_folders', label: 'Create folder structure', type: 'checkbox', default: true },
      { key: 'generate_index', label: 'Generate index', type: 'checkbox', default: true },
      { key: 'link_related', label: 'Link related evidence', type: 'checkbox', default: true }
    ],
    sampleInput: {
      evidence: [
        { id: 'EV-001', date: '2026-01-15', type: 'video', party: 'Defendant' },
        { id: 'EV-002', date: '2026-01-16', type: 'document', party: 'Plaintiff' }
      ]
    }
  },
  timeline: {
    name: 'Timeline Builder',
    description: 'Build comprehensive case timelines',
    options: [
      { key: 'auto_sort', label: 'Auto-sort chronologically', type: 'checkbox', default: true },
      { key: 'detect_conflicts', label: 'Detect conflicting accounts', type: 'checkbox', default: true },
      { key: 'group_by_day', label: 'Group events by day', type: 'checkbox', default: true },
      { key: 'include_source', label: 'Include source references', type: 'checkbox', default: true }
    ],
    sampleInput: {
      events: [
        { date: '2026-01-15', description: 'Incident occurred', source: 'Police Report' },
        { date: '2026-01-16', description: 'Suspect arrested', source: 'Arrest Record' }
      ]
    }
  },
  compliance: {
    name: 'Compliance Checker',
    description: 'Check for legal compliance issues',
    options: [
      { key: 'check_miranda', label: 'Check Miranda warnings', type: 'checkbox', default: true },
      { key: 'check_chain_of_custody', label: 'Check chain of custody', type: 'checkbox', default: true },
      { key: 'check_discovery_compliance', label: 'Check discovery compliance', type: 'checkbox', default: true },
      { key: 'check_privacy', label: 'Check privacy compliance (HIPAA/PII)', type: 'checkbox', default: true }
    ],
    sampleInput: {
      evidence: [
        { id: 'EV-001', type: 'interrogation', content: 'Interview content...' }
      ],
      case_type: 'criminal'
    }
  }
};

function updateAgentConfig() {
  const agentType = document.getElementById('agentType').value;
  const config = agentConfigs[agentType];
  const container = document.getElementById('agentConfigOptions');
  
  let html = `<h6 class="mb-3">${config.name} Configuration</h6>`;
  
  config.options.forEach(option => {
    if (option.type === 'checkbox') {
      html += `
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="config_${option.key}" ${option.default ? 'checked' : ''}>
          <label class="form-check-label" for="config_${option.key}">
            ${option.label}
          </label>
        </div>
      `;
    } else if (option.type === 'select') {
      html += `
        <div class="mb-3">
          <label class="form-label">${option.label}</label>
          <select id="config_${option.key}" class="glass-input">
            ${option.choices.map(choice => `
              <option value="${choice}" ${choice === option.default ? 'selected' : ''}>${choice}</option>
            `).join('')}
          </select>
        </div>
      `;
    } else if (option.type === 'number') {
      html += `
        <div class="mb-3">
          <label class="form-label">${option.label}</label>
          <input type="number" id="config_${option.key}" class="glass-input" value="${option.default}">
        </div>
      `;
    }
  });
  
  container.innerHTML = html;
}

async function deployAgent(agentType) {
  document.getElementById('agentType').value = agentType;
  updateAgentConfig();
  
  const modal = new bootstrap.Modal(document.getElementById('deployAgentModal'));
  modal.show();
}

async function confirmDeployAgent() {
  const agentType = document.getElementById('agentType').value;
  const config = agentConfigs[agentType];
  
  // Collect configuration
  const agentConfig = {};
  config.options.forEach(option => {
    const element = document.getElementById(`config_${option.key}`);
    if (element) {
      if (option.type === 'checkbox') {
        agentConfig[option.key] = element.checked;
      } else {
        agentConfig[option.key] = element.value;
      }
    }
  });
  
  try {
    const response = await fetch('/api/agents/deploy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        agent_type: agentType,
        config: agentConfig
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      showToast(`Agent deployed: ${data.agent_id}`, 'success');
      bootstrap.Modal.getInstance(document.getElementById('deployAgentModal')).hide();
      refreshAgents();
    } else {
      showToast('Failed to deploy agent: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch (err) {
    console.error('Deploy error:', err);
    showToast('Failed to deploy agent', 'error');
  }
}

async function refreshAgents() {
  try {
    const response = await fetch('/api/agents/list');
    const agents = await response.json();
    
    renderAgentsTable(agents);
  } catch (err) {
    console.error('Refresh error:', err);
    showToast('Failed to load agents', 'error');
  }
}

function renderAgentsTable(agents) {
  const container = document.getElementById('agentsTable');
  
  if (agents.length === 0) {
    container.innerHTML = `
      <div class="p-5 text-center text-muted">
        <i class="fas fa-robot" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
        <p>No agents deployed yet</p>
        <button class="btn btn-glass-primary" data-bs-toggle="modal" data-bs-target="#deployAgentModal">
          Deploy Your First Agent
        </button>
      </div>
    `;
    return;
  }
  
  let html = `
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead style="background: rgba(0,0,0,0.02);">
          <tr>
            <th>Agent ID</th>
            <th>Name</th>
            <th>Type</th>
            <th>Status</th>
            <th>Last Run</th>
            <th>Results</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  agents.forEach(agent => {
    const statusColors = {
      idle: 'text-muted',
      processing: 'text-warning',
      completed: 'text-success',
      failed: 'text-danger',
      paused: 'text-info'
    };
    
    html += `
      <tr>
        <td><code>${agent.agent_id}</code></td>
        <td>${agent.name}</td>
        <td>
          <span class="glass-badge">${agent.capability.replace('_', ' ')}</span>
        </td>
        <td>
          <span class="status-dot ${agent.status === 'completed' ? 'online' : agent.status === 'processing' ? 'busy' : 'offline'}"></span>
          <span class="${statusColors[agent.status]}">${agent.status}</span>
        </td>
        <td>${agent.last_run ? new Date(agent.last_run).toLocaleString() : 'Never'}</td>
        <td>${agent.results_count || 0} runs</td>
        <td>
          <button class="btn btn-glass btn-sm" onclick="showExecuteModal('${agent.agent_id}', '${agent.name}', '${agent.capability}')">
            <i class="fas fa-play"></i> Execute
          </button>
          <button class="btn btn-glass btn-sm" onclick="viewAgentResults('${agent.agent_id}')">
            <i class="fas fa-eye"></i> Results
          </button>
          <button class="btn btn-glass btn-sm text-danger" onclick="deleteAgent('${agent.agent_id}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  container.innerHTML = html;
}

function showExecuteModal(agentId, agentName, capability) {
  currentAgentId = agentId;
  document.getElementById('execAgentName').textContent = agentName;
  
  // Pre-fill with sample input
  const agentType = capability.replace('_', '-').split('-')[0];
  const config = agentConfigs[agentType];
  if (config) {
    document.getElementById('agentInputData').value = JSON.stringify(config.sampleInput, null, 2);
  }
  
  document.getElementById('agentExecutionResult').style.display = 'none';
  document.getElementById('agentExecutionError').style.display = 'none';
  
  const modal = new bootstrap.Modal(document.getElementById('executeAgentModal'));
  modal.show();
}

async function executeAgent() {
  if (!currentAgentId) return;
  
  const inputData = document.getElementById('agentInputData').value;
  
  try {
    const parsedInput = JSON.parse(inputData);
    
    const response = await fetch(`/api/agents/execute/${currentAgentId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ input_data: parsedInput })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      document.getElementById('agentResultOutput').textContent = JSON.stringify(result, null, 2);
      document.getElementById('agentExecutionResult').style.display = 'block';
      document.getElementById('agentExecutionError').style.display = 'none';
      refreshAgents();
    } else {
      document.getElementById('errorMessage').textContent = result.error || 'Unknown error';
      document.getElementById('agentExecutionError').style.display = 'block';
      document.getElementById('agentExecutionResult').style.display = 'none';
    }
  } catch (err) {
    console.error('Execute error:', err);
    document.getElementById('errorMessage').textContent = err.message;
    document.getElementById('agentExecutionError').style.display = 'block';
  }
}

async function viewAgentResults(agentId) {
  try {
    const response = await fetch(`/api/agents/status/${agentId}`);
    const agent = await response.json();
    
    alert(`Agent Results:\n\n${JSON.stringify(agent, null, 2)}`);
  } catch (err) {
    console.error('View error:', err);
    showToast('Failed to load results', 'error');
  }
}

async function deleteAgent(agentId) {
  if (!confirm('Are you sure you want to delete this agent?')) return;
  
  try {
    const response = await fetch(`/api/agents/${agentId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      showToast('Agent deleted', 'success');
      refreshAgents();
    } else {
      showToast('Failed to delete agent', 'error');
    }
  } catch (err) {
    console.error('Delete error:', err);
    showToast('Failed to delete agent', 'error');
  }
}

function showToast(message, type) {
  console.log(`[${type}] ${message}`);
  // TODO: Implement toast notification
}

// Initialize
updateAgentConfig();
refreshAgents();
</script>

<!-- Bootstrap JS for modals -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
