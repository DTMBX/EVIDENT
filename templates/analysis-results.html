<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analysis Results | BarberX Legal Tech</title>
    <link rel="stylesheet" href="/assets/css/legal-tech-platform.css" />
    <style>
      body {
        background: #f8f9fa;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      :root {
        --bg-color: #f8f9fa;
        --surface-color: #ffffff;
        --primary-navy: #1e3a8a;
        --accent-blue: #3b82f6;
        --text-secondary: #6c757d;
      }

      .page-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        color: white;
        padding: 1.5rem 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .page-header h1 {
        margin: 0;
        font-size: 1.5rem;
      }
      
      .page-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 0.875rem;
      }

      .status-completed {
        background: #10b98120;
        color: #059669;
      }

      .status-analyzing {
        background: #3b82f620;
        color: #2563eb;
      }

      .status-failed {
        background: #ef444420;
        color: #dc2626;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: var(--surface-color);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
      }

      .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-navy);
        margin-bottom: 0.5rem;
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .action-card {
        background: var(--surface-color);
        padding: 1.5rem;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
      }

      .action-card:hover {
        transform: translateY(-4px);
        border-color: var(--accent-blue);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      .action-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
      }

      .action-title {
        font-size: 1.125rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--primary-navy);
      }

      .action-description {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .section {
        background: var(--surface-color);
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: var(--primary-navy);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .discrepancy-item {
        padding: 1.5rem;
        border-left: 4px solid;
        background: var(--bg-color);
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      .discrepancy-high {
        border-left-color: #dc2626;
      }

      .discrepancy-medium {
        border-left-color: #f59e0b;
      }

      .discrepancy-low {
        border-left-color: #3b82f6;
      }

      .discrepancy-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .discrepancy-type {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.05em;
      }

      .severity-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
      }

      .severity-high {
        background: #dc262620;
        color: #dc2626;
      }

      .severity-medium {
        background: #f59e0b20;
        color: #d97706;
      }

      .severity-low {
        background: #3b82f620;
        color: #2563eb;
      }

      .timeline-item {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        position: relative;
      }

      .timeline-item:not(:last-child):before {
        content: '';
        position: absolute;
        left: 21px;
        top: 48px;
        width: 2px;
        height: calc(100% - 32px);
        background: var(--border-color);
      }

      .timeline-marker {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--accent-blue);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        color: white;
        font-weight: 700;
      }

      .timeline-content {
        flex: 1;
        padding: 1rem;
        background: var(--bg-color);
        border-radius: 8px;
      }

      .timeline-time {
        font-family: 'Courier New', monospace;
        font-weight: 700;
        color: var(--accent-blue);
        margin-bottom: 0.5rem;
      }

      .timeline-title {
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      .timeline-description {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background: var(--accent-blue);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
      }

      .btn:hover {
        background: var(--primary-navy);
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: transparent;
        border: 2px solid var(--accent-blue);
        color: var(--accent-blue);
      }

      .btn-secondary:hover {
        background: var(--accent-blue);
        color: white;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="results-container">
      <div class="results-header">
        <h1 class="header-title" id="analysisTitle">Loading Analysis...</h1>
        <div class="header-meta">
          <span id="analysisStatus">Status: Loading...</span>
          <span id="analysisDate">Date: Loading...</span>
          <span id="analysisCase">Case: Loading...</span>
        </div>
      </div>

      <div id="loadingState" style="text-align: center; padding: 4rem;">
        <div class="loading-spinner" style="width: 60px; height: 60px; border-width: 6px;"></div>
        <p style="margin-top: 1rem; color: var(--text-secondary);">Loading analysis results...</p>
      </div>

      <div id="resultsContent" style="display: none;">
        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statDuration">-</div>
            <div class="stat-label">Duration</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statSpeakers">-</div>
            <div class="stat-label">Speakers</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statSegments">-</div>
            <div class="stat-label">Segments</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statDiscrepancies">-</div>
            <div class="stat-label">Discrepancies</div>
          </div>
        </div>

        <!-- Action Cards -->
        <div class="action-grid">
          <div class="action-card" onclick="viewTranscript()">
            <div class="action-icon">üìÑ</div>
            <div class="action-title">View Transcript</div>
            <div class="action-description">Full transcription with timestamps</div>
          </div>
          <div class="action-card" onclick="viewTimeline()">
            <div class="action-icon">‚è±Ô∏è</div>
            <div class="action-title">View Timeline</div>
            <div class="action-description">Event sequence visualization</div>
          </div>
          <div class="action-card" onclick="viewDiscrepancies()">
            <div class="action-icon">‚ö†Ô∏è</div>
            <div class="action-title">View Discrepancies</div>
            <div class="action-description">Identified contradictions</div>
          </div>
          <div class="action-card" onclick="downloadReport()">
            <div class="action-icon">‚¨áÔ∏è</div>
            <div class="action-title">Download Report</div>
            <div class="action-description">Export in multiple formats</div>
          </div>
        </div>

        <!-- Discrepancies Section -->
        <div class="section" id="discrepanciesSection">
          <h2 class="section-title">
            <span>‚ö†Ô∏è</span>
            Identified Discrepancies
          </h2>
          <div id="discrepanciesList">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Timeline Section -->
        <div class="section" id="timelineSection">
          <h2 class="section-title">
            <span>‚è±Ô∏è</span>
            Event Timeline
          </h2>
          <div id="timelineList">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Include Transcript Viewer Component -->
    {% include 'components/transcript-viewer.html' %}

    <script>
      const analysisId = new URLSearchParams(window.location.search).get('id');
      let analysisData = null;

      async function loadAnalysis() {
        try {
          const response = await fetch(`/api/analysis/${analysisId}`);
          analysisData = await response.json();
          
          if (analysisData.status === 'analyzing') {
            // Poll for updates
            setTimeout(loadAnalysis, 3000);
          }
          
          renderAnalysis();
        } catch (error) {
          console.error('Error loading analysis:', error);
          document.getElementById('loadingState').innerHTML = 
            '<p style="color: #dc2626;">Error loading analysis. Please try again.</p>';
        }
      }

      function renderAnalysis() {
        // Update header
        document.getElementById('analysisTitle').textContent = 
          `Analysis: ${analysisData.filename}`;
        
        const statusBadge = getStatusBadge(analysisData.status);
        document.getElementById('analysisStatus').innerHTML = 
          `Status: ${statusBadge}`;
        
        document.getElementById('analysisDate').textContent = 
          `Date: ${new Date(analysisData.created_at).toLocaleString()}`;
        
        document.getElementById('analysisCase').textContent = 
          `Case: ${analysisData.case_number || 'N/A'}`;
        
        if (analysisData.status === 'completed') {
          // Show results
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('resultsContent').style.display = 'block';
          
          // Load report data
          loadReportData();
        }
      }

      async function loadReportData() {
        try {
          const response = await fetch(`/api/analysis/${analysisId}/report/json`);
          const report = await response.json();
          
          // Update stats
          document.getElementById('statDuration').textContent = 
            formatDuration(report.metadata.duration);
          document.getElementById('statSpeakers').textContent = 
            report.transcript.speakers.length;
          document.getElementById('statSegments').textContent = 
            report.transcript.total_segments;
          document.getElementById('statDiscrepancies').textContent = 
            report.discrepancies.total;
          
          // Render discrepancies
          renderDiscrepancies(report.discrepancies.items);
          
          // Render timeline
          renderTimeline(report.timeline);
          
        } catch (error) {
          console.error('Error loading report:', error);
        }
      }

      function renderDiscrepancies(discrepancies) {
        const container = document.getElementById('discrepanciesList');
        
        if (!discrepancies || discrepancies.length === 0) {
          container.innerHTML = '<p style="color: var(--text-secondary);">No discrepancies detected.</p>';
          return;
        }
        
        container.innerHTML = discrepancies.map(d => `
          <div class="discrepancy-item discrepancy-${d.severity}">
            <div class="discrepancy-header">
              <span class="discrepancy-type">${d.type}</span>
              <span class="severity-badge severity-${d.severity}">${d.severity}</span>
            </div>
            <p>${d.description}</p>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
              Timestamp: ${formatTimestamp(d.timestamp)} | Sources: ${d.source_conflict.join(', ')}
            </p>
            <p style="font-size: 0.875rem; font-style: italic; margin-top: 0.5rem; color: var(--accent-blue);">
              Recommendation: ${d.recommendation}
            </p>
          </div>
        `).join('');
      }

      function renderTimeline(timeline) {
        const container = document.getElementById('timelineList');
        
        if (!timeline || timeline.length === 0) {
          container.innerHTML = '<p style="color: var(--text-secondary);">No timeline data available.</p>';
          return;
        }
        
        container.innerHTML = timeline.map((event, index) => `
          <div class="timeline-item">
            <div class="timeline-marker">${index + 1}</div>
            <div class="timeline-content">
              <div class="timeline-time">${formatTimestamp(event.timestamp)}</div>
              <div class="timeline-title">${event.type}</div>
              <div class="timeline-description">${event.description}</div>
              <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                Source: ${event.source}
              </div>
            </div>
          </div>
        `).join('');
      }

      function getStatusBadge(status) {
        const badges = {
          'completed': '<span class="status-badge status-completed">‚úì Completed</span>',
          'analyzing': '<span class="status-badge status-analyzing"><span class="loading-spinner"></span> Analyzing</span>',
          'failed': '<span class="status-badge status-failed">‚úó Failed</span>',
          'uploaded': '<span class="status-badge status-analyzing">Pending</span>'
        };
        return badges[status] || status;
      }

      function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      function formatTimestamp(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = (seconds % 60).toFixed(1);
        return `${mins}:${secs.padStart(4, '0')}`;
      }

      function viewTranscript() {
        showTranscript(analysisId);
      }

      function viewTimeline() {
        document.getElementById('timelineSection').scrollIntoView({ behavior: 'smooth' });
      }

      function viewDiscrepancies() {
        document.getElementById('discrepanciesSection').scrollIntoView({ behavior: 'smooth' });
      }

      function downloadReport() {
        const formats = ['json', 'txt', 'md'];
        const format = prompt('Select format: json, txt, or md', 'json');
        
        if (formats.includes(format)) {
          window.location.href = `/api/analysis/${analysisId}/report/${format}`;
        }
      }

      // Load analysis on page load
      if (analysisId) {
        loadAnalysis();
      } else {
        document.getElementById('loadingState').innerHTML = 
          '<p style="color: #dc2626;">No analysis ID provided.</p>';
      }
    </script>
  </body>
</html>
