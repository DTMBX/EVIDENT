<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#c41e3a" />
    <title>BarberX Workspace - Unified Legal Tech Platform</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/assets/css/brand-tokens.css" />
    <link rel="stylesheet" href="/assets/css/legal-tech-platform.css" />
    <link rel="stylesheet" href="/assets/css/ux-enhancements.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --brand-primary: #c41e3a;
        --brand-gold: #d4af37;
        --navy-dark: #0a2540;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --bg-light: #f8fafc;
        --border-color: #e2e8f0;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --sidebar-width: 280px;
        --topbar-height: 64px;
        --chat-width: 380px;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-light);
        color: var(--text-primary);
        overflow: hidden;
      }

      /* Main Layout Grid */
      .workspace-grid {
        display: grid;
        grid-template-columns: var(--sidebar-width) 1fr var(--chat-width);
        grid-template-rows: var(--topbar-height) 1fr;
        height: 100vh;
        grid-template-areas:
          "sidebar topbar chat-header"
          "sidebar main chat";
      }

      /* Top Bar */
      .topbar {
        grid-area: topbar;
        background: white;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2rem;
        box-shadow: 0 1px 3px rgb(0 0 0 / 5%);
        z-index: 100;
      }

      .topbar-left {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .workspace-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .user-menu:hover {
        background: var(--bg-light);
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--brand-primary),
          var(--brand-gold)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      /* Sidebar */
      .sidebar {
        grid-area: sidebar;
        background: linear-gradient(180deg, #0a2540 0%, #16213e 100%);
        color: white;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .sidebar-brand {
        padding: 1.5rem;
        border-bottom: 1px solid rgb(255 255 255 / 10%);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .brand-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          var(--brand-primary),
          var(--brand-gold)
        );
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.25rem;
      }

      .brand-text {
        font-size: 1.125rem;
        font-weight: 700;
      }

      .nav-section {
        padding: 1.5rem 1rem;
        border-bottom: 1px solid rgb(255 255 255 / 10%);
      }

      .nav-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgb(255 255 255 / 50%);
        margin-bottom: 0.75rem;
        padding: 0 0.75rem;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        margin-bottom: 0.25rem;
        border-radius: 8px;
        color: rgb(255 255 255 / 80%);
        text-decoration: none;
        transition: all 0.2s;
        cursor: pointer;
      }

      .nav-item:hover {
        background: rgb(255 255 255 / 10%);
        color: white;
      }

      .nav-item.active {
        background: linear-gradient(
          135deg,
          var(--brand-primary),
          var(--brand-gold)
        );
        color: white;
        font-weight: 600;
      }

      .nav-icon {
        font-size: 1.125rem;
        width: 24px;
        text-align: center;
      }

      /* Main Content Area */
      .main-content {
        grid-area: main;
        overflow-y: auto;
        padding: 2rem;
      }

      .view-panel {
        display: none;
      }

      .view-panel.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px rgb(0 0 0 / 5%);
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .stat-progress {
        margin-top: 1rem;
        height: 6px;
        background: var(--bg-light);
        border-radius: 3px;
        overflow: hidden;
      }

      .stat-progress-bar {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--brand-primary),
          var(--brand-gold)
        );
        transition: width 0.3s ease;
      }

      /* Chat Panel */
      .chat-header {
        grid-area: chat-header;
        background: white;
        border-bottom: 1px solid var(--border-color);
        border-left: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.5rem;
      }

      .chat-title {
        font-weight: 600;
        color: var(--text-primary);
      }

      .chat-panel {
        grid-area: chat;
        background: white;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .chat-message {
        display: flex;
        gap: 0.75rem;
        max-width: 90%;
      }

      .chat-message.user {
        margin-left: auto;
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--brand-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        flex-shrink: 0;
      }

      .message-content {
        background: var(--bg-light);
        padding: 0.75rem 1rem;
        border-radius: 12px;
        line-height: 1.5;
      }

      .chat-message.user .message-content {
        background: linear-gradient(
          135deg,
          var(--brand-primary),
          var(--brand-gold)
        );
        color: white;
      }

      .chat-input-area {
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
      }

      .chat-input-wrapper {
        display: flex;
        gap: 0.75rem;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9375rem;
        resize: none;
        min-height: 44px;
        max-height: 120px;
      }

      .chat-send {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(
          135deg,
          var(--brand-primary),
          var(--brand-gold)
        );
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .chat-send:hover {
        transform: translateY(-1px);
      }

      /* Upload Area */
      .upload-zone {
        background: white;
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .upload-zone:hover {
        border-color: var(--brand-primary);
        background: rgb(196 30 58 / 2%);
      }

      .upload-icon {
        font-size: 3rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
      }

      /* Analysis Results */
      .results-container {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid var(--border-color);
      }

      .result-section {
        margin-bottom: 2rem;
      }

      .result-header {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-primary);
      }

      .finding-item {
        padding: 1rem;
        background: var(--bg-light);
        border-left: 4px solid var(--brand-primary);
        border-radius: 8px;
        margin-bottom: 0.75rem;
      }

      .finding-severity {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }

      .finding-severity.high {
        background: rgb(239 68 68 / 10%);
        color: #dc2626;
      }

      .finding-severity.medium {
        background: rgb(245 158 11 / 10%);
        color: #d97706;
      }

      .finding-severity.low {
        background: rgb(16 185 129 / 10%);
        color: #059669;
      }

      /* Tool Panels */
      .tool-panel {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
      }

      .tool-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
      }

      .tool-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        font-size: 0.9375rem;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--brand-primary),
          var(--brand-gold)
        );
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgb(196 30 58 / 30%);
      }

      .btn-secondary {
        background: white;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--bg-light);
      }

      /* Responsive */
      @media (max-width: 1400px) {
        .workspace-grid {
          grid-template-columns: var(--sidebar-width) 1fr;
          grid-template-areas:
            "sidebar topbar"
            "sidebar main";
        }
        .chat-header,
        .chat-panel {
          display: none;
        }
        /* Floating chat button for tablet */
        .chat-toggle-btn {
          display: flex;
        }
        .chat-floating {
          position: fixed;
          bottom: 80px;
          right: 20px;
          width: min(380px, calc(100vw - 40px));
          height: min(500px, calc(100vh - 160px));
          z-index: 900;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.2);
          display: none;
        }
        .chat-floating.open {
          display: flex;
          flex-direction: column;
          animation: slideUp 0.3s ease;
        }
      }

      @media (max-width: 768px) {
        .workspace-grid {
          grid-template-columns: 1fr;
          grid-template-areas:
            "topbar"
            "main";
        }
        .sidebar {
          position: fixed;
          left: -100%;
          top: 0;
          bottom: 0;
          z-index: 1000;
          transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar.open {
          left: 0;
        }
        .sidebar-overlay {
          display: none;
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.5);
          z-index: 999;
        }
        .sidebar.open + .sidebar-overlay {
          display: block;
        }
        .stats-grid {
          grid-template-columns: 1fr 1fr;
        }
        .topbar-actions {
          gap: 0.5rem;
        }
        .main-content {
          padding: 1rem;
        }
      }

      @media (max-width: 480px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }
        .stat-card {
          padding: 1rem;
        }
        .stat-value {
          font-size: 1.5rem;
        }
        .topbar {
          padding: 0 1rem;
        }
        .workspace-title {
          font-size: 1rem;
        }
        .breadcrumb {
          display: none;
        }
      }

      /* Chat toggle button */
      .chat-toggle-btn {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-gold));
        color: white;
        border: none;
        cursor: pointer;
        z-index: 800;
        box-shadow: 0 4px 12px rgba(196, 30, 58, 0.4);
        font-size: 1.5rem;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .chat-toggle-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(196, 30, 58, 0.5);
      }

      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Safe area for notched devices */
      @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .sidebar {
          padding-bottom: env(safe-area-inset-bottom);
        }
        .chat-toggle-btn {
          bottom: calc(20px + env(safe-area-inset-bottom));
        }
      }

      /* Legal Trinity Styles */
      .trinity-tab {
        padding: 0.625rem 1rem;
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.9375rem;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }
      .trinity-tab:hover {
        color: var(--brand-primary);
      }
      .trinity-tab.active {
        color: var(--brand-primary);
        border-bottom-color: var(--brand-primary);
      }
      .tab-count {
        background: var(--bg-light);
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .trinity-tab.active .tab-count {
        background: var(--brand-primary);
        color: white;
      }

      .trinity-result-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
        border-left: 4px solid var(--border-color);
      }
      .trinity-result-card:hover {
        box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
        transform: translateY(-2px);
      }
      .trinity-result-card.federal {
        border-left-color: #1e40af;
      }
      .trinity-result-card.state {
        border-left-color: #059669;
      }
      .trinity-result-card.local {
        border-left-color: #d97706;
      }

      .trinity-level-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .trinity-level-badge.federal {
        background: #dbeafe;
        color: #1e40af;
      }
      .trinity-level-badge.state {
        background: #d1fae5;
        color: #059669;
      }
      .trinity-level-badge.local {
        background: #fef3c7;
        color: #d97706;
      }

      .municipality-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 0.75rem;
      }
      .municipality-card:hover {
        background: var(--bg-light);
      }
      .muni-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .muni-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          var(--brand-primary),
          var(--brand-gold)
        );
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
      }
      .muni-actions {
        display: flex;
        gap: 0.5rem;
      }
      .muni-actions button {
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
      }

      .trinity-hierarchy-note {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
        background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%);
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid #bbf7d0;
      }
      .trinity-hierarchy-note i {
        color: #059669;
        font-size: 1.25rem;
        margin-top: 0.125rem;
      }
    </style>
  </head>
  <body>
    <div class="workspace-grid">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-brand">
          <div class="brand-icon">BX</div>
          <div class="brand-text">BarberX</div>
        </div>

        <nav class="nav-section">
          <div class="nav-section-title">Main</div>
          <a class="nav-item active" data-view="dashboard">
            <i class="nav-icon fas fa-chart-line"></i>
            <span>Dashboard</span>
          </a>
          <a class="nav-item" data-view="upload">
            <i class="nav-icon fas fa-upload"></i>
            <span>Upload Evidence</span>
          </a>
          <a class="nav-item" data-view="analyses">
            <i class="nav-icon fas fa-list"></i>
            <span>My Analyses</span>
          </a>
        </nav>

        <nav class="nav-section">
          <div class="nav-section-title">Analysis Tools</div>
          <a class="nav-item" data-view="trinity">
            <i class="nav-icon fas fa-balance-scale"></i>
            <span>Legal Trinity</span>
          </a>
          <a class="nav-item" data-view="transcript">
            <i class="nav-icon fas fa-file-alt"></i>
            <span>Transcript Search</span>
          </a>
          <a class="nav-item" data-view="timeline">
            <i class="nav-icon fas fa-clock"></i>
            <span>Timeline Builder</span>
          </a>
          <a class="nav-item" data-view="entities">
            <i class="nav-icon fas fa-users"></i>
            <span>Entity Extraction</span>
          </a>
          <a class="nav-item" data-view="violations">
            <i class="nav-icon fas fa-exclamation-triangle"></i>
            <span>Violation Scanner</span>
          </a>
        </nav>

        <nav class="nav-section">
          <div class="nav-section-title">Account</div>
          <a class="nav-item" data-view="settings">
            <i class="nav-icon fas fa-cog"></i>
            <span>Settings</span>
          </a>
          <a class="nav-item" data-view="subscription">
            <i class="nav-icon fas fa-crown"></i>
            <span>Subscription</span>
          </a>
          <a href="/auth/logout" class="nav-item">
            <i class="nav-icon fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </nav>
      </aside>

      <!-- Top Bar -->
      <header class="topbar">
        <div class="topbar-left">
          <h1 class="workspace-title">BarberX Workspace</h1>
          <div class="breadcrumb">
            <i class="fas fa-home"></i>
            <span>/</span>
            <span id="currentView">Dashboard</span>
          </div>
        </div>
        <div class="topbar-actions">
          <button class="btn btn-secondary" id="notificationsBtn">
            <i class="fas fa-bell"></i>
          </button>
          <div class="user-menu">
            <div class="user-avatar">
              {{ current_user.email[0].upper() if current_user.is_authenticated
              else 'U' }}
            </div>
            <div>
              <div style="font-weight: 600; font-size: 0.875rem">
                {{ current_user.email if current_user.is_authenticated else
                'User' }}
              </div>
              <div style="font-size: 0.75rem; color: var(--text-secondary)">
                {{ current_user.tier|title if current_user.is_authenticated else
                'Free' }} Tier
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Dashboard View -->
        <div class="view-panel active" id="view-dashboard">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Analyses This Month</div>
              <div class="stat-value" id="statsAnalyses">0</div>
              <div class="stat-progress">
                <div
                  class="stat-progress-bar"
                  id="progressAnalyses"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Storage Used</div>
              <div class="stat-value" id="statsStorage">0 GB</div>
              <div class="stat-progress">
                <div
                  class="stat-progress-bar"
                  id="progressStorage"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Completed</div>
              <div class="stat-value" id="statsCompleted">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Account Status</div>
              <div class="stat-value" style="font-size: 1.5rem">
                {{ current_user.tier|title if current_user.is_authenticated else
                'Free' }}
              </div>
            </div>
          </div>

          <!-- Smart Meter Usage Dashboard -->
          <div class="results-container" style="margin-top: 1.5rem">
            <div class="result-header">
              <i class="fas fa-tachometer-alt" style="margin-right: 0.5rem"></i>
              Smart Meter Usage Dashboard
            </div>
            <div style="padding: 1.5rem">
              <!-- Usage Quotas Grid -->
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                  gap: 1rem;
                  margin-bottom: 2rem;
                "
              >
                <!-- AI Tokens Meter -->
                <div class="quota-meter">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <span style="font-weight: 600; color: var(--text-primary)">
                      <i
                        class="fas fa-brain"
                        style="color: #d4af37; margin-right: 0.5rem"
                      ></i>
                      AI Tokens
                    </span>
                    <span
                      id="tokensPercent"
                      style="font-size: 0.875rem; color: var(--text-secondary)"
                      >0%</span
                    >
                  </div>
                  <div
                    style="
                      background: var(--bg-light);
                      border-radius: 8px;
                      height: 8px;
                      overflow: hidden;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <div
                      id="tokensBar"
                      style="
                        height: 100%;
                        background: linear-gradient(90deg, #d4af37, #f4d47f);
                        width: 0%;
                        transition: width 0.3s;
                      "
                    ></div>
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 0.8125rem;
                    "
                  >
                    <span id="tokensUsed" style="color: var(--text-secondary)"
                      >0</span
                    >
                    <span id="tokensLimit" style="color: var(--text-secondary)"
                      >0</span
                    >
                  </div>
                </div>

                <!-- AI Requests Meter -->
                <div class="quota-meter">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <span style="font-weight: 600; color: var(--text-primary)">
                      <i
                        class="fas fa-robot"
                        style="color: #4a9eff; margin-right: 0.5rem"
                      ></i>
                      AI Requests
                    </span>
                    <span
                      id="requestsPercent"
                      style="font-size: 0.875rem; color: var(--text-secondary)"
                      >0%</span
                    >
                  </div>
                  <div
                    style="
                      background: var(--bg-light);
                      border-radius: 8px;
                      height: 8px;
                      overflow: hidden;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <div
                      id="requestsBar"
                      style="
                        height: 100%;
                        background: linear-gradient(90deg, #4a9eff, #7cb9ff);
                        width: 0%;
                        transition: width 0.3s;
                      "
                    ></div>
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 0.8125rem;
                    "
                  >
                    <span id="requestsUsed" style="color: var(--text-secondary)"
                      >0</span
                    >
                    <span
                      id="requestsLimit"
                      style="color: var(--text-secondary)"
                      >0</span
                    >
                  </div>
                </div>

                <!-- Storage Meter -->
                <div class="quota-meter">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <span style="font-weight: 600; color: var(--text-primary)">
                      <i
                        class="fas fa-hdd"
                        style="color: #ff6b6b; margin-right: 0.5rem"
                      ></i>
                      Storage
                    </span>
                    <span
                      id="storagePercent"
                      style="font-size: 0.875rem; color: var(--text-secondary)"
                      >0%</span
                    >
                  </div>
                  <div
                    style="
                      background: var(--bg-light);
                      border-radius: 8px;
                      height: 8px;
                      overflow: hidden;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <div
                      id="storageBar"
                      style="
                        height: 100%;
                        background: linear-gradient(90deg, #ff6b6b, #ff9e9e);
                        width: 0%;
                        transition: width 0.3s;
                      "
                    ></div>
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 0.8125rem;
                    "
                  >
                    <span id="storageUsed" style="color: var(--text-secondary)"
                      >0 MB</span
                    >
                    <span id="storageLimit" style="color: var(--text-secondary)"
                      >0 MB</span
                    >
                  </div>
                </div>

                <!-- Files Meter -->
                <div class="quota-meter">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <span style="font-weight: 600; color: var(--text-primary)">
                      <i
                        class="fas fa-file-upload"
                        style="color: #51cf66; margin-right: 0.5rem"
                      ></i>
                      Files Uploaded
                    </span>
                    <span
                      id="filesPercent"
                      style="font-size: 0.875rem; color: var(--text-secondary)"
                      >0%</span
                    >
                  </div>
                  <div
                    style="
                      background: var(--bg-light);
                      border-radius: 8px;
                      height: 8px;
                      overflow: hidden;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <div
                      id="filesBar"
                      style="
                        height: 100%;
                        background: linear-gradient(90deg, #51cf66, #8ce99a);
                        width: 0%;
                        transition: width 0.3s;
                      "
                    ></div>
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 0.8125rem;
                    "
                  >
                    <span id="filesUsed" style="color: var(--text-secondary)"
                      >0</span
                    >
                    <span id="filesLimit" style="color: var(--text-secondary)"
                      >0</span
                    >
                  </div>
                </div>

                <!-- Analyses Meter -->
                <div class="quota-meter">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <span style="font-weight: 600; color: var(--text-primary)">
                      <i
                        class="fas fa-chart-line"
                        style="color: #9775fa; margin-right: 0.5rem"
                      ></i>
                      Analyses
                    </span>
                    <span
                      id="analysesPercent"
                      style="font-size: 0.875rem; color: var(--text-secondary)"
                      >0%</span
                    >
                  </div>
                  <div
                    style="
                      background: var(--bg-light);
                      border-radius: 8px;
                      height: 8px;
                      overflow: hidden;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <div
                      id="analysesBar"
                      style="
                        height: 100%;
                        background: linear-gradient(90deg, #9775fa, #b197fc);
                        width: 0%;
                        transition: width 0.3s;
                      "
                    ></div>
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 0.8125rem;
                    "
                  >
                    <span id="analysesUsed" style="color: var(--text-secondary)"
                      >0</span
                    >
                    <span
                      id="analysesLimit"
                      style="color: var(--text-secondary)"
                      >0</span
                    >
                  </div>
                </div>

                <!-- Cost Meter -->
                <div class="quota-meter">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <span style="font-weight: 600; color: var(--text-primary)">
                      <i
                        class="fas fa-dollar-sign"
                        style="color: #ffd43b; margin-right: 0.5rem"
                      ></i>
                      Cost This Month
                    </span>
                    <span
                      id="costPercent"
                      style="font-size: 0.875rem; color: var(--text-secondary)"
                      >0%</span
                    >
                  </div>
                  <div
                    style="
                      background: var(--bg-light);
                      border-radius: 8px;
                      height: 8px;
                      overflow: hidden;
                      margin-bottom: 0.5rem;
                    "
                  >
                    <div
                      id="costBar"
                      style="
                        height: 100%;
                        background: linear-gradient(90deg, #ffd43b, #ffe066);
                        width: 0%;
                        transition: width 0.3s;
                      "
                    ></div>
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 0.8125rem;
                    "
                  >
                    <span id="costUsed" style="color: var(--text-secondary)"
                      >$0.00</span
                    >
                    <span id="costLimit" style="color: var(--text-secondary)"
                      >$0.00</span
                    >
                  </div>
                </div>
              </div>

              <!-- Billing Period Info -->
              <div
                style="
                  padding: 1rem;
                  background: var(--bg-light);
                  border-radius: 8px;
                  border-left: 4px solid #d4af37;
                  margin-bottom: 1.5rem;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <div
                      style="
                        font-size: 0.875rem;
                        color: var(--text-secondary);
                        margin-bottom: 0.25rem;
                      "
                    >
                      Current Billing Period
                    </div>
                    <div
                      style="font-weight: 600; color: var(--text-primary)"
                      id="billingPeriod"
                    >
                      Loading...
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 0.875rem;
                        color: var(--text-secondary);
                        margin-bottom: 0.25rem;
                      "
                    >
                      Days Remaining
                    </div>
                    <div
                      style="
                        font-weight: 600;
                        color: #d4af37;
                        font-size: 1.5rem;
                      "
                      id="daysRemaining"
                    >
                      --
                    </div>
                  </div>
                </div>
              </div>

              <!-- Recent Events -->
              <div>
                <div
                  style="
                    font-weight: 600;
                    font-size: 1rem;
                    margin-bottom: 1rem;
                    color: var(--text-primary);
                  "
                >
                  <i class="fas fa-history" style="margin-right: 0.5rem"></i>
                  Recent Activity (Last 24 Hours)
                </div>
                <div
                  id="recentEvents"
                  style="max-height: 300px; overflow-y: auto"
                >
                  <p
                    style="
                      color: var(--text-secondary);
                      text-align: center;
                      padding: 2rem;
                    "
                  >
                    Loading events...
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="results-container" style="margin-top: 1.5rem">
            <div class="result-header">Recent Activity</div>
            <div id="recentActivity">
              <p
                style="
                  color: var(--text-secondary);
                  text-align: center;
                  padding: 2rem;
                "
              >
                No recent activity
              </p>
            </div>
          </div>
        </div>

        <!-- Upload View -->
        <div class="view-panel" id="view-upload">
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">Upload Evidence</h2>
            </div>
            <div
              class="upload-zone"
              onclick="document.getElementById('fileInput').click()"
            >
              <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <h3>Drop files here or click to upload</h3>
              <p style="color: var(--text-secondary); margin-top: 0.5rem">
                Supports BWC video, audio, documents, and images
              </p>
              <input type="file" id="fileInput" hidden multiple />
            </div>
          </div>
        </div>

        <!-- Analyses View -->
        <div class="view-panel" id="view-analyses">
          <div class="results-container">
            <div class="result-header">All Analyses</div>
            <div id="analysesList">
              <p
                style="
                  color: var(--text-secondary);
                  text-align: center;
                  padding: 2rem;
                "
              >
                Loading...
              </p>
            </div>
          </div>
        </div>

        <!-- Legal Trinity View -->
        <div class="view-panel" id="view-trinity">
          <!-- Trinity Header -->
          <div
            class="tool-panel"
            style="
              background: linear-gradient(135deg, #0a2540 0%, #1e3a5f 100%);
              color: white;
              margin-bottom: 1.5rem;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
              "
            >
              <div
                style="
                  width: 56px;
                  height: 56px;
                  background: linear-gradient(
                    135deg,
                    var(--brand-primary),
                    var(--brand-gold)
                  );
                  border-radius: 12px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 1.5rem;
                "
              >
                <i class="fas fa-balance-scale"></i>
              </div>
              <div>
                <h2 style="margin: 0; font-size: 1.5rem">Legal Trinity</h2>
                <p style="margin: 0; opacity: 0.8; font-size: 0.875rem">
                  Search LOCAL • STATE • FEDERAL law simultaneously
                </p>
              </div>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap">
              <div
                style="
                  background: rgba(255, 255, 255, 0.1);
                  padding: 0.75rem 1rem;
                  border-radius: 8px;
                  flex: 1;
                  min-width: 150px;
                "
              >
                <div
                  style="
                    font-size: 0.75rem;
                    opacity: 0.7;
                    text-transform: uppercase;
                  "
                >
                  Federal
                </div>
                <div style="font-weight: 600">USC • CFR • FRE</div>
              </div>
              <div
                style="
                  background: rgba(255, 255, 255, 0.1);
                  padding: 0.75rem 1rem;
                  border-radius: 8px;
                  flex: 1;
                  min-width: 150px;
                "
              >
                <div
                  style="
                    font-size: 0.75rem;
                    opacity: 0.7;
                    text-transform: uppercase;
                  "
                >
                  State
                </div>
                <div style="font-weight: 600">Statutes • Case Law</div>
              </div>
              <div
                style="
                  background: rgba(255, 255, 255, 0.1);
                  padding: 0.75rem 1rem;
                  border-radius: 8px;
                  flex: 1;
                  min-width: 150px;
                "
              >
                <div
                  style="
                    font-size: 0.75rem;
                    opacity: 0.7;
                    text-transform: uppercase;
                  "
                >
                  Local
                </div>
                <div style="font-weight: 600">Municipal Codes</div>
              </div>
            </div>
          </div>

          <!-- Search Panel -->
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">
                <i
                  class="fas fa-search"
                  style="color: var(--brand-primary); margin-right: 0.5rem"
                ></i>
                Search All Jurisdictions
              </h2>
            </div>

            <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem">
              <!-- Search Query -->
              <div>
                <label
                  style="
                    display: block;
                    margin-bottom: 0.5rem;
                    font-weight: 600;
                    color: var(--text-primary);
                  "
                  >Search Query</label
                >
                <input
                  type="text"
                  id="trinityQuery"
                  placeholder="e.g., excessive force, search and seizure, noise ordinance..."
                  style="
                    width: 100%;
                    padding: 0.875rem 1rem;
                    border: 2px solid var(--border-color);
                    border-radius: 8px;
                    font-size: 1rem;
                  "
                />
              </div>

              <!-- Location Filters -->
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 1rem;
                "
              >
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: var(--text-primary);
                    "
                    >State</label
                  >
                  <select
                    id="trinityState"
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border: 2px solid var(--border-color);
                      border-radius: 8px;
                      font-size: 0.9375rem;
                    "
                  >
                    <option value="">All States</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NY">New York</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="CA">California</option>
                    <option value="FL">Florida</option>
                    <option value="TX">Texas</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NM">New Mexico</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                    <option value="DC">District of Columbia</option>
                  </select>
                </div>
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: var(--text-primary);
                    "
                    >Municipality</label
                  >
                  <input
                    type="text"
                    id="trinityMunicipality"
                    placeholder="e.g., Newark, Atlantic City..."
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border: 2px solid var(--border-color);
                      border-radius: 8px;
                      font-size: 0.9375rem;
                    "
                  />
                </div>
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 600;
                      color: var(--text-primary);
                    "
                    >County</label
                  >
                  <input
                    type="text"
                    id="trinityCounty"
                    placeholder="e.g., Essex, Atlantic..."
                    style="
                      width: 100%;
                      padding: 0.75rem;
                      border: 2px solid var(--border-color);
                      border-radius: 8px;
                      font-size: 0.9375rem;
                    "
                  />
                </div>
              </div>

              <!-- Level Filters -->
              <div>
                <label
                  style="
                    display: block;
                    margin-bottom: 0.5rem;
                    font-weight: 600;
                    color: var(--text-primary);
                  "
                  >Search Levels</label
                >
                <div style="display: flex; gap: 1rem; flex-wrap: wrap">
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      id="levelFederal"
                      checked
                      style="width: 18px; height: 18px"
                    />
                    <span
                      ><i class="fas fa-landmark" style="color: #1e40af"></i>
                      Federal</span
                    >
                  </label>
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      id="levelState"
                      checked
                      style="width: 18px; height: 18px"
                    />
                    <span
                      ><i class="fas fa-flag-usa" style="color: #059669"></i>
                      State</span
                    >
                  </label>
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      id="levelLocal"
                      checked
                      style="width: 18px; height: 18px"
                    />
                    <span
                      ><i class="fas fa-city" style="color: #d97706"></i>
                      Local/Municipal</span
                    >
                  </label>
                </div>
              </div>
            </div>

            <!-- Search Button -->
            <button
              class="btn btn-primary"
              onclick="trinitySearch()"
              style="width: 100%; padding: 1rem; font-size: 1rem"
            >
              <i class="fas fa-search"></i> Search All Jurisdictions
            </button>
          </div>

          <!-- Results Panel -->
          <div
            class="tool-panel"
            id="trinityResultsPanel"
            style="display: none"
          >
            <div class="tool-header">
              <h2 class="tool-title">
                <i
                  class="fas fa-gavel"
                  style="color: var(--brand-primary); margin-right: 0.5rem"
                ></i>
                Search Results
              </h2>
              <span
                id="trinityResultCount"
                style="
                  background: var(--brand-primary);
                  color: white;
                  padding: 0.25rem 0.75rem;
                  border-radius: 12px;
                  font-size: 0.875rem;
                "
                >0 results</span
              >
            </div>

            <!-- Hierarchy Notes -->
            <div id="trinityHierarchyNotes" style="margin-bottom: 1.5rem"></div>

            <!-- Results Tabs -->
            <div
              style="
                display: flex;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
                border-bottom: 2px solid var(--border-color);
                padding-bottom: 0.5rem;
              "
            >
              <button
                class="trinity-tab active"
                data-level="all"
                onclick="filterTrinityResults('all')"
              >
                <i class="fas fa-layer-group"></i> All
                <span class="tab-count" id="countAll">0</span>
              </button>
              <button
                class="trinity-tab"
                data-level="federal"
                onclick="filterTrinityResults('federal')"
              >
                <i class="fas fa-landmark"></i> Federal
                <span class="tab-count" id="countFederal">0</span>
              </button>
              <button
                class="trinity-tab"
                data-level="state"
                onclick="filterTrinityResults('state')"
              >
                <i class="fas fa-flag-usa"></i> State
                <span class="tab-count" id="countState">0</span>
              </button>
              <button
                class="trinity-tab"
                data-level="local"
                onclick="filterTrinityResults('local')"
              >
                <i class="fas fa-city"></i> Local
                <span class="tab-count" id="countLocal">0</span>
              </button>
            </div>

            <!-- Results List -->
            <div id="trinityResultsList"></div>
          </div>

          <!-- Municipalities Panel -->
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">
                <i
                  class="fas fa-city"
                  style="color: var(--brand-gold); margin-right: 0.5rem"
                ></i>
                Manage Municipalities
              </h2>
              <button
                class="btn btn-secondary"
                onclick="toggleAddMunicipality()"
              >
                <i class="fas fa-plus"></i> Add Municipality
              </button>
            </div>

            <!-- Add Municipality Form (hidden by default) -->
            <div
              id="addMunicipalityForm"
              style="
                display: none;
                background: var(--bg-light);
                padding: 1.5rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
              "
            >
              <h4 style="margin-bottom: 1rem">Add New Municipality</h4>
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 1rem;
                  margin-bottom: 1rem;
                "
              >
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 500;
                    "
                    >State *</label
                  >
                  <select
                    id="newMuniState"
                    style="
                      width: 100%;
                      padding: 0.625rem;
                      border: 1px solid var(--border-color);
                      border-radius: 6px;
                    "
                  >
                    <option value="NJ">New Jersey</option>
                    <option value="NY">New York</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="CA">California</option>
                    <option value="FL">Florida</option>
                    <option value="TX">Texas</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NM">New Mexico</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                    <option value="DC">District of Columbia</option>
                  </select>
                </div>
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 500;
                    "
                    >Municipality Name *</label
                  >
                  <input
                    type="text"
                    id="newMuniName"
                    placeholder="e.g., Atlantic City"
                    style="
                      width: 100%;
                      padding: 0.625rem;
                      border: 1px solid var(--border-color);
                      border-radius: 6px;
                    "
                  />
                </div>
                <div>
                  <label
                    style="
                      display: block;
                      margin-bottom: 0.5rem;
                      font-weight: 500;
                    "
                    >County</label
                  >
                  <input
                    type="text"
                    id="newMuniCounty"
                    placeholder="e.g., Atlantic"
                    style="
                      width: 100%;
                      padding: 0.625rem;
                      border: 1px solid var(--border-color);
                      border-radius: 6px;
                    "
                  />
                </div>
              </div>
              <div style="display: flex; gap: 0.75rem">
                <button class="btn btn-primary" onclick="addMunicipality()">
                  <i class="fas fa-search"></i> Discover & Add
                </button>
                <button
                  class="btn btn-secondary"
                  onclick="toggleAddMunicipality()"
                >
                  Cancel
                </button>
              </div>
            </div>

            <!-- Municipalities List -->
            <div id="municipalitiesList">
              <p
                style="
                  color: var(--text-secondary);
                  text-align: center;
                  padding: 2rem;
                "
              >
                <i class="fas fa-spinner fa-spin"></i> Loading municipalities...
              </p>
            </div>
          </div>
        </div>

        <!-- Other tool views would go here -->
        <div class="view-panel" id="view-transcript">
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">Transcript Search</h2>
            </div>
            <p>Search functionality coming soon...</p>
          </div>
        </div>

        <div class="view-panel" id="view-timeline">
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">Timeline Builder</h2>
            </div>
            <p>Timeline tool coming soon...</p>
          </div>
        </div>

        <div class="view-panel" id="view-entities">
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">Entity Extraction</h2>
            </div>
            <p>Entity extraction coming soon...</p>
          </div>
        </div>

        <div class="view-panel" id="view-violations">
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">Violation Scanner</h2>
            </div>
            <p>Violation scanner coming soon...</p>
          </div>
        </div>

        <div class="view-panel" id="view-settings">
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">Account Settings</h2>
            </div>
            <p>Settings panel coming soon...</p>
          </div>
        </div>

        <div class="view-panel" id="view-subscription">
          <div class="tool-panel">
            <div class="tool-header">
              <h2 class="tool-title">Subscription Management</h2>
            </div>
            <p>Subscription management coming soon...</p>
          </div>
        </div>
      </main>

      <!-- Chat Header -->
      <div class="chat-header">
        <div class="chat-title"><i class="fas fa-robot"></i> AI Assistant</div>
        <button class="btn btn-secondary" style="padding: 0.5rem">
          <i class="fas fa-compress"></i>
        </button>
      </div>

      <!-- Chat Panel -->
      <aside class="chat-panel">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message">
            <div class="message-avatar">
              <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
              Welcome to BarberX! I'm your AI legal assistant. How can I help
              you analyze evidence today?
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <!-- AI Model Selector -->
          <div
            style="
              padding: 0.75rem 1rem;
              border-top: 1px solid var(--border-color);
              background: var(--bg-light);
            "
          >
            <label
              style="
                display: block;
                font-size: 0.75rem;
                font-weight: 600;
                color: var(--text-secondary);
                margin-bottom: 0.375rem;
                text-transform: uppercase;
                letter-spacing: 0.025em;
              "
            >
              <i class="fas fa-brain" style="margin-right: 0.25rem"></i> AI
              Model
            </label>
            <select
              id="aiModel"
              style="
                width: 100%;
                padding: 0.5rem 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                font-size: 0.875rem;
                background: white;
              "
            >
              <optgroup label="OpenAI GPT-4o (Latest)">
                <option value="gpt-4o">GPT-4o - Flagship (128K)</option>
                <option value="gpt-4o-mini">GPT-4o Mini - Fast (128K)</option>
              </optgroup>
              <optgroup label="OpenAI GPT-4">
                <option value="gpt-4-turbo">GPT-4 Turbo (128K)</option>
                <option value="gpt-4" selected>GPT-4 (8K)</option>
                <option value="gpt-4-32k">GPT-4 32K (32K)</option>
              </optgroup>
              <optgroup label="OpenAI GPT-3.5">
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (16K)</option>
                <option value="gpt-3.5-turbo-16k">GPT-3.5 Turbo 16K</option>
              </optgroup>
              <optgroup label="OpenAI o-Series (Reasoning)">
                <option value="o1-preview">o1-preview (128K)</option>
                <option value="o1-mini">o1-mini (128K)</option>
                <option value="o3-mini">o3-mini (128K)</option>
              </optgroup>
              <optgroup label="Anthropic Claude 3.5">
                <option value="claude-3-5-sonnet">
                  Claude 3.5 Sonnet (200K)
                </option>
              </optgroup>
              <optgroup label="Anthropic Claude 3">
                <option value="claude-3-opus">Claude 3 Opus (200K)</option>
                <option value="claude-3-sonnet">Claude 3 Sonnet (200K)</option>
                <option value="claude-3-haiku">Claude 3 Haiku (200K)</option>
              </optgroup>
              <optgroup label="GitHub Copilot">
                <option value="copilot-gpt-4">Copilot GPT-4</option>
                <option value="copilot-gpt-3.5-turbo">Copilot GPT-3.5</option>
              </optgroup>
              <optgroup label="Google Gemini">
                <option value="gemini-pro">Gemini Pro (32K)</option>
                <option value="gemini-pro-vision">
                  Gemini Pro Vision (32K)
                </option>
              </optgroup>
              <optgroup label="Azure OpenAI">
                <option value="azure-gpt-4">Azure GPT-4</option>
                <option value="azure-gpt-4-turbo">
                  Azure GPT-4 Turbo (128K)
                </option>
              </optgroup>
            </select>
          </div>
          <div class="chat-input-wrapper">
            <textarea
              class="chat-input"
              id="chatInput"
              placeholder="Ask me anything..."
              rows="1"
            ></textarea>
            <button class="chat-send" id="chatSend">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </aside>
    </div>

    <script>
      // Navigation
      document.querySelectorAll(".nav-item[data-view]").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const view = item.dataset.view;

          // Update active nav
          document
            .querySelectorAll(".nav-item")
            .forEach((nav) => nav.classList.remove("active"));
          item.classList.add("active");

          // Update view
          document
            .querySelectorAll(".view-panel")
            .forEach((panel) => panel.classList.remove("active"));
          document.getElementById(`view-${view}`).classList.add("active");

          // Update breadcrumb
          document.getElementById("currentView").textContent =
            item.querySelector("span").textContent;
        });
      });

      // Load dashboard stats
      async function loadDashboardStats() {
        try {
          const response = await fetch("/api/dashboard-stats");
          const data = await response.json();

          document.getElementById("statsAnalyses").textContent =
            data.analyses_this_month || 0;
          document.getElementById("statsCompleted").textContent =
            data.completed_count || 0;
          document.getElementById("statsStorage").textContent =
            (data.storage_used_mb / 1024).toFixed(2) + " GB";

          // Update progress bars
          const analysesPercent =
            (data.analyses_this_month / data.tier_limits.monthly_analyses) *
            100;
          const storagePercent =
            (data.storage_used_mb / (data.tier_limits.storage_gb * 1024)) * 100;

          document.getElementById("progressAnalyses").style.width =
            Math.min(analysesPercent, 100) + "%";
          document.getElementById("progressStorage").style.width =
            Math.min(storagePercent, 100) + "%";
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      // Load analyses list
      async function loadAnalyses() {
        try {
          const response = await fetch("/api/analyses");
          const data = await response.json();

          const container = document.getElementById("analysesList");
          if (data.analyses && data.analyses.length > 0) {
            container.innerHTML = data.analyses
              .map(
                (analysis) => `
                        <div class="finding-item">
                            <div class="finding-severity ${analysis.status}">${analysis.status}</div>
                            <strong>${analysis.video_filename || "Analysis"}</strong>
                            <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                ${analysis.case_number || "No case number"} • 
                                ${new Date(analysis.created_at).toLocaleDateString()}
                            </p>
                        </div>
                    `,
              )
              .join("");
          } else {
            container.innerHTML =
              '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No analyses yet</p>';
          }
        } catch (error) {
          console.error("Error loading analyses:", error);
        }
      }

      // Chat functionality
      const chatInput = document.getElementById("chatInput");
      const chatSend = document.getElementById("chatSend");
      const chatMessages = document.getElementById("chatMessages");

      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        // Add user message
        const userMsg = document.createElement("div");
        userMsg.className = "chat-message user";
        userMsg.innerHTML = `
                <div class="message-avatar">${'{{ current_user.email[0].upper() if current_user.is_authenticated else "U" }}'}</div>
                <div class="message-content">${message}</div>
            `;
        chatMessages.appendChild(userMsg);
        chatInput.value = "";

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Send to API
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
          });
          const data = await response.json();

          // Add AI response
          const aiMsg = document.createElement("div");
          aiMsg.className = "chat-message";
          aiMsg.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-content">${data.response || "Sorry, I encountered an error."}</div>
                `;
          chatMessages.appendChild(aiMsg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
          console.error("Error sending message:", error);
        }
      }

      chatSend.addEventListener("click", sendMessage);
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // File upload
      document
        .getElementById("fileInput")
        .addEventListener("change", async (e) => {
          const files = e.target.files;
          if (files.length === 0) return;

          const formData = new FormData();
          for (let file of files) {
            formData.append("files", file);
          }

          try {
            // Upload files
            const response = await fetch("/api/upload", {
              method: "POST",
              body: formData,
            });
            const data = await response.json();

            alert("Files uploaded successfully!");
            loadAnalyses();
          } catch (error) {
            console.error("Upload error:", error);
            alert("Upload failed");
          }
        });

      // ===== LEGAL TRINITY FUNCTIONS =====
      let trinityResults = [];
      let currentTrinityFilter = "all";

      // Search all jurisdictions
      async function trinitySearch() {
        const query = document.getElementById("trinityQuery").value.trim();
        if (!query) {
          alert("Please enter a search query");
          return;
        }

        const state = document.getElementById("trinityState").value;
        const municipality = document
          .getElementById("trinityMunicipality")
          .value.trim();
        const county = document.getElementById("trinityCounty").value.trim();

        const levels = [];
        if (document.getElementById("levelFederal").checked)
          levels.push("federal");
        if (document.getElementById("levelState").checked) levels.push("state");
        if (document.getElementById("levelLocal").checked) levels.push("local");

        if (levels.length === 0) {
          alert("Please select at least one jurisdiction level");
          return;
        }

        // Show loading state
        const btn = event.target.closest("button");
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
        btn.disabled = true;

        try {
          const response = await fetch("/api/v1/trinity/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query,
              state_code: state || null,
              municipality: municipality || null,
              county: county || null,
              levels,
            }),
          });

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          trinityResults = data.results || [];
          displayTrinityResults();

          // Show results panel
          document.getElementById("trinityResultsPanel").style.display =
            "block";

          // Scroll to results
          document
            .getElementById("trinityResultsPanel")
            .scrollIntoView({ behavior: "smooth" });
        } catch (error) {
          console.error("Trinity search error:", error);
          alert("Search failed: " + error.message);
        } finally {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      }

      // Display trinity search results
      function displayTrinityResults() {
        const container = document.getElementById("trinityResultsList");
        const hierarchyNotes = document.getElementById("trinityHierarchyNotes");

        // Count by level
        const countFederal = trinityResults.filter(
          (r) => r.level === "FEDERAL",
        ).length;
        const countState = trinityResults.filter(
          (r) => r.level === "STATE",
        ).length;
        const countLocal = trinityResults.filter(
          (r) => r.level === "LOCAL",
        ).length;
        const countAll = trinityResults.length;

        // Update tab counts
        document.getElementById("countAll").textContent = countAll;
        document.getElementById("countFederal").textContent = countFederal;
        document.getElementById("countState").textContent = countState;
        document.getElementById("countLocal").textContent = countLocal;
        document.getElementById("trinityResultCount").textContent =
          `${countAll} results`;

        // Show hierarchy note if we have results from multiple levels
        if ((countFederal > 0) + (countState > 0) + (countLocal > 0) > 1) {
          hierarchyNotes.innerHTML = `
            <div class="trinity-hierarchy-note">
              <i class="fas fa-info-circle"></i>
              <div>
                <strong>Legal Hierarchy Note:</strong> Federal law takes precedence over state law, and state law takes precedence over local ordinances.
                When laws conflict, higher authority prevails. Consider this hierarchy when building your legal argument.
              </div>
            </div>
          `;
        } else {
          hierarchyNotes.innerHTML = "";
        }

        // Filter results based on current filter
        const filteredResults =
          currentTrinityFilter === "all"
            ? trinityResults
            : trinityResults.filter(
                (r) => r.level.toLowerCase() === currentTrinityFilter,
              );

        if (filteredResults.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
              <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
              <p>No results found. Try adjusting your search terms or filters.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = filteredResults
          .map((result) => {
            const levelClass = result.level.toLowerCase();
            const levelIcon =
              levelClass === "federal"
                ? "landmark"
                : levelClass === "state"
                  ? "flag-usa"
                  : "city";

            return `
            <div class="trinity-result-card ${levelClass}">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                <span class="trinity-level-badge ${levelClass}">
                  <i class="fas fa-${levelIcon}"></i>
                  ${result.level}
                </span>
                ${result.relevance_score ? `<span style="color: var(--text-secondary); font-size: 0.8125rem;"><i class="fas fa-star"></i> ${(result.relevance_score * 100).toFixed(0)}% match</span>` : ""}
              </div>
              <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">${escapeHtml(result.title || result.citation || "Untitled")}</h4>
              <p style="color: var(--brand-primary); font-weight: 500; font-size: 0.875rem; margin-bottom: 0.75rem;">
                ${escapeHtml(result.citation || "")}
              </p>
              ${result.summary ? `<p style="color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.6; margin-bottom: 1rem;">${escapeHtml(result.summary)}</p>` : ""}
              <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                ${result.url ? `<a href="${result.url}" target="_blank" class="btn btn-secondary" style="font-size: 0.8125rem; padding: 0.5rem 0.875rem;"><i class="fas fa-external-link-alt"></i> View Source</a>` : ""}
                <button class="btn btn-secondary" style="font-size: 0.8125rem; padding: 0.5rem 0.875rem;" onclick="copyToChatContext('${escapeHtml(result.citation || result.title)}')">
                  <i class="fas fa-comment"></i> Add to Chat
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // Filter trinity results by level
      function filterTrinityResults(level) {
        currentTrinityFilter = level;

        // Update active tab
        document.querySelectorAll(".trinity-tab").forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.level === level);
        });

        displayTrinityResults();
      }

      // Toggle add municipality form
      function toggleAddMunicipality() {
        const form = document.getElementById("addMunicipalityForm");
        form.style.display = form.style.display === "none" ? "block" : "none";
      }

      // Add municipality
      async function addMunicipality() {
        const state = document.getElementById("newMuniState").value;
        const name = document.getElementById("newMuniName").value.trim();
        const county = document.getElementById("newMuniCounty").value.trim();

        if (!name) {
          alert("Please enter a municipality name");
          return;
        }

        const btn = event.target.closest("button");
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Discovering...';
        btn.disabled = true;

        try {
          const response = await fetch("/api/v1/trinity/municipality", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              state_code: state,
              name: name,
              county: county || null,
            }),
          });

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          alert(`Successfully added ${name}, ${state}!`);
          toggleAddMunicipality();
          loadMunicipalities();

          // Clear form
          document.getElementById("newMuniName").value = "";
          document.getElementById("newMuniCounty").value = "";
        } catch (error) {
          console.error("Add municipality error:", error);
          alert("Failed to add municipality: " + error.message);
        } finally {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      }

      // Load municipalities
      async function loadMunicipalities() {
        const container = document.getElementById("municipalitiesList");

        try {
          const response = await fetch("/api/v1/trinity/municipalities");
          const data = await response.json();

          if (!data.municipalities || data.municipalities.length === 0) {
            container.innerHTML = `
              <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <i class="fas fa-city" style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                <p>No municipalities added yet.</p>
                <p style="font-size: 0.875rem;">Add a municipality to search local codes.</p>
              </div>
            `;
            return;
          }

          container.innerHTML = data.municipalities
            .map(
              (muni) => `
            <div class="municipality-card">
              <div class="muni-info">
                <div class="muni-icon"><i class="fas fa-city"></i></div>
                <div>
                  <strong>${escapeHtml(muni.name)}, ${muni.state_code}</strong>
                  <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                    ${muni.county ? escapeHtml(muni.county) + " County • " : ""}
                    ${muni.provider || "Unknown provider"}
                    ${muni.last_synced ? ` • Synced ${new Date(muni.last_synced).toLocaleDateString()}` : ""}
                  </div>
                </div>
              </div>
              <div class="muni-actions">
                <button class="btn btn-secondary" onclick="syncMunicipality('${muni.id}')" title="Sync codes">
                  <i class="fas fa-sync"></i>
                </button>
                <button class="btn btn-secondary" onclick="searchMunicipalityCodes('${escapeHtml(muni.name)}', '${muni.state_code}')" title="Search codes">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          `,
            )
            .join("");
        } catch (error) {
          console.error("Load municipalities error:", error);
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--error);">
              <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
              <p>Failed to load municipalities</p>
            </div>
          `;
        }
      }

      // Sync municipality codes
      async function syncMunicipality(id) {
        const btn = event.target.closest("button");
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
          const response = await fetch(`/api/v1/trinity/sync/${id}`, {
            method: "POST",
          });
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          alert(`Synced ${data.sections_synced || 0} code sections`);
          loadMunicipalities();
        } catch (error) {
          console.error("Sync error:", error);
          alert("Sync failed: " + error.message);
        } finally {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      }

      // Search specific municipality codes
      function searchMunicipalityCodes(name, state) {
        document.getElementById("trinityMunicipality").value = name;
        document.getElementById("trinityState").value = state;
        document.getElementById("levelFederal").checked = false;
        document.getElementById("levelState").checked = false;
        document.getElementById("levelLocal").checked = true;
        document.getElementById("trinityQuery").focus();
      }

      // Copy citation to chat context
      function copyToChatContext(citation) {
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.value += `\n[Legal Reference: ${citation}]`;
          chatInput.focus();
        }
      }

      // Helper: Escape HTML
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Initialize Trinity on page load
      function initTrinity() {
        loadMunicipalities();
      }

      // Toggle floating chat for responsive
      function toggleFloatingChat() {
        const floatingChat = document.getElementById('floatingChat');
        if (floatingChat) {
          floatingChat.classList.toggle('open');
        }
      }

      // Toggle sidebar for mobile
      function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
          sidebar.classList.toggle('open');
        }
      }

      // Initialize
      loadDashboardStats();
      loadAnalyses();
      initTrinity();
    </script>

    <!-- Floating Chat Button for responsive -->
    <button class="chat-toggle-btn" onclick="toggleFloatingChat()" aria-label="Toggle AI Chat">
      <i class="fas fa-comment-dots"></i>
    </button>

    <!-- Floating Chat Panel -->
    <div id="floatingChat" class="chat-panel chat-floating">
      <div class="chat-header" style="display:flex; padding: 1rem; border-bottom: 1px solid var(--border-color);">
        <span class="chat-title">AI Legal Assistant</span>
        <button onclick="toggleFloatingChat()" style="margin-left:auto; background:none; border:none; cursor:pointer; color: var(--text-secondary);">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="chat-messages" id="floatingChatMessages">
        <div class="chat-message">
          <div class="message-avatar"><i class="fas fa-robot"></i></div>
          <div class="message-content">
            I'm your AI legal assistant. How can I help with your case analysis?
          </div>
        </div>
      </div>
      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="floatingChatInput" placeholder="Ask a legal question..." rows="1"></textarea>
          <button class="chat-send" onclick="sendChatMessage('floatingChatInput', 'floatingChatMessages')">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
