<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWC Analysis Dashboard | BarberX Legal Tech</title>
    <link rel="stylesheet" href="/assets/css/legal-tech-platform.css">
    <style>
        :root {
            --brand-color: #c41e3a;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --surface-color: #ffffff;
            --border-color: #e0e0e8;
            --accent-blue: #1e40af;
            --bg-color: #f8f9fa;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
        }
        
        .nav-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: white;
        }
        
        .nav-brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #c41e3a, #e63946);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
        }
        
        .nav-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .nav-link:hover, .nav-link.active { color: white; }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h1 {
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .breadcrumb {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .breadcrumb a {
            color: var(--accent-blue);
            text-decoration: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 4px solid var(--accent-blue);
        }
        
        .stat-card.success { border-left-color: #10b981; }
        .stat-card.warning { border-left-color: #f59e0b; }
        .stat-card.danger { border-left-color: #ef4444; }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .stat-card.success .stat-number { color: #10b981; }
        .stat-card.warning .stat-number { color: #f59e0b; }
        .stat-card.danger .stat-number { color: #ef4444; }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--brand-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #a01830;
        }
        
        .filter-dropdown {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
            font-size: 0.875rem;
        }
        
        .analyses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .analysis-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        
        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .card-title h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .card-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-badge.uploaded { background: #e0f2fe; color: #0369a1; }
        .status-badge.analyzing { background: #dbeafe; color: #1e40af; animation: pulse 2s infinite; }
        .status-badge.completed { background: #d1fae5; color: #065f46; }
        .status-badge.failed { background: #fee2e2; color: #991b1b; }
        
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), #3b82f6);
            transition: width 0.3s;
        }
        
        .card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 12px;
            grid-column: 1 / -1;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--brand-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            margin-bottom: 2rem;
        }
        
        .upload-zone:hover {
            border-color: var(--brand-color);
            background: #fef2f2;
        }
        
        .upload-zone input { display: none; }
    </style>
</head>
<body>
    <header class="nav-header">
        <a href="/dashboard" class="nav-brand">
            <div class="nav-brand-icon">BX</div>
            <span style="font-size:1.25rem;font-weight:700">BarberX Legal</span>
        </a>
        <nav class="nav-links">
            <a href="/dashboard" class="nav-link">Dashboard</a>
            <a href="/bwc-dashboard" class="nav-link active">BWC Analysis</a>
            <a href="/chat" class="nav-link">AI Chat</a>
            <a href="/account" class="nav-link">Account</a>
            <a href="/auth/logout" class="nav-link">Logout</a>
        </nav>
    </header>
    
    <div class="dashboard-container">
        <div class="page-header">
            <div class="breadcrumb">
                <a href="/">Home</a> / <a href="/dashboard">Dashboard</a> / BWC Analysis
            </div>
            <h1>ðŸŽ¥ BWC Analysis Dashboard</h1>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total Analyses</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-number" id="analyzingCount">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card success">
                <div class="stat-number" id="completedCount">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-number" id="discrepancyCount">0</div>
                <div class="stat-label">Discrepancies</div>
            </div>
        </div>
        
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".mp4,.mov,.avi,.mkv,.webm,.flv,.wmv,.m4v,video/*" multiple onchange="handleUpload(this)" style="display:none">
            <div style="font-size:3rem;margin-bottom:1rem">ðŸ“¹</div>
            <h3 style="margin-bottom:0.5rem">Upload BWC Footage</h3>
            <p style="color:var(--text-secondary)">Click to select or drag and drop video files (multiple allowed)</p>
            <p style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.5rem">Supported: MP4, MOV, AVI, MKV, WebM, FLV, WMV, M4V</p>
        </div>
        
        <!-- Upload Progress Container -->
        <div id="uploadProgress" style="display:none;margin-top:1rem;padding:1rem;background:var(--surface-color);border-radius:8px">
            <h4 style="margin-bottom:0.75rem">Uploading Videos...</h4>
            <div id="uploadProgressList"></div>
        </div>
        
        <div class="action-bar">
            <div>
                <select class="filter-dropdown" id="statusFilter" onchange="filterAnalyses()">
                    <option value="">All Status</option>
                    <option value="uploaded">Uploaded</option>
                    <option value="analyzing">Analyzing</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
        </div>
        
        <div class="analyses-grid" id="analysesGrid">
            <div class="empty-state">
                <div class="spinner"></div>
                <p>Loading analyses...</p>
            </div>
        </div>
    </div>
    
    <script>
        let analyses = [];
        let filteredAnalyses = [];
        
        async function loadAnalyses() {
            try {
                const response = await fetch('/api/analyses?per_page=100');
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();
                analyses = data.analyses || [];
                filteredAnalyses = analyses;
                renderStats();
                renderAnalyses();
            } catch (error) {
                console.error('Error:', error);
                showEmptyState();
            }
        }
        
        function renderStats() {
            const total = analyses.length;
            const analyzing = analyses.filter(a => a.status === 'analyzing').length;
            const completed = analyses.filter(a => a.status === 'completed').length;
            const discrepancies = analyses.reduce((sum, a) => sum + (a.total_discrepancies || 0), 0);
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('analyzingCount').textContent = analyzing;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('discrepancyCount').textContent = discrepancies;
        }
        
        function filterAnalyses() {
            const status = document.getElementById('statusFilter').value;
            filteredAnalyses = status ? analyses.filter(a => a.status === status) : analyses;
            renderAnalyses();
        }
        
        function renderAnalyses() {
            const grid = document.getElementById('analysesGrid');
            
            if (filteredAnalyses.length === 0) {
                showEmptyState();
                return;
            }
            
            grid.innerHTML = filteredAnalyses.map(a => `
                <div class="analysis-card">
                    <div class="card-header">
                        <div class="card-title">
                            <h3>${escapeHtml(a.filename || 'Untitled')}</h3>
                            <div class="card-meta">${formatDate(a.created_at)}</div>
                        </div>
                        <span class="status-badge ${a.status}">${a.status}</span>
                    </div>
                    ${a.status === 'analyzing' ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${a.progress || 0}%"></div>
                        </div>
                        <div style="font-size:0.8rem;color:var(--text-secondary)">${a.current_step || 'Processing...'}</div>
                    ` : ''}
                    ${a.status === 'completed' ? `
                        <div style="margin:1rem 0;font-size:0.9rem">
                            <strong>${a.total_discrepancies || 0}</strong> discrepancies found
                        </div>
                    ` : ''}
                    <div class="card-actions">
                        ${a.status === 'completed' ? `
                            <button class="btn btn-primary btn-sm" onclick="viewDetails('${a.id}')">View Details</button>
                            <button class="btn btn-secondary btn-sm" onclick="exportReport('${a.id}')">Export</button>
                        ` : a.status === 'uploaded' ? `
                            <button class="btn btn-primary btn-sm" onclick="startAnalysis('${a.id}')">Start Analysis</button>
                        ` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="deleteAnalysis('${a.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function showEmptyState() {
            document.getElementById('analysesGrid').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“¹</div>
                    <h3>No analyses yet</h3>
                    <p style="color:var(--text-secondary);margin-bottom:1rem">Upload BWC footage to get started</p>
                </div>
            `;
        }
        
        // Handle multiple file uploads
        async function handleUpload(input) {
            if (!input.files.length) return;
            
            const files = Array.from(input.files);
            const progressContainer = document.getElementById('uploadProgress');
            const progressList = document.getElementById('uploadProgressList');
            
            // Validate files
            const allowedExtensions = ['.mp4', '.mov', '.avi', '.mkv', '.webm', '.flv', '.wmv', '.m4v'];
            const validFiles = files.filter(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                if (!allowedExtensions.includes(ext)) {
                    alert(`Invalid file type: ${file.name}. Allowed: ${allowedExtensions.join(', ')}`);
                    return false;
                }
                return true;
            });
            
            if (validFiles.length === 0) {
                input.value = '';
                return;
            }
            
            // Show progress UI
            progressContainer.style.display = 'block';
            progressList.innerHTML = validFiles.map((f, i) => `
                <div id="upload-item-${i}" style="display:flex;align-items:center;gap:1rem;padding:0.5rem 0;border-bottom:1px solid var(--border-color)">
                    <span style="flex:1">${escapeHtml(f.name)}</span>
                    <span id="upload-status-${i}" style="font-size:0.85rem;color:var(--text-secondary)">Waiting...</span>
                </div>
            `).join('');
            
            // Upload files sequentially
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < validFiles.length; i++) {
                const file = validFiles[i];
                const statusEl = document.getElementById(`upload-status-${i}`);
                
                statusEl.textContent = 'Uploading...';
                statusEl.style.color = 'var(--accent-blue)';
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        statusEl.textContent = 'âœ“ Success';
                        statusEl.style.color = '#10b981';
                        successCount++;
                    } else {
                        const data = await response.json().catch(() => ({}));
                        statusEl.textContent = 'âœ— ' + (data.error || 'Failed');
                        statusEl.style.color = '#ef4444';
                        errorCount++;
                    }
                } catch (error) {
                    statusEl.textContent = 'âœ— ' + error.message;
                    statusEl.style.color = '#ef4444';
                    errorCount++;
                }
            }
            
            // Show summary
            if (successCount > 0) {
                loadAnalyses();
            }
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                if (successCount > 0 || errorCount > 0) {
                    alert(`Upload complete: ${successCount} successful, ${errorCount} failed`);
                }
            }, 2000);
            
            input.value = '';
        }
        
        // Add drag and drop support
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--accent-blue)';
            uploadZone.style.background = 'var(--primary-navy-10, rgba(15, 23, 42, 0.1))';
        });
        
        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = '';
            uploadZone.style.background = '';
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = '';
            uploadZone.style.background = '';
            
            const fileInput = document.getElementById('fileInput');
            const dt = new DataTransfer();
            
            Array.from(e.dataTransfer.files).forEach(file => {
                dt.items.add(file);
            });
            
            fileInput.files = dt.files;
            handleUpload(fileInput);
        });
        
        async function startAnalysis(id) {
            try {
                const response = await fetch(`/api/analysis/${id}/start`, { method: 'POST' });
                if (response.ok) loadAnalyses();
            } catch (error) {
                alert('Error starting analysis');
            }
        }
        
        function viewDetails(id) {
            window.location.href = `/analysis/${id}`;
        }
        
        async function exportReport(id) {
            window.location.href = `/api/analysis/${id}/report/pdf`;
        }
        
        async function deleteAnalysis(id) {
            if (!confirm('Delete this analysis?')) return;
            try {
                await fetch(`/api/analysis/${id}`, { method: 'DELETE' });
                loadAnalyses();
            } catch (error) {
                alert('Delete failed');
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 86400000);
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Yesterday';
            if (diff < 7) return diff + ' days ago';
            return date.toLocaleDateString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        // Initialize
        loadAnalyses();
        
        // Refresh every 5 seconds for real-time updates
        setInterval(() => {
            if (analyses.some(a => a.status === 'analyzing')) {
                loadAnalyses();
            }
        }, 5000);
    </script>
</body>
</html>
