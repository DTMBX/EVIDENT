{% extends "_layouts/default.html" %}

{% block title %}Analytics Dashboard - BarberX{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="glass-card">
        <div class="glass-card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="mb-2 gradient-text">Analytics Dashboard</h1>
              <p class="text-muted mb-0">Performance insights and key metrics</p>
            </div>
            <div class="d-flex gap-2">
              <select id="dateRange" class="glass-input" style="width: auto;">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
                <option value="365">Last year</option>
              </select>
              <button class="btn btn-glass-primary" onclick="exportReport()">
                <i class="fas fa-download"></i> Export
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <div class="text-muted text-uppercase" style="font-size: 11px; font-weight: 700; letter-spacing: 0.5px;">Total Cases</div>
            </div>
            <div class="bg-gradient-primary" style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
              <i class="fas fa-folder"></i>
            </div>
          </div>
          <div class="d-flex align-items-baseline gap-2">
            <h2 class="mb-0" id="totalCases">--</h2>
            <span class="text-success" style="font-size: 14px; font-weight: 600;">
              <i class="fas fa-arrow-up"></i> <span id="totalCasesChange">--</span>%
            </span>
          </div>
          <div class="mt-2" style="font-size: 12px; color: #6b7280;">vs. last period</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <div class="text-muted text-uppercase" style="font-size: 11px; font-weight: 700; letter-spacing: 0.5px;">Avg. Processing Time</div>
            </div>
            <div class="bg-gradient-success" style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="d-flex align-items-baseline gap-2">
            <h2 class="mb-0" id="avgTime">--</h2>
            <span class="text-success" style="font-size: 14px; font-weight: 600;">
              <i class="fas fa-arrow-down"></i> <span id="avgTimeChange">--</span>%
            </span>
          </div>
          <div class="mt-2" style="font-size: 12px; color: #6b7280;">faster than average</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <div class="text-muted text-uppercase" style="font-size: 11px; font-weight: 700; letter-spacing: 0.5px;">SLA Compliance</div>
            </div>
            <div class="bg-gradient-warning" style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
          <div class="d-flex align-items-baseline gap-2">
            <h2 class="mb-0" id="slaCompliance">--</h2>
            <span class="text-success" style="font-size: 14px; font-weight: 600;">
              <i class="fas fa-arrow-up"></i> <span id="slaChange">--</span>%
            </span>
          </div>
          <div class="mt-2" style="font-size: 12px; color: #6b7280;">on-time completion</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="glass-card scale-on-hover">
        <div class="glass-card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <div class="text-muted text-uppercase" style="font-size: 11px; font-weight: 700; letter-spacing: 0.5px;">Quality Score</div>
            </div>
            <div class="bg-gradient-danger" style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
              <i class="fas fa-star"></i>
            </div>
          </div>
          <div class="d-flex align-items-baseline gap-2">
            <h2 class="mb-0" id="qualityScore">--</h2>
            <span class="text-muted" style="font-size: 14px; font-weight: 600;">
              / 5.0
            </span>
          </div>
          <div class="mt-2" style="font-size: 12px; color: #6b7280;">average rating</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <!-- Case Volume Chart -->
    <div class="col-md-8">
      <div class="glass-card">
        <div class="glass-card-header">
          <h5 class="mb-0">Case Volume Trend</h5>
        </div>
        <div class="glass-card-body">
          <canvas id="volumeChart" height="80"></canvas>
        </div>
      </div>
    </div>

    <!-- Priority Distribution -->
    <div class="col-md-4">
      <div class="glass-card">
        <div class="glass-card-header">
          <h5 class="mb-0">Priority Distribution</h5>
        </div>
        <div class="glass-card-body">
          <canvas id="priorityChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Charts -->
  <div class="row mb-4">
    <!-- Team Performance -->
    <div class="col-md-6">
      <div class="glass-card">
        <div class="glass-card-header">
          <h5 class="mb-0">Team Performance</h5>
        </div>
        <div class="glass-card-body">
          <canvas id="teamChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <!-- Processing Stages -->
    <div class="col-md-6">
      <div class="glass-card">
        <div class="glass-card-header">
          <h5 class="mb-0">Processing Stages</h5>
        </div>
        <div class="glass-card-body">
          <canvas id="stageChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Cases Table -->
  <div class="row">
    <div class="col-12">
      <div class="glass-card">
        <div class="glass-card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Cases</h5>
            <a href="/evidence/dashboard" class="btn btn-glass btn-sm">View All</a>
          </div>
        </div>
        <div class="glass-card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead style="background: rgba(0,0,0,0.02);">
                <tr>
                  <th>Case ID</th>
                  <th>Type</th>
                  <th>Priority</th>
                  <th>Stage</th>
                  <th>Analyst</th>
                  <th>Duration</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="recentCasesTable">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Analytics Dashboard
(function() {
  const dateRange = document.getElementById('dateRange');
  
  // Mock data (replace with API calls)
  const mockData = {
    kpis: {
      totalCases: 487,
      totalCasesChange: 15,
      avgTime: '8.5d',
      avgTimeChange: 12,
      slaCompliance: '94%',
      slaChange: 3,
      qualityScore: '4.8'
    },
    volumeData: {
      labels: ['Jan 1', 'Jan 8', 'Jan 15', 'Jan 22', 'Jan 29', 'Feb 5', 'Feb 12'],
      datasets: [{
        label: 'Cases Submitted',
        data: [45, 52, 48, 58, 61, 55, 68],
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.4
      }, {
        label: 'Cases Completed',
        data: [42, 48, 51, 55, 57, 59, 65],
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    priorityData: {
      labels: ['Critical', 'High', 'Normal', 'Low'],
      datasets: [{
        data: [12, 28, 45, 15],
        backgroundColor: [
          '#ef4444',
          '#f59e0b',
          '#3b82f6',
          '#6b7280'
        ]
      }]
    },
    teamData: {
      labels: ['John D.', 'Sarah M.', 'Mike R.', 'Lisa K.', 'Tom B.'],
      datasets: [{
        label: 'Cases Completed',
        data: [22, 19, 15, 12, 10],
        backgroundColor: '#667eea'
      }]
    },
    stageData: {
      labels: ['Intake', 'Verification', 'Analysis', 'Enhancement', 'Review', 'Approved'],
      datasets: [{
        label: 'Current Cases',
        data: [8, 12, 25, 18, 15, 22],
        backgroundColor: '#764ba2'
      }]
    }
  };
  
  // Update KPIs
  function updateKPIs() {
    document.getElementById('totalCases').textContent = mockData.kpis.totalCases;
    document.getElementById('totalCasesChange').textContent = mockData.kpis.totalCasesChange;
    document.getElementById('avgTime').textContent = mockData.kpis.avgTime;
    document.getElementById('avgTimeChange').textContent = mockData.kpis.avgTimeChange;
    document.getElementById('slaCompliance').textContent = mockData.kpis.slaCompliance;
    document.getElementById('slaChange').textContent = mockData.kpis.slaChange;
    document.getElementById('qualityScore').textContent = mockData.kpis.qualityScore;
  }
  
  // Volume Chart
  const volumeChart = new Chart(document.getElementById('volumeChart'), {
    type: 'line',
    data: mockData.volumeData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'top',
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
  
  // Priority Chart
  const priorityChart = new Chart(document.getElementById('priorityChart'), {
    type: 'doughnut',
    data: mockData.priorityData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
  
  // Team Chart
  const teamChart = new Chart(document.getElementById('teamChart'), {
    type: 'bar',
    data: mockData.teamData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
  
  // Stage Chart
  const stageChart = new Chart(document.getElementById('stageChart'), {
    type: 'bar',
    data: mockData.stageData,
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          beginAtZero: true
        }
      }
    }
  });
  
  // Recent cases table
  const recentCases = [
    { id: 'CR-2026-001234', type: 'BWC', priority: 'Critical', stage: 'Analysis', analyst: 'John D.', duration: '2.5h', status: 'In Progress' },
    { id: 'CR-2026-001233', type: 'Interview', priority: 'High', stage: 'Review', analyst: 'Sarah M.', duration: '4.2h', status: 'Pending' },
    { id: 'CR-2026-001232', type: 'Traffic Stop', priority: 'Normal', stage: 'Enhancement', analyst: 'Mike R.', duration: '6.8h', status: 'In Progress' },
    { id: 'CR-2026-001231', type: 'Incident', priority: 'High', stage: 'Verification', analyst: 'Lisa K.', duration: '1.5h', status: 'In Progress' },
    { id: 'CR-2026-001230', type: 'BWC', priority: 'Critical', stage: 'Approved', analyst: 'Tom B.', duration: '8.2h', status: 'Complete' }
  ];
  
  function renderRecentCases() {
    const table = document.getElementById('recentCasesTable');
    table.innerHTML = recentCases.map(c => `
      <tr>
        <td><a href="/analysis/${c.id}" class="text-decoration-none fw-semibold">${c.id}</a></td>
        <td>${c.type}</td>
        <td>
          <span class="glass-badge ${c.priority === 'Critical' ? 'text-danger' : c.priority === 'High' ? 'text-warning' : 'text-primary'}">
            ${c.priority}
          </span>
        </td>
        <td>${c.stage}</td>
        <td>${c.analyst}</td>
        <td>${c.duration}</td>
        <td>
          <span class="status-dot ${c.status === 'Complete' ? 'online' : 'busy'}"></span>
          ${c.status}
        </td>
      </tr>
    `).join('');
  }
  
  // Date range change
  dateRange.addEventListener('change', () => {
    console.log('Loading data for:', dateRange.value, 'days');
    // TODO: Fetch new data and update charts
  });
  
  // Initialize
  updateKPIs();
  renderRecentCases();
  
  window.exportReport = function() {
    alert('Export functionality coming soon!');
  };
})();
</script>
{% endblock %}
