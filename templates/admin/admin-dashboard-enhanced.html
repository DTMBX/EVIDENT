{% extends "base.html" %} {% block title %}Admin Dashboard - BarberX{% endblock
%} {% block content %} {% include 'components/premium-styles.html' %}

<style>
  :root {
    --brand-color: {{ site_settings['ui.brand_color'] | default('#c41e3a') }};
    --accent-color: {{ site_settings['ui.accent_color'] | default('#1e40af') }};
  }

  .site-banner {
    background: var(--brand-color);
    color: #fff;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    font-weight: 600;
    text-align: center;
  }
</style>

<div class="admin-container">
  {% if site_settings['site.banner_enabled'] and
  site_settings['site.banner_message'] %}
  <div class="site-banner">{{ site_settings['site.banner_message'] }}</div>
  {% endif %}
  <!-- Admin Header -->
  <div class="admin-header glass-card mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="mb-1">üõ°Ô∏è Admin Dashboard</h1>
        <p class="text-muted mb-0">System Administration & User Management</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-glass" onclick="refreshData()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-glass" onclick="showSystemSettings()">
          <i class="fas fa-cog"></i> Settings
        </button>
        <a href="/auth/dashboard" class="btn btn-glass">
          <i class="fas fa-arrow-left"></i> User Dashboard
        </a>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="glass-card stats-card">
        <div
          class="stats-icon"
          style="background: rgba(59, 130, 246, 0.1); color: #3b82f6"
        >
          <i class="fas fa-users"></i>
        </div>
        <div class="stats-content">
          <h3 id="totalUsers">-</h3>
          <p>Total Users</p>
          <small class="text-success"
            ><i class="fas fa-arrow-up"></i> +12 this week</small
          >
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="glass-card stats-card">
        <div
          class="stats-icon"
          style="background: rgba(16, 185, 129, 0.1); color: #10b981"
        >
          <i class="fas fa-user-check"></i>
        </div>
        <div class="stats-content">
          <h3 id="activeUsers">-</h3>
          <p>Active Users</p>
          <small class="text-info"
            ><i class="fas fa-clock"></i> Last 30 days</small
          >
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="glass-card stats-card">
        <div
          class="stats-icon"
          style="background: rgba(245, 158, 11, 0.1); color: #f59e0b"
        >
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="stats-content">
          <h3 id="totalEvidence">-</h3>
          <p>Evidence Processed</p>
          <small class="text-warning"
            ><i class="fas fa-chart-line"></i> +245 today</small
          >
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="glass-card stats-card">
        <div
          class="stats-icon"
          style="background: rgba(239, 68, 68, 0.1); color: #ef4444"
        >
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stats-content">
          <h3 id="totalRevenue">-</h3>
          <p>Monthly Revenue</p>
          <small class="text-success"
            ><i class="fas fa-arrow-up"></i> +8.2% MoM</small
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Tabs -->
  <div class="glass-card">
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="showTab('users')">
        <i class="fas fa-users"></i> Users
      </button>
      <button class="admin-tab" onclick="showTab('analytics')">
        <i class="fas fa-chart-bar"></i> Analytics
      </button>
      <button class="admin-tab" onclick="showTab('evidence')">
        <i class="fas fa-folder-open"></i> Evidence
      </button>
      <button class="admin-tab" onclick="showTab('agents')">
        <i class="fas fa-robot"></i> AI Agents
      </button>
      <button class="admin-tab" onclick="showTab('system')">
        <i class="fas fa-server"></i> System
      </button>
      <button class="admin-tab" onclick="showTab('operations')">
        <i class="fas fa-shield-alt"></i> Operations
      </button>
      <button class="admin-tab" onclick="showTab('logs')">
        <i class="fas fa-file-alt"></i> Audit Logs
      </button>
    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="tab-content active">
      <div class="tab-header">
        <h3>User Management</h3>
        <div class="d-flex gap-2">
          <input
            type="text"
            id="userSearch"
            class="glass-input"
            placeholder="Search users..."
            onkeyup="searchUsers()"
          />
          <select id="tierFilter" class="glass-input" onchange="filterUsers()">
            <option value="">All Tiers</option>
            <option value="FREE">Free</option>
            <option value="PROFESSIONAL">Professional</option>
            <option value="PREMIUM">Premium</option>
            <option value="ENTERPRISE">Enterprise</option>
            <option value="ADMIN">Admin</option>
          </select>
          <button class="btn btn-glass-primary" onclick="showCreateUser()">
            <i class="fas fa-user-plus"></i> Add User
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Tier</th>
              <th>Status</th>
              <th>Created</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Populated by JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="pagination mt-3">
        <button class="btn btn-glass btn-sm" onclick="previousPage()">
          Previous
        </button>
        <span class="px-3"
          >Page <span id="currentPage">1</span> of
          <span id="totalPages">1</span></span
        >
        <button class="btn btn-glass btn-sm" onclick="nextPage()">Next</button>
      </div>
    </div>

    <!-- Operations Tab -->
    <div id="tab-operations" class="tab-content">
      <div class="tab-header">
        <h3>Operations Control Center</h3>
        <div class="d-flex gap-2">
          <button class="btn btn-glass" onclick="loadOperations()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>

      <div class="ops-grid mb-4">
        <div class="glass-card ops-card">
          <div class="ops-card-title">Estimated Monthly Cost</div>
          <div class="ops-card-value" id="costMonthly">$0.00</div>
          <div class="ops-card-sub" id="costBudget">Budget: $0.00</div>
        </div>
        <div class="glass-card ops-card">
          <div class="ops-card-title">Storage Cost</div>
          <div class="ops-card-value" id="costStorage">$0.00</div>
          <div class="ops-card-sub" id="storageUsage">0 GB used</div>
        </div>
        <div class="glass-card ops-card">
          <div class="ops-card-title">Processing Cost</div>
          <div class="ops-card-value" id="costProcessing">$0.00</div>
          <div class="ops-card-sub" id="processingUsage">
            0 analyses / 30 days
          </div>
        </div>
        <div class="glass-card ops-card">
          <div class="ops-card-title">Active User Cost</div>
          <div class="ops-card-value" id="costUsers">$0.00</div>
          <div class="ops-card-sub" id="activeUsersCount">0 active users</div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-6 mb-4">
          <div class="glass-card ops-card">
            <div class="ops-card-title">Danger Zone Flags</div>
            <ul class="flag-list" id="riskFlags">
              <li class="flag-item flag-ok">All systems normal</li>
            </ul>
          </div>
        </div>

        <div class="col-lg-6 mb-4">
          <div class="glass-card ops-card">
            <div class="ops-card-title">Operational Toggles</div>
            <div class="toggle-list">
              <label class="toggle-item">
                <input
                  type="checkbox"
                  class="ops-toggle"
                  data-key="ops.toggle.ai_chat"
                />
                <span>AI Chat Assistant</span>
              </label>
              <label class="toggle-item">
                <input
                  type="checkbox"
                  class="ops-toggle"
                  data-key="ops.toggle.video_processing"
                />
                <span>Video Processing</span>
              </label>
              <label class="toggle-item">
                <input
                  type="checkbox"
                  class="ops-toggle"
                  data-key="ops.toggle.document_ocr"
                />
                <span>Document OCR</span>
              </label>
              <label class="toggle-item">
                <input
                  type="checkbox"
                  class="ops-toggle"
                  data-key="ops.toggle.batch_uploads"
                />
                <span>Batch Uploads</span>
              </label>
              <label class="toggle-item">
                <input
                  type="checkbox"
                  class="ops-toggle"
                  data-key="ops.toggle.email_notifications"
                />
                <span>Email Notifications</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="tab-analytics" class="tab-content">
      <div class="tab-header">
        <h3>Platform Analytics</h3>
        <select
          id="analyticsRange"
          class="glass-input"
          onchange="loadAnalytics()"
        >
          <option value="7">Last 7 Days</option>
          <option value="30" selected>Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="365">Last Year</option>
        </select>
      </div>

      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="chart-container">
            <canvas id="userGrowthChart"></canvas>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="chart-container">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="chart-container">
            <canvas id="evidenceChart"></canvas>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="chart-container">
            <canvas id="tierDistributionChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Evidence Tab -->
    <div id="tab-evidence" class="tab-content">
      <div class="tab-header">
        <h3>Evidence Management</h3>
        <div class="d-flex gap-2">
          <input
            type="text"
            id="evidenceSearch"
            class="glass-input"
            placeholder="Search evidence..."
          />
          <select id="evidenceFilter" class="glass-input">
            <option value="">All Types</option>
            <option value="video">Video</option>
            <option value="audio">Audio</option>
            <option value="document">Document</option>
            <option value="image">Image</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>File Name</th>
              <th>Type</th>
              <th>Size</th>
              <th>User</th>
              <th>Uploaded</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="evidenceTableBody">
            <!-- Populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- AI Agents Tab -->
    <div id="tab-agents" class="tab-content">
      <div class="tab-header">
        <h3>AI Agent Activity</h3>
        <button class="btn btn-glass" onclick="refreshAgents()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <div class="agent-stat-card">
            <div class="agent-stat-icon">ü§ñ</div>
            <h4 id="totalAgents">-</h4>
            <p>Total Agents Deployed</p>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="agent-stat-card">
            <div class="agent-stat-icon">‚ö°</div>
            <h4 id="activeAgents">-</h4>
            <p>Currently Active</p>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="agent-stat-card">
            <div class="agent-stat-icon">‚úÖ</div>
            <h4 id="completedJobs">-</h4>
            <p>Jobs Completed Today</p>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Agent Type</th>
              <th>User</th>
              <th>Status</th>
              <th>Started</th>
              <th>Duration</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="agentsTableBody">
            <!-- Populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- System Tab -->
    <div id="tab-system" class="tab-content">
      <div class="tab-header">
        <h3>System Information</h3>
        <button class="btn btn-glass" onclick="loadSystemInfo()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>

      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="system-info-card">
            <h4><i class="fas fa-server"></i> Server Health</h4>
            <div class="info-row">
              <span>CPU Usage</span>
              <span id="cpuUsage">-</span>
            </div>
            <div class="info-row">
              <span>Memory Usage</span>
              <span id="memoryUsage">-</span>
            </div>
            <div class="info-row">
              <span>Disk Usage</span>
              <span id="diskUsage">-</span>
            </div>
            <div class="info-row">
              <span>Uptime</span>
              <span id="uptime">-</span>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="system-info-card">
            <h4><i class="fas fa-database"></i> Database</h4>
            <div class="info-row">
              <span>Total Records</span>
              <span id="dbRecords">-</span>
            </div>
            <div class="info-row">
              <span>Database Size</span>
              <span id="dbSize">-</span>
            </div>
            <div class="info-row">
              <span>Connection Pool</span>
              <span id="dbConnections">-</span>
            </div>
            <div class="info-row">
              <span>Last Backup</span>
              <span id="lastBackup">-</span>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="system-info-card">
            <h4><i class="fas fa-folder"></i> Storage</h4>
            <div class="info-row">
              <span>Total Files</span>
              <span id="totalFiles">-</span>
            </div>
            <div class="info-row">
              <span>Total Size</span>
              <span id="storageSize">-</span>
            </div>
            <div class="info-row">
              <span>Available Space</span>
              <span id="availableSpace">-</span>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-4">
          <div class="system-info-card">
            <h4><i class="fas fa-code"></i> Application</h4>
            <div class="info-row">
              <span>Version</span>
              <span>v2.0.0</span>
            </div>
            <div class="info-row">
              <span>Environment</span>
              <span id="environment">-</span>
            </div>
            <div class="info-row">
              <span>Debug Mode</span>
              <span id="debugMode">-</span>
            </div>
          </div>
        </div>

        <div class="col-12 mb-4">
          <div class="system-info-card">
            <h4><i class="fas fa-palette"></i> Site Controls</h4>
            <div class="site-controls-grid">
              <div>
                <label class="form-label">Theme</label>
                <select id="siteTheme" class="glass-input">
                  <option value="system">System</option>
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                </select>
              </div>
              <div>
                <label class="form-label">Brand Color</label>
                <input
                  type="text"
                  id="brandColor"
                  class="glass-input"
                  placeholder="#c41e3a"
                />
              </div>
              <div>
                <label class="form-label">Accent Color</label>
                <input
                  type="text"
                  id="accentColor"
                  class="glass-input"
                  placeholder="#1e40af"
                />
              </div>
              <div>
                <label class="form-label">Maintenance Message</label>
                <input
                  type="text"
                  id="maintenanceMessage"
                  class="glass-input"
                  placeholder="Maintenance message"
                />
              </div>
              <div>
                <label class="form-label">Announcement Banner</label>
                <input
                  type="text"
                  id="bannerMessage"
                  class="glass-input"
                  placeholder="Banner message"
                />
              </div>
              <div>
                <label class="form-label">Footer Notice</label>
                <input
                  type="text"
                  id="footerNotice"
                  class="glass-input"
                  placeholder="Footer notice text"
                />
              </div>
            </div>

            <div class="site-controls-toggles">
              <label class="toggle-item">
                <input type="checkbox" id="maintenanceMode" />
                <span>Maintenance Mode</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="bannerEnabled" />
                <span>Enable Banner</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="allowSignup" />
                <span>Allow Signups</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="chatEnabled" />
                <span>Enable Chat UI</span>
              </label>
            </div>

            <div class="text-end">
              <button
                class="btn btn-glass-primary"
                onclick="saveSiteControls()"
              >
                <i class="fas fa-save"></i> Save Site Controls
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audit Logs Tab -->
    <div id="tab-logs" class="tab-content">
      <div class="tab-header">
        <h3>Audit Logs</h3>
        <div class="d-flex gap-2">
          <select id="logLevel" class="glass-input" onchange="filterLogs()">
            <option value="">All Levels</option>
            <option value="INFO">Info</option>
            <option value="WARNING">Warning</option>
            <option value="ERROR">Error</option>
            <option value="CRITICAL">Critical</option>
          </select>
          <select id="logAction" class="glass-input" onchange="filterLogs()">
            <option value="">All Actions</option>
            <option value="login">Login</option>
            <option value="logout">Logout</option>
            <option value="upload">Upload</option>
            <option value="delete">Delete</option>
            <option value="update">Update</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>User</th>
              <th>Action</th>
              <th>Level</th>
              <th>Details</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody id="logsTableBody">
            <!-- Populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- User Edit Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content glass-modal">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editUserId" />
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" id="editUserName" class="glass-input" />
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" id="editUserEmail" class="glass-input" />
        </div>
        <div class="mb-3">
          <label class="form-label">Tier</label>
          <select id="editUserTier" class="glass-input">
            <option value="FREE">Free</option>
            <option value="PROFESSIONAL">Professional</option>
            <option value="PREMIUM">Premium</option>
            <option value="ENTERPRISE">Enterprise</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Status</label>
          <select id="editUserStatus" class="glass-input">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-glass" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-glass-primary"
          onclick="saveUser()"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content glass-modal">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-user-plus"></i> Create New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" id="newUserName" class="glass-input" placeholder="John Doe" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Email Address</label>
          <input type="email" id="newUserEmail" class="glass-input" placeholder="john@example.com" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" id="newUserPassword" class="glass-input" placeholder="Min 8 characters" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Organization</label>
          <input type="text" id="newUserOrganization" class="glass-input" placeholder="Law Firm Name" />
        </div>
        <div class="mb-3">
          <label class="form-label">Tier</label>
          <select id="newUserTier" class="glass-input">
            <option value="FREE">Free</option>
            <option value="PROFESSIONAL">Professional</option>
            <option value="PREMIUM">Premium</option>
            <option value="ENTERPRISE">Enterprise</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
        <div class="form-check mb-3">
          <input type="checkbox" id="newUserSendEmail" class="form-check-input" checked />
          <label for="newUserSendEmail" class="form-check-label">Send welcome email with credentials</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-glass-primary" onclick="createUser()">
          <i class="fas fa-user-plus"></i> Create User
        </button>
      </div>
    </div>
  </div>
</div>

<!-- System Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content glass-modal">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-cog"></i> System Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-4" id="settingsTabs">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#settingsGeneral">General</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settingsSecurity">Security</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settingsIntegrations">Integrations</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settingsAdvanced">Advanced</button>
          </li>
        </ul>
        
        <div class="tab-content">
          <!-- General Settings -->
          <div class="tab-pane fade show active" id="settingsGeneral">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Site Name</label>
                <input type="text" id="settingSiteName" class="glass-input" value="BarberX" />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Support Email</label>
                <input type="email" id="settingSupportEmail" class="glass-input" placeholder="support@barberx.info" />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Default Timezone</label>
                <select id="settingTimezone" class="glass-input">
                  <option value="America/New_York">Eastern (ET)</option>
                  <option value="America/Chicago">Central (CT)</option>
                  <option value="America/Denver">Mountain (MT)</option>
                  <option value="America/Los_Angeles">Pacific (PT)</option>
                  <option value="UTC">UTC</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Default Language</label>
                <select id="settingLanguage" class="glass-input">
                  <option value="en">English</option>
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Security Settings -->
          <div class="tab-pane fade" id="settingsSecurity">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Session Timeout (minutes)</label>
                <input type="number" id="settingSessionTimeout" class="glass-input" value="60" min="5" max="1440" />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Max Login Attempts</label>
                <input type="number" id="settingMaxLoginAttempts" class="glass-input" value="5" min="3" max="10" />
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Security Features</label>
                <div class="d-flex flex-wrap gap-3">
                  <label class="toggle-item">
                    <input type="checkbox" id="settingRequire2FA" />
                    <span>Require 2FA for Admins</span>
                  </label>
                  <label class="toggle-item">
                    <input type="checkbox" id="settingEnforceStrongPasswords" checked />
                    <span>Enforce Strong Passwords</span>
                  </label>
                  <label class="toggle-item">
                    <input type="checkbox" id="settingLogAllActions" checked />
                    <span>Log All User Actions</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Integrations Settings -->
          <div class="tab-pane fade" id="settingsIntegrations">
            <div class="row">
              <div class="col-12 mb-3">
                <label class="form-label">OpenAI API Key</label>
                <div class="input-group">
                  <input type="password" id="settingOpenAIKey" class="glass-input" placeholder="sk-..." />
                  <button class="btn btn-glass" onclick="togglePasswordVisibility('settingOpenAIKey')" aria-label="Toggle OpenAI key visibility">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
                <small class="text-muted">Used for AI chat and analysis features</small>
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Stripe Secret Key</label>
                <div class="input-group">
                  <input type="password" id="settingStripeKey" class="glass-input" placeholder="sk_live_..." />
                  <button class="btn btn-glass" onclick="togglePasswordVisibility('settingStripeKey')" aria-label="Toggle Stripe key visibility">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
                <small class="text-muted">Used for payment processing</small>
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Email Service (SendGrid/SES)</label>
                <div class="input-group">
                  <input type="password" id="settingEmailKey" class="glass-input" placeholder="API Key" />
                  <button class="btn btn-glass" onclick="togglePasswordVisibility('settingEmailKey')" aria-label="Toggle email key visibility">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Advanced Settings -->
          <div class="tab-pane fade" id="settingsAdvanced">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Max Upload Size (MB)</label>
                <input type="number" id="settingMaxUploadSize" class="glass-input" value="100" min="10" max="500" />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Storage Retention (days)</label>
                <input type="number" id="settingStorageRetention" class="glass-input" value="365" min="30" max="3650" />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">API Rate Limit (req/min)</label>
                <input type="number" id="settingRateLimit" class="glass-input" value="60" min="10" max="1000" />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Debug Mode</label>
                <select id="settingDebugMode" class="glass-input">
                  <option value="false">Disabled (Production)</option>
                  <option value="true">Enabled (Development)</option>
                </select>
              </div>
              <div class="col-12 mb-3">
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Danger Zone</strong>
                  <div class="mt-2">
                    <button class="btn btn-danger btn-sm" onclick="clearCache()">Clear All Cache</button>
                    <button class="btn btn-danger btn-sm" onclick="rebuildIndexes()">Rebuild Search Indexes</button>
                    <button class="btn btn-danger btn-sm" onclick="exportAllData()">Export All Data</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-glass" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-glass-primary" onclick="saveAllSettings()">
          <i class="fas fa-save"></i> Save All Settings
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // State
  let currentPage = 1;
  let currentTab = "users";
  let users = [];
  let filteredUsers = [];

  // Initialize
  document.addEventListener("DOMContentLoaded", function () {
    loadDashboardData();
    loadUsers();
  });

  async function loadDashboardData() {
    try {
      const response = await fetch("/admin/stats");
      const data = await response.json();

      document.getElementById("totalUsers").textContent = data.total_users || 0;
      document.getElementById("activeUsers").textContent =
        data.active_users || 0;
      document.getElementById("totalEvidence").textContent =
        data.total_evidence || 0;
      document.getElementById("totalRevenue").textContent =
        "$" + (data.revenue || 0).toLocaleString();
    } catch (error) {
      console.error("Error loading dashboard data:", error);
    }
  }

  async function loadUsers() {
    try {
      const response = await fetch("/admin/users");
      users = await response.json();
      filteredUsers = users;
      renderUsers();
    } catch (error) {
      console.error("Error loading users:", error);
    }
  }

  function renderUsers() {
    const tbody = document.getElementById("usersTableBody");
    const startIndex = (currentPage - 1) * 10;
    const endIndex = startIndex + 10;
    const pageUsers = filteredUsers.slice(startIndex, endIndex);

    tbody.innerHTML = pageUsers
      .map(
        (user) => `
    <tr>
      <td>
        <div class="user-cell">
          <div class="user-avatar">${user.full_name ? user.full_name[0].toUpperCase() : user.email[0].toUpperCase()}</div>
          <div>
            <strong>${user.full_name || "N/A"}</strong>
            <br><small class="text-muted">${user.organization || ""}</small>
          </div>
        </div>
      </td>
      <td>${user.email}</td>
      <td><span class="badge badge-${user.tier.toLowerCase()}">${user.tier}</span></td>
      <td><span class="badge ${user.is_active ? "badge-success" : "badge-danger"}">${user.is_active ? "Active" : "Inactive"}</span></td>
      <td>${new Date(user.created_at).toLocaleDateString()}</td>
      <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : "Never"}</td>
      <td>
        <button class="btn btn-sm btn-glass" onclick="editUser(${user.id})" title="Edit">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-glass" onclick="resetPassword(${user.id})" title="Reset Password">
          <i class="fas fa-key"></i>
        </button>
        <button class="btn btn-sm btn-glass text-danger" onclick="deleteUser(${user.id})" title="Delete">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>
  `,
      )
      .join("");

    document.getElementById("currentPage").textContent = currentPage;
    document.getElementById("totalPages").textContent = Math.ceil(
      filteredUsers.length / 10,
    );
  }

  function showTab(tabName) {
    // Hide all tabs
    document
      .querySelectorAll(".tab-content")
      .forEach((tab) => tab.classList.remove("active"));
    document
      .querySelectorAll(".admin-tab")
      .forEach((tab) => tab.classList.remove("active"));

    // Show selected tab
    document.getElementById("tab-" + tabName).classList.add("active");
    event.target.closest(".admin-tab").classList.add("active");

    currentTab = tabName;

    // Load tab-specific data
    if (tabName === "analytics") loadAnalytics();
    if (tabName === "evidence") loadEvidence();
    if (tabName === "agents") refreshAgents();
    if (tabName === "system") loadSystemInfo();
    if (tabName === "operations") loadOperations();
    if (tabName === "logs") loadAuditLogs();
  }

  function searchUsers() {
    const query = document.getElementById("userSearch").value.toLowerCase();
    filteredUsers = users.filter(
      (u) =>
        u.email.toLowerCase().includes(query) ||
        (u.full_name && u.full_name.toLowerCase().includes(query)),
    );
    currentPage = 1;
    renderUsers();
  }

  function filterUsers() {
    const tier = document.getElementById("tierFilter").value;
    filteredUsers = tier ? users.filter((u) => u.tier === tier) : users;
    currentPage = 1;
    renderUsers();
  }

  function previousPage() {
    if (currentPage > 1) {
      currentPage--;
      renderUsers();
    }
  }

  function nextPage() {
    const maxPage = Math.ceil(filteredUsers.length / 10);
    if (currentPage < maxPage) {
      currentPage++;
      renderUsers();
    }
  }

  function editUser(userId) {
    const user = users.find((u) => u.id === userId);
    if (!user) return;

    document.getElementById("editUserId").value = user.id;
    document.getElementById("editUserName").value = user.full_name || "";
    document.getElementById("editUserEmail").value = user.email;
    document.getElementById("editUserTier").value = user.tier;
    document.getElementById("editUserStatus").value = user.is_active;

    new bootstrap.Modal(document.getElementById("editUserModal")).show();
  }

  async function saveUser() {
    const userId = document.getElementById("editUserId").value;
    const data = {
      full_name: document.getElementById("editUserName").value,
      email: document.getElementById("editUserEmail").value,
      tier: document.getElementById("editUserTier").value,
      is_active: document.getElementById("editUserStatus").value === "true",
    };

    try {
      const response = await fetch(`/admin/users/${userId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        alert("User updated successfully");
        loadUsers();
        bootstrap.Modal.getInstance(
          document.getElementById("editUserModal"),
        ).hide();
      }
    } catch (error) {
      alert("Error updating user");
    }
  }

  async function deleteUser(userId) {
    if (!confirm("Are you sure you want to delete this user?")) return;

    try {
      const response = await fetch(`/admin/users/${userId}`, {
        method: "DELETE",
      });
      if (response.ok) {
        alert("User deleted");
        loadUsers();
      }
    } catch (error) {
      alert("Error deleting user");
    }
  }

  async function resetPassword(userId) {
    if (!confirm("Send password reset email to this user?")) return;

    try {
      const response = await fetch(`/admin/users/${userId}/reset-password`, {
        method: "POST",
      });
      if (response.ok) {
        alert("Password reset email sent");
      }
    } catch (error) {
      alert("Error sending reset email");
    }
  }

  async function loadAnalytics() {
    const days = parseInt(document.getElementById('analyticsRange').value) || 30;
    
    try {
      // Fetch analytics data
      const response = await fetch(`/admin/stats?days=${days}`);
      const data = await response.json();
      
      // Destroy existing charts if they exist
      if (window.userGrowthChart) window.userGrowthChart.destroy();
      if (window.revenueChart) window.revenueChart.destroy();
      if (window.evidenceChart) window.evidenceChart.destroy();
      if (window.tierDistributionChart) window.tierDistributionChart.destroy();
      
      // Generate date labels
      const labels = [];
      for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
      }
      
      // User Growth Chart
      const userCtx = document.getElementById('userGrowthChart').getContext('2d');
      window.userGrowthChart = new Chart(userCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Users',
            data: generateTrendData(data.total_users || 100, days, 0.05),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
          }, {
            label: 'Active Users',
            data: generateTrendData(data.active_users || 50, days, 0.08),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'User Growth', color: '#e5e7eb' },
            legend: { labels: { color: '#9ca3af' } }
          },
          scales: {
            x: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,0.05)' } }
          }
        }
      });
      
      // Revenue Chart
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      window.revenueChart = new Chart(revenueCtx, {
        type: 'bar',
        data: {
          labels: labels.filter((_, i) => i % 7 === 0), // Weekly
          datasets: [{
            label: 'Revenue ($)',
            data: generateTrendData(data.revenue || 5000, Math.ceil(days / 7), 0.1),
            backgroundColor: 'rgba(245, 158, 11, 0.7)',
            borderColor: '#f59e0b',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'Weekly Revenue', color: '#e5e7eb' },
            legend: { labels: { color: '#9ca3af' } }
          },
          scales: {
            x: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { ticks: { color: '#6b7280', callback: (v) => '$' + v }, grid: { color: 'rgba(255,255,255,0.05)' } }
          }
        }
      });
      
      // Evidence Processed Chart
      const evidenceCtx = document.getElementById('evidenceChart').getContext('2d');
      window.evidenceChart = new Chart(evidenceCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Evidence Processed',
            data: generateTrendData(data.total_evidence || 500, days, 0.15),
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'Evidence Processing', color: '#e5e7eb' },
            legend: { labels: { color: '#9ca3af' } }
          },
          scales: {
            x: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,0.05)' } }
          }
        }
      });
      
      // Tier Distribution Chart
      const tierCtx = document.getElementById('tierDistributionChart').getContext('2d');
      const tierData = data.tier_distribution || { FREE: 60, PROFESSIONAL: 25, PREMIUM: 10, ENTERPRISE: 5 };
      window.tierDistributionChart = new Chart(tierCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(tierData),
          datasets: [{
            data: Object.values(tierData),
            backgroundColor: ['#6b7280', '#3b82f6', '#f59e0b', '#8b5cf6'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'User Tier Distribution', color: '#e5e7eb' },
            legend: { position: 'bottom', labels: { color: '#9ca3af' } }
          }
        }
      });
      
    } catch (error) {
      console.error('Error loading analytics:', error);
    }
  }
  
  function generateTrendData(endValue, points, volatility) {
    const data = [];
    let current = endValue * 0.7;
    const step = (endValue - current) / points;
    for (let i = 0; i < points; i++) {
      current += step + (Math.random() - 0.5) * endValue * volatility;
      data.push(Math.max(0, Math.round(current)));
    }
    return data;
  }

  async function loadSystemInfo() {
    try {
      const response = await fetch("/admin/system-info");
      const data = await response.json();

      // Update system info display
      document.getElementById("environment").textContent =
        data.environment || "Production";
      document.getElementById("debugMode").textContent = data.debug
        ? "On"
        : "Off";
      loadSiteControls();
    } catch (error) {
      console.error("Error loading system info:", error);
    }
  }

  async function loadSiteControls() {
    try {
      const response = await fetch("/admin/site-controls");
      const data = await response.json();
      const settings = data.settings || {};

      document.getElementById("siteTheme").value =
        settings["ui.theme"] || "system";
      document.getElementById("brandColor").value =
        settings["ui.brand_color"] || "#c41e3a";
      document.getElementById("accentColor").value =
        settings["ui.accent_color"] || "#1e40af";
      document.getElementById("maintenanceMessage").value =
        settings["site.maintenance_message"] || "";
      document.getElementById("bannerMessage").value =
        settings["site.banner_message"] || "";
      document.getElementById("footerNotice").value =
        settings["site.footer_notice"] || "";

      document.getElementById("maintenanceMode").checked =
        !!settings["site.maintenance_mode"];
      document.getElementById("bannerEnabled").checked =
        !!settings["site.banner_enabled"];
      document.getElementById("allowSignup").checked =
        settings["site.allow_signup"] !== false;
      document.getElementById("chatEnabled").checked =
        settings["site.chat_enabled"] !== false;
    } catch (error) {
      console.error("Error loading site controls:", error);
    }
  }

  async function saveSiteControls() {
    const payload = {
      "ui.theme": document.getElementById("siteTheme").value,
      "ui.brand_color": document.getElementById("brandColor").value,
      "ui.accent_color": document.getElementById("accentColor").value,
      "site.maintenance_mode":
        document.getElementById("maintenanceMode").checked,
      "site.maintenance_message":
        document.getElementById("maintenanceMessage").value,
      "site.banner_enabled": document.getElementById("bannerEnabled").checked,
      "site.banner_message": document.getElementById("bannerMessage").value,
      "site.allow_signup": document.getElementById("allowSignup").checked,
      "site.footer_notice": document.getElementById("footerNotice").value,
      "site.chat_enabled": document.getElementById("chatEnabled").checked,
    };

    try {
      const response = await fetch("/admin/site-controls", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        alert("Site controls updated");
      } else {
        alert("Failed to update site controls");
      }
    } catch (error) {
      console.error("Error saving site controls:", error);
      alert("Error saving site controls");
    }
  }

  async function loadOperations() {
    try {
      const response = await fetch("/admin/operations-summary");
      const data = await response.json();

      document.getElementById("costMonthly").textContent =
        `$${(data.costs.total_monthly || 0).toFixed(2)}`;
      document.getElementById("costBudget").textContent =
        `Budget: $${(data.costs.monthly_budget || 0).toFixed(2)} (${(data.costs.budget_utilization_pct || 0).toFixed(1)}%)`;
      document.getElementById("costStorage").textContent =
        `$${(data.costs.storage_monthly || 0).toFixed(2)}`;
      document.getElementById("storageUsage").textContent =
        `${(data.usage.storage_gb || 0).toFixed(2)} GB used`;
      document.getElementById("costProcessing").textContent =
        `$${(data.costs.processing_monthly || 0).toFixed(2)}`;
      document.getElementById("processingUsage").textContent =
        `${data.usage.analyses_last_30_days || 0} analyses / 30 days`;
      document.getElementById("costUsers").textContent =
        `$${(data.costs.active_users_monthly || 0).toFixed(2)}`;
      document.getElementById("activeUsersCount").textContent =
        `${data.usage.active_users || 0} active users`;

      const flags = data.risk_flags || [];
      const flagList = document.getElementById("riskFlags");
      if (flags.length === 0) {
        flagList.innerHTML =
          '<li class="flag-item flag-ok">All systems normal</li>';
      } else {
        flagList.innerHTML = flags
          .map(
            (flag) => `
        <li class="flag-item flag-${flag.level}">
          <span class="flag-label">${flag.label}</span>
          <span class="flag-message">${flag.message}</span>
        </li>
      `,
          )
          .join("");
      }

      const toggleMap = (data.toggles || []).reduce((acc, t) => {
        acc[t.key] = t.value;
        return acc;
      }, {});

      document.querySelectorAll(".ops-toggle").forEach((toggle) => {
        const key = toggle.dataset.key;
        if (key in toggleMap) {
          toggle.checked = toggleMap[key];
        }
      });
    } catch (error) {
      console.error("Error loading operations data:", error);
    }
  }

  document.addEventListener("change", async function (event) {
    if (!event.target.classList.contains("ops-toggle")) return;

    const key = event.target.dataset.key;
    const value = event.target.checked;

    try {
      const response = await fetch("/admin/operations-toggles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key, value }),
      });

      if (!response.ok) {
        throw new Error("Toggle update failed");
      }
    } catch (error) {
      console.error("Error updating toggle:", error);
    }
  });

  async function loadAuditLogs() {
    try {
      const response = await fetch("/admin/audit-logs");
      const logs = await response.json();

      const tbody = document.getElementById("logsTableBody");
      tbody.innerHTML = logs
        .map(
          (log) => `
      <tr>
        <td>${new Date(log.timestamp).toLocaleString()}</td>
        <td>${log.user_email || "System"}</td>
        <td>${log.action}</td>
        <td><span class="badge badge-${log.level.toLowerCase()}">${log.level}</span></td>
        <td>${log.details}</td>
        <td>${log.ip_address || "-"}</td>
      </tr>
    `,
        )
        .join("");
    } catch (error) {
      console.error("Error loading logs:", error);
    }
  }

  // ===== EVIDENCE MANAGEMENT =====
  let evidenceList = [];
  let filteredEvidence = [];
  let evidencePage = 1;
  
  async function loadEvidence() {
    try {
      const response = await fetch('/api/evidence/list');
      const data = await response.json();
      evidenceList = data.evidence || data || [];
      filteredEvidence = evidenceList;
      renderEvidence();
    } catch (error) {
      console.error('Error loading evidence:', error);
      document.getElementById('evidenceTableBody').innerHTML = 
        '<tr><td colspan="7" class="text-center text-muted">Failed to load evidence data</td></tr>';
    }
  }
  
  function renderEvidence() {
    const tbody = document.getElementById('evidenceTableBody');
    const startIndex = (evidencePage - 1) * 10;
    const pageEvidence = filteredEvidence.slice(startIndex, startIndex + 10);
    
    if (pageEvidence.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No evidence found</td></tr>';
      return;
    }
    
    tbody.innerHTML = pageEvidence.map(e => `
      <tr>
        <td>
          <div class="d-flex align-items-center gap-2">
            <i class="fas ${getFileIcon(e.file_type || e.type)}" style="color: ${getFileColor(e.file_type || e.type)}"></i>
            <span>${e.filename || e.name || 'Unnamed'}</span>
          </div>
        </td>
        <td><span class="badge badge-info">${(e.file_type || e.type || 'unknown').toUpperCase()}</span></td>
        <td>${formatFileSize(e.size || e.file_size || 0)}</td>
        <td>${e.user_email || e.uploaded_by || 'Unknown'}</td>
        <td>${new Date(e.created_at || e.uploaded_at || Date.now()).toLocaleDateString()}</td>
        <td><span class="badge ${e.status === 'processed' ? 'badge-success' : 'badge-warning'}">${e.status || 'pending'}</span></td>
        <td>
          <button class="btn btn-sm btn-glass" onclick="viewEvidence('${e.id}')" title="View">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-glass" onclick="downloadEvidence('${e.id}')" title="Download">
            <i class="fas fa-download"></i>
          </button>
          <button class="btn btn-sm btn-glass text-danger" onclick="deleteEvidence('${e.id}')" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }
  
  function getFileIcon(type) {
    const icons = {
      'video': 'fa-video', 'audio': 'fa-music', 'document': 'fa-file-alt',
      'pdf': 'fa-file-pdf', 'image': 'fa-image', 'text': 'fa-file-alt'
    };
    return icons[type?.toLowerCase()] || 'fa-file';
  }
  
  function getFileColor(type) {
    const colors = {
      'video': '#ef4444', 'audio': '#8b5cf6', 'document': '#3b82f6',
      'pdf': '#dc2626', 'image': '#10b981', 'text': '#6b7280'
    };
    return colors[type?.toLowerCase()] || '#6b7280';
  }
  
  function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  function searchEvidence() {
    const query = document.getElementById('evidenceSearch').value.toLowerCase();
    const typeFilter = document.getElementById('evidenceFilter').value;
    
    filteredEvidence = evidenceList.filter(e => {
      const matchesQuery = !query || 
        (e.filename || e.name || '').toLowerCase().includes(query) ||
        (e.user_email || '').toLowerCase().includes(query);
      const matchesType = !typeFilter || (e.file_type || e.type || '').toLowerCase() === typeFilter;
      return matchesQuery && matchesType;
    });
    evidencePage = 1;
    renderEvidence();
  }
  
  function viewEvidence(id) {
    window.open(`/evidence/view/${id}`, '_blank');
  }
  
  function downloadEvidence(id) {
    window.location.href = `/evidence/download/${id}`;
  }
  
  async function deleteEvidence(id) {
    if (!confirm('Are you sure you want to delete this evidence? This action cannot be undone.')) return;
    
    try {
      const response = await fetch(`/admin/analyses/${id}`, { method: 'DELETE' });
      if (response.ok) {
        alert('Evidence deleted successfully');
        loadEvidence();
      } else {
        alert('Failed to delete evidence');
      }
    } catch (error) {
      console.error('Error deleting evidence:', error);
      alert('Error deleting evidence');
    }
  }
  
  // Bind evidence search events
  document.getElementById('evidenceSearch')?.addEventListener('keyup', searchEvidence);
  document.getElementById('evidenceFilter')?.addEventListener('change', searchEvidence);

  // ===== AI AGENTS MANAGEMENT =====
  let agentsList = [];
  
  async function refreshAgents() {
    try {
      // Load agent stats
      const statsResponse = await fetch('/admin/stats');
      const stats = await statsResponse.json();
      
      document.getElementById('totalAgents').textContent = stats.total_agents || 0;
      document.getElementById('activeAgents').textContent = stats.active_agents || 0;
      document.getElementById('completedJobs').textContent = stats.completed_jobs_today || 0;
      
      // Load agents list
      const response = await fetch('/api/agents/list');
      const data = await response.json();
      agentsList = data.agents || data || [];
      renderAgents();
    } catch (error) {
      console.error('Error loading agents:', error);
      document.getElementById('agentsTableBody').innerHTML = 
        '<tr><td colspan="6" class="text-center text-muted">Failed to load agent data</td></tr>';
    }
  }
  
  function renderAgents() {
    const tbody = document.getElementById('agentsTableBody');
    
    if (agentsList.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No active agents</td></tr>';
      return;
    }
    
    tbody.innerHTML = agentsList.map(agent => `
      <tr>
        <td>
          <div class="d-flex align-items-center gap-2">
            <span class="agent-type-icon">${getAgentIcon(agent.type)}</span>
            <strong>${agent.type || agent.name || 'Unknown Agent'}</strong>
          </div>
        </td>
        <td>${agent.user_email || agent.user || 'System'}</td>
        <td>
          <span class="badge ${getAgentStatusClass(agent.status)}">${agent.status || 'unknown'}</span>
        </td>
        <td>${agent.started_at ? new Date(agent.started_at).toLocaleString() : '-'}</td>
        <td>${agent.duration || calculateDuration(agent.started_at)}</td>
        <td>
          ${agent.status === 'running' ? `
            <button class="btn btn-sm btn-glass text-warning" onclick="pauseAgent('${agent.id}')" title="Pause">
              <i class="fas fa-pause"></i>
            </button>
            <button class="btn btn-sm btn-glass text-danger" onclick="stopAgent('${agent.id}')" title="Stop">
              <i class="fas fa-stop"></i>
            </button>
          ` : agent.status === 'paused' ? `
            <button class="btn btn-sm btn-glass text-success" onclick="resumeAgent('${agent.id}')" title="Resume">
              <i class="fas fa-play"></i>
            </button>
            <button class="btn btn-sm btn-glass text-danger" onclick="stopAgent('${agent.id}')" title="Stop">
              <i class="fas fa-stop"></i>
            </button>
          ` : `
            <button class="btn btn-sm btn-glass" onclick="viewAgentLogs('${agent.id}')" title="View Logs">
              <i class="fas fa-file-alt"></i>
            </button>
            <button class="btn btn-sm btn-glass text-danger" onclick="deleteAgent('${agent.id}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          `}
        </td>
      </tr>
    `).join('');
  }
  
  function getAgentIcon(type) {
    const icons = {
      'ocr': 'üìÑ', 'transcription': 'üéôÔ∏è', 'analysis': 'üîç', 
      'video': 'üé¨', 'chat': 'üí¨', 'workflow': '‚öôÔ∏è'
    };
    return icons[type?.toLowerCase()] || 'ü§ñ';
  }
  
  function getAgentStatusClass(status) {
    const classes = {
      'running': 'badge-success', 'paused': 'badge-warning', 
      'completed': 'badge-info', 'failed': 'badge-danger', 'queued': 'badge-secondary'
    };
    return classes[status?.toLowerCase()] || 'badge-secondary';
  }
  
  function calculateDuration(startTime) {
    if (!startTime) return '-';
    const diff = Date.now() - new Date(startTime).getTime();
    const mins = Math.floor(diff / 60000);
    const secs = Math.floor((diff % 60000) / 1000);
    return `${mins}m ${secs}s`;
  }
  
  async function stopAgent(agentId) {
    if (!confirm('Stop this agent? Any in-progress work may be lost.')) return;
    
    try {
      const response = await fetch(`/api/agents/${agentId}`, { method: 'DELETE' });
      if (response.ok) {
        alert('Agent stopped successfully');
        refreshAgents();
      } else {
        alert('Failed to stop agent');
      }
    } catch (error) {
      console.error('Error stopping agent:', error);
      alert('Error stopping agent');
    }
  }
  
  async function pauseAgent(agentId) {
    try {
      const response = await fetch(`/api/agents/${agentId}/pause`, { method: 'POST' });
      if (response.ok) refreshAgents();
    } catch (error) {
      console.error('Error pausing agent:', error);
    }
  }
  
  async function resumeAgent(agentId) {
    try {
      const response = await fetch(`/api/agents/${agentId}/resume`, { method: 'POST' });
      if (response.ok) refreshAgents();
    } catch (error) {
      console.error('Error resuming agent:', error);
    }
  }
  
  async function deleteAgent(agentId) {
    if (!confirm('Delete this agent record?')) return;
    
    try {
      const response = await fetch(`/api/agents/${agentId}`, { method: 'DELETE' });
      if (response.ok) {
        refreshAgents();
      }
    } catch (error) {
      console.error('Error deleting agent:', error);
    }
  }
  
  function viewAgentLogs(agentId) {
    window.open(`/api/agents/status/${agentId}`, '_blank');
  }

  // ===== CREATE USER =====
  function showCreateUser() {
    // Clear form
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUserOrganization').value = '';
    document.getElementById('newUserTier').value = 'FREE';
    document.getElementById('newUserSendEmail').checked = true;
    
    new bootstrap.Modal(document.getElementById('createUserModal')).show();
  }
  
  async function createUser() {
    const name = document.getElementById('newUserName').value.trim();
    const email = document.getElementById('newUserEmail').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const organization = document.getElementById('newUserOrganization').value.trim();
    const tier = document.getElementById('newUserTier').value;
    const sendEmail = document.getElementById('newUserSendEmail').checked;
    
    // Validation
    if (!name || !email || !password) {
      alert('Please fill in all required fields (Name, Email, Password)');
      return;
    }
    
    if (password.length < 8) {
      alert('Password must be at least 8 characters long');
      return;
    }
    
    if (!email.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }
    
    try {
      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          full_name: name,
          email: email,
          password: password,
          organization: organization,
          tier: tier,
          send_welcome_email: sendEmail,
          admin_created: true
        })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        alert('User created successfully!');
        bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
        loadUsers();
      } else {
        alert(data.error || 'Failed to create user');
      }
    } catch (error) {
      console.error('Error creating user:', error);
      alert('Error creating user. Please try again.');
    }
  }
  
  // ===== SYSTEM SETTINGS =====
  function showSystemSettings() {
    loadSettings();
    new bootstrap.Modal(document.getElementById('settingsModal')).show();
  }
  
  async function loadSettings() {
    try {
      const response = await fetch('/admin/settings');
      const data = await response.json();
      const settings = data.settings || data || {};
      
      // Populate form fields
      document.getElementById('settingSiteName').value = settings['site.name'] || 'BarberX';
      document.getElementById('settingSupportEmail').value = settings['site.support_email'] || '';
      document.getElementById('settingTimezone').value = settings['site.timezone'] || 'America/New_York';
      document.getElementById('settingLanguage').value = settings['site.language'] || 'en';
      document.getElementById('settingSessionTimeout').value = settings['security.session_timeout'] || 60;
      document.getElementById('settingMaxLoginAttempts').value = settings['security.max_login_attempts'] || 5;
      document.getElementById('settingRequire2FA').checked = settings['security.require_2fa_admin'] || false;
      document.getElementById('settingEnforceStrongPasswords').checked = settings['security.strong_passwords'] !== false;
      document.getElementById('settingLogAllActions').checked = settings['security.log_all_actions'] !== false;
      document.getElementById('settingMaxUploadSize').value = settings['storage.max_upload_mb'] || 100;
      document.getElementById('settingStorageRetention').value = settings['storage.retention_days'] || 365;
      document.getElementById('settingRateLimit').value = settings['api.rate_limit'] || 60;
      document.getElementById('settingDebugMode').value = settings['debug'] ? 'true' : 'false';
      
      // API keys are not returned for security - show placeholder
      document.getElementById('settingOpenAIKey').placeholder = settings['integrations.openai_configured'] ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'Not configured';
      document.getElementById('settingStripeKey').placeholder = settings['integrations.stripe_configured'] ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'Not configured';
      document.getElementById('settingEmailKey').placeholder = settings['integrations.email_configured'] ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'Not configured';
      
    } catch (error) {
      console.error('Error loading settings:', error);
    }
  }
  
  function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
  }
  
  async function saveAllSettings() {
    const settings = {
      'site.name': document.getElementById('settingSiteName').value,
      'site.support_email': document.getElementById('settingSupportEmail').value,
      'site.timezone': document.getElementById('settingTimezone').value,
      'site.language': document.getElementById('settingLanguage').value,
      'security.session_timeout': parseInt(document.getElementById('settingSessionTimeout').value),
      'security.max_login_attempts': parseInt(document.getElementById('settingMaxLoginAttempts').value),
      'security.require_2fa_admin': document.getElementById('settingRequire2FA').checked,
      'security.strong_passwords': document.getElementById('settingEnforceStrongPasswords').checked,
      'security.log_all_actions': document.getElementById('settingLogAllActions').checked,
      'storage.max_upload_mb': parseInt(document.getElementById('settingMaxUploadSize').value),
      'storage.retention_days': parseInt(document.getElementById('settingStorageRetention').value),
      'api.rate_limit': parseInt(document.getElementById('settingRateLimit').value),
      'debug': document.getElementById('settingDebugMode').value === 'true'
    };
    
    // Only include API keys if they were changed
    const openaiKey = document.getElementById('settingOpenAIKey').value;
    const stripeKey = document.getElementById('settingStripeKey').value;
    const emailKey = document.getElementById('settingEmailKey').value;
    
    if (openaiKey && !openaiKey.includes('‚Ä¢')) settings['integrations.openai_key'] = openaiKey;
    if (stripeKey && !stripeKey.includes('‚Ä¢')) settings['integrations.stripe_key'] = stripeKey;
    if (emailKey && !emailKey.includes('‚Ä¢')) settings['integrations.email_key'] = emailKey;
    
    try {
      const response = await fetch('/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
      });
      
      if (response.ok) {
        alert('Settings saved successfully!');
        bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
      } else {
        const data = await response.json();
        alert(data.error || 'Failed to save settings');
      }
    } catch (error) {
      console.error('Error saving settings:', error);
      alert('Error saving settings');
    }
  }
  
  async function clearCache() {
    if (!confirm('Clear all cache? This may temporarily slow down the application.')) return;
    
    try {
      const response = await fetch('/admin/cache/clear', { method: 'POST' });
      if (response.ok) {
        alert('Cache cleared successfully');
      } else {
        alert('Failed to clear cache');
      }
    } catch (error) {
      alert('Error clearing cache');
    }
  }
  
  async function rebuildIndexes() {
    if (!confirm('Rebuild search indexes? This may take several minutes.')) return;
    
    try {
      const response = await fetch('/admin/indexes/rebuild', { method: 'POST' });
      if (response.ok) {
        alert('Index rebuild started. You will be notified when complete.');
      } else {
        alert('Failed to start index rebuild');
      }
    } catch (error) {
      alert('Error starting index rebuild');
    }
  }
  
  async function exportAllData() {
    if (!confirm('Export all data? This will create a backup file for download.')) return;
    
    try {
      window.location.href = '/admin/export/all';
    } catch (error) {
      alert('Error starting export');
    }
  }
  
  function filterLogs() {
    // Re-load logs with filters
    loadAuditLogs();
  }

  function refreshData() {
    loadDashboardData();
    if (currentTab === "users") loadUsers();
    if (currentTab === "system") loadSystemInfo();
    if (currentTab === "operations") loadOperations();
    if (currentTab === "logs") loadAuditLogs();
  }
</script>

<style>
  .admin-container {
    padding: 2rem;
    max-width: 1600px;
    margin: 0 auto;
  }

  .admin-header {
    padding: 2rem;
  }

  .stats-card {
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .stats-content h3 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }

  .stats-content p {
    color: #6b7280;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .ops-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
  }

  .ops-card {
    padding: 1.5rem;
  }

  .ops-card-title {
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #6b7280;
    margin-bottom: 0.5rem;
  }

  .ops-card-value {
    font-size: 1.6rem;
    font-weight: 700;
    color: #0a0a0f;
  }

  .ops-card-sub {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }

  .flag-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .flag-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.75rem;
    border-radius: 10px;
    background: rgba(15, 23, 42, 0.04);
  }

  .flag-item.flag-ok {
    background: rgba(16, 185, 129, 0.08);
    color: #065f46;
  }

  .flag-item.flag-warning {
    background: rgba(245, 158, 11, 0.12);
    color: #92400e;
  }

  .flag-item.flag-critical {
    background: rgba(239, 68, 68, 0.12);
    color: #991b1b;
  }

  .flag-label {
    font-weight: 600;
  }

  .flag-message {
    font-size: 0.85rem;
  }

  .toggle-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  .toggle-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
    color: #111827;
  }

  .toggle-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }

  .site-controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    margin-bottom: 1.5rem;
  }

  .site-controls-toggles {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem 2rem;
    margin-bottom: 1.5rem;
  }

  .admin-tabs {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    overflow-x: auto;
  }

  .admin-tab {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
    color: #6b7280;
    font-weight: 500;
  }

  .admin-tab:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .admin-tab.active {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
  }

  .tab-content {
    display: none;
    padding: 2rem;
  }

  .tab-content.active {
    display: block;
  }

  .tab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .admin-table {
    width: 100%;
    border-collapse: collapse;
  }

  .admin-table th {
    text-align: left;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    font-weight: 600;
    color: #9ca3af;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .admin-table td {
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .user-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
  }

  .badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .badge-free {
    background: #e5e7eb;
    color: #374151;
  }
  .badge-professional {
    background: #dbeafe;
    color: #1e40af;
  }
  .badge-premium {
    background: #fef3c7;
    color: #92400e;
  }
  .badge-enterprise {
    background: #f3e8ff;
    color: #6b21a8;
  }
  .badge-admin {
    background: #fee2e2;
    color: #991b1b;
  }
  .badge-success {
    background: #d1fae5;
    color: #065f46;
  }
  .badge-danger {
    background: #fee2e2;
    color: #991b1b;
  }
  .badge-info {
    background: #dbeafe;
    color: #1e40af;
  }
  .badge-warning {
    background: #fef3c7;
    color: #92400e;
  }
  .badge-secondary {
    background: #e5e7eb;
    color: #374151;
  }

  .chart-container {
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
  }

  .system-info-card,
  .agent-stat-card {
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .agent-stat-card {
    text-align: center;
  }

  .agent-stat-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .agent-stat-card h4 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  /* Modal styles */
  .glass-modal {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    color: #e5e7eb;
  }
  
  .glass-modal .modal-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1.25rem 1.5rem;
  }
  
  .glass-modal .modal-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .glass-modal .modal-footer {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1rem 1.5rem;
  }
  
  .glass-modal .btn-close {
    filter: invert(1);
    opacity: 0.7;
  }
  
  .glass-modal .nav-tabs {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .glass-modal .nav-tabs .nav-link {
    color: #9ca3af;
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 8px 8px 0 0;
  }
  
  .glass-modal .nav-tabs .nav-link:hover {
    color: #e5e7eb;
    background: rgba(255, 255, 255, 0.05);
  }
  
  .glass-modal .nav-tabs .nav-link.active {
    color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
    border-bottom: 2px solid #3b82f6;
  }
  
  .glass-modal .form-label {
    color: #9ca3af;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
  
  .glass-modal .input-group .glass-input {
    border-radius: 8px 0 0 8px;
  }
  
  .glass-modal .input-group .btn {
    border-radius: 0 8px 8px 0;
  }
  
  .glass-modal .alert-warning {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: #fbbf24;
    border-radius: 8px;
    padding: 1rem;
  }
  
  .agent-type-icon {
    font-size: 1.25rem;
  }
</style>

{% endblock %}
