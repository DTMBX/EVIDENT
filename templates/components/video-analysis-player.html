<!-- Advanced Video Analysis Player -->
<div class="video-analysis-container" id="videoAnalysisContainer">
  <div class="player-main">
    <!-- Video Player -->
    <div class="video-player-wrapper">
      <video id="analysisVideo" class="video-player" controls>
        <source src="" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      
      <!-- Video Overlays -->
      <div class="video-overlays">
        <!-- Scene Detection Overlay -->
        <div class="scene-indicator" id="sceneIndicator">
          <span class="scene-type"></span>
        </div>
        
        <!-- Object Detection Overlay -->
        <canvas id="objectCanvas" class="object-canvas"></canvas>
        
        <!-- Timestamp Overlay -->
        <div class="timestamp-overlay" id="timestampOverlay">
          00:00:00
        </div>
      </div>
      
      <!-- Audio Waveform Visualization -->
      <div class="waveform-container">
        <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
        <div class="waveform-playhead" id="waveformPlayhead"></div>
      </div>
      
      <!--Custom Timeline with Markers -->
      <div class="timeline-container">
        <div class="timeline-track" id="timelineTrack">
          <div class="timeline-progress" id="timelineProgress"></div>
          <div class="timeline-markers" id="timelineMarkers"></div>
          <div class="timeline-scenes" id="timelineScenes"></div>
        </div>
        <div class="timeline-controls">
          <button onclick="skipBackward()" title="Back 10s">‚è™</button>
          <button onclick="playPause()" id="playPauseBtn" title="Play/Pause">‚ñ∂Ô∏è</button>
          <button onclick="skipForward()" title="Forward 10s">‚è©</button>
          <button onclick="toggleSpeed()" id="speedBtn" title="Playback Speed">1x</button>
          <button onclick="toggleMute()" id="muteBtn" title="Mute/Unmute">üîä</button>
          <input type="range" id="volumeSlider" min="0" max="100" value="100" onchange="setVolume(this.value)">
          <button onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
        </div>
      </div>
    </div>
    
    <!-- Synchronized Transcript Panel -->
    <div class="transcript-sync-panel">
      <div class="panel-header">
        <h3>Live Transcript</h3>
        <div class="panel-controls">
          <button onclick="toggleAutoScroll()" class="btn-sm" id="autoScrollBtn">
            <span>üîÑ</span> Auto-scroll
          </button>
          <button onclick="exportTranscript()" class="btn-sm">
            <span>üì•</span> Export
          </button>
        </div>
      </div>
      
      <div class="transcript-content" id="transcriptSync">
        <!-- Transcript segments will be inserted here -->
      </div>
    </div>
  </div>
  
  <!-- Analysis Tools Sidebar -->
  <div class="analysis-tools-sidebar">
    <div class="tools-tabs">
      <button class="tool-tab active" onclick="switchTool('stress')" data-tool="stress">
        Voice Stress
      </button>
      <button class="tool-tab" onclick="switchTool('scenes')" data-tool="scenes">
        Scenes
      </button>
      <button class="tool-tab" onclick="switchTool('quality')" data-tool="quality">
        Quality
      </button>
      <button class="tool-tab" onclick="switchTool('compliance')" data-tool="compliance">
        Compliance
      </button>
      <button class="tool-tab" onclick="switchTool('annotations')" data-tool="annotations">
        Notes
      </button>
    </div>
    
    <!-- Voice Stress Analysis Tool -->
    <div class="tool-panel active" id="tool-stress">
      <h4>Voice Stress Analysis</h4>
      <div class="stress-chart-container">
        <canvas id="stressChart"></canvas>
      </div>
      <div class="stress-summary" id="stressSummary">
        <!-- Will be populated with stress analysis data -->
      </div>
    </div>
    
    <!-- Scene Detection Tool -->
    <div class="tool-panel" id="tool-scenes">
      <h4>Scene Detection</h4>
      <div class="scenes-list" id="scenesList">
        <!-- Will be populated with detected scenes -->
      </div>
    </div>
    
    <!-- Audio Quality Tool -->
    <div class="tool-panel" id="tool-quality">
      <h4>Audio/Video Quality</h4>
      <div class="quality-metrics" id="qualityMetrics">
        <!-- Will be populated with quality metrics -->
      </div>
    </div>
    
    <!-- Compliance Checker Tool -->
    <div class="tool-panel" id="tool-compliance">
      <h4>Compliance Check</h4>
      <div class="compliance-results" id="complianceResults">
        <!-- Will be populated with compliance data -->
      </div>
    </div>
    
    <!-- Annotations Tool -->
    <div class="tool-panel" id="tool-annotations">
      <h4>Annotations</h4>
      <div class="annotation-form">
        <select id="annotationType" class="form-control">
          <option value="timestamp_marker">üìç Timestamp</option>
          <option value="critical_moment">‚ö†Ô∏è Critical</option>
          <option value="evidence_marker">üîç Evidence</option>
          <option value="note">üìù Note</option>
          <option value="question">‚ùì Question</option>
        </select>
        <textarea id="annotationText" class="form-control" placeholder="Add note..." rows="3"></textarea>
        <button onclick="addAnnotation()" class="btn btn-primary btn-block">Add Annotation</button>
      </div>
      <div class="annotations-list" id="annotationsList">
        <!-- Will be populated with annotations -->
      </div>
    </div>
  </div>
</div>

<style>
.video-analysis-container {
  display: grid;
  grid-template-columns: 1fr 350px;
  gap: 1.5rem;
  padding: 1.5rem;
  background: #f8f9fa;
  min-height: 100vh;
}

.player-main {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.video-player-wrapper {
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.video-player {
  width: 100%;
  display: block;
  max-height: 60vh;
}

.video-overlays {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
}

.scene-indicator {
  position: absolute;
  top: 1rem;
  left: 1rem;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 600;
}

.object-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.timestamp-overlay {
  position: absolute;
  bottom: 4rem;
  right: 1rem;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  font-size: 1.25rem;
  font-weight: bold;
}

.waveform-container {
  position: relative;
  height: 80px;
  background: #1a1a1a;
  border-top: 1px solid #333;
}

.waveform-canvas {
  width: 100%;
  height: 100%;
  display: block;
}

.waveform-playhead {
  position: absolute;
  top: 0;
  left: 0;
  width: 2px;
  height: 100%;
  background: #3b82f6;
  pointer-events: none;
}

.timeline-container {
  background: #2a2a2a;
  padding: 1rem;
}

.timeline-track {
  position: relative;
  height: 40px;
  background: #1a1a1a;
  border-radius: 6px;
  cursor: pointer;
  margin-bottom: 1rem;
}

.timeline-progress {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #2563eb);
  border-radius: 6px;
  transition: width 0.1s linear;
}

.timeline-markers {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.timeline-marker {
  position: absolute;
  top: 0;
  height: 100%;
  width: 3px;
  cursor: pointer;
  transition: width 0.2s;
}

.timeline-marker:hover {
  width: 6px;
}

.timeline-marker.critical {
  background: #ef4444;
}

.timeline-marker.evidence {
  background: #10b981;
}

.timeline-marker.note {
  background: #f59e0b;
}

.timeline-scenes {
  position: absolute;
  bottom: -20px;
  left: 0;
  width: 100%;
  height: 15px;
  display: flex;
}

.scene-segment {
  height: 100%;
  border-right: 1px solid #333;
  font-size: 0.65rem;
  color: #999;
  padding: 0 2px;
  white-space: nowrap;
  overflow: hidden;
}

.timeline-controls {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  justify-content: center;
}

.timeline-controls button {
  background: transparent;
  border: 2px solid #444;
  color: #fff;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.2s;
}

.timeline-controls button:hover {
  background: #444;
  border-color: #666;
}

#volumeSlider {
  width: 100px;
}

.transcript-sync-panel {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  max-height: 400px;
}

.panel-header {
  padding: 1rem;
  background: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-header h3 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
}

.panel-controls {
  display: flex;
  gap: 0.5rem;
}

.btn-sm {
  padding: 0.25rem 0.75rem;
  font-size: 0.875rem;
  border-radius: 6px;
  border: 1px solid #dee2e6;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-sm:hover {
  background: #f8f9fa;
}

.transcript-content {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}

.transcript-segment {
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  border-left: 3px solid transparent;
  border-radius: 4px;
  transition: all 0.2s;
}

.transcript-segment:hover {
  background: #f8f9fa;
}

.transcript-segment.active {
  background: #e3f2fd;
  border-left-color: #3b82f6;
}

.segment-meta {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.25rem;
  font-size: 0.75rem;
  color: #6c757d;
}

.segment-speaker {
  font-weight: 600;
  color: #2563eb;
}

.segment-time {
  font-family: 'Courier New', monospace;
  cursor: pointer;
}

.segment-time:hover {
  text-decoration: underline;
}

.segment-text {
  color: #212529;
  line-height: 1.6;
}

.analysis-tools-sidebar {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
}

.tools-tabs {
  display: flex;
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  overflow-x: auto;
}

.tool-tab {
  flex: 1;
  padding: 0.75rem 0.5rem;
  border: none;
  background: transparent;
  font-size: 0.75rem;
  font-weight: 600;
  color: #6c757d;
  cursor: pointer;
  transition: all 0.2s;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  white-space: nowrap;
}

.tool-tab:hover {
  color: #212529;
  background: #e9ecef;
}

.tool-tab.active {
  color: #3b82f6;
  border-bottom-color: #3b82f6;
  background: white;
}

.tool-panel {
  display: none;
  padding: 1rem;
  max-height: calc(100vh - 200px);
  overflow-y: auto;
}

.tool-panel.active {
  display: block;
}

.tool-panel h4 {
  margin: 0 0 1rem 0;
  font-size: 1rem;
  font-weight: 600;
}

.stress-chart-container {
  height: 200px;
  margin-bottom: 1rem;
}

#stressChart {
  width: 100%;
  height: 100%;
}

.stress-summary {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 6px;
}

.stress-metric {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
}

.stress-level {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-weight: 600;
  font-size: 0.75rem;
}

.stress-level.low {
  background: #d1fae5;
  color: #065f46;
}

.stress-level.medium {
  background: #fef3c7;
  color: #92400e;
}

.stress-level.high {
  background: #fee2e2;
  color: #991b1b;
}

.scenes-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.scene-card {
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 6px;
  border-left: 4px solid #3b82f6;
  cursor: pointer;
  transition: all 0.2s;
}

.scene-card:hover {
  background: #e9ecef;
  transform: translateX(4px);
}

.scene-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.scene-type {
  font-weight: 600;
  font-size: 0.875rem;
  text-transform: capitalize;
}

.scene-duration {
  font-size: 0.75rem;
  color: #6c757d;
  font-family: 'Courier New', monospace;
}

.scene-details {
  font-size: 0.75rem;
  color: #6c757d;
}

.quality-metrics {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.quality-card {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 6px;
}

.quality-label {
  font-size: 0.75rem;
  color: #6c757d;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.quality-value {
  font-size: 1.5rem;
  font-weight: 600;
  color: #212529;
}

.quality-bar {
  height: 8px;
  background: #dee2e6;
  border-radius: 4px;
  overflow: hidden;
  margin-top: 0.5rem;
}

.quality-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #059669);
  transition: width 0.3s;
}

.compliance-results {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.compliance-item {
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 6px;
  border-left: 4px solid;
}

.compliance-item.pass {
  border-left-color: #10b981;
}

.compliance-item.warning {
  border-left-color: #f59e0b;
}

.compliance-item.fail {
  border-left-color: #ef4444;
}

.compliance-name {
  font-weight: 600;
  font-size: 0.875rem;
  margin-bottom: 0.25rem;
}

.compliance-status {
  font-size: 0.75rem;
  color: #6c757d;
}

.annotation-form {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 6px;
  margin-bottom: 1rem;
}

.form-control {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.btn-primary {
  background: #3b82f6;
  color: white;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-block {
  width: 100%;
}

.annotations-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.annotation-item {
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 6px;
  border-left: 4px solid;
  position: relative;
}

.annotation-item[data-type="timestamp_marker"] {
  border-left-color: #3b82f6;
}

.annotation-item[data-type="critical_moment"] {
  border-left-color: #ef4444;
}

.annotation-item[data-type="evidence_marker"] {
  border-left-color: #10b981;
}

.annotation-item[data-type="note"] {
  border-left-color: #f59e0b;
}

.annotation-item[data-type="question"] {
  border-left-color: #8b5cf6;
}

.annotation-time {
  font-size: 0.75rem;
  color: #6c757d;
  font-family: 'Courier New', monospace;
  cursor: pointer;
  margin-bottom: 0.25rem;
}

.annotation-time:hover {
  text-decoration: underline;
}

.annotation-content {
  font-size: 0.875rem;
  color: #212529;
}

.annotation-delete {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: none;
  border: none;
  color: #dc3545;
  cursor: pointer;
  font-size: 1rem;
  padding: 0.25rem;
}

.annotation-delete:hover {
  color: #c82333;
}

@media (max-width: 1200px) {
  .video-analysis-container {
    grid-template-columns: 1fr;
  }
  
  .analysis-tools-sidebar {
    order: 2;
  }
}
</style>

<script>
let videoPlayer = null;
let analysisData = null;
let currentAnnotations = [];
let autoScroll = true;
let playbackSpeed = 1;

function initVideoAnalysis(analysisId) {
  videoPlayer = document.getElementById('analysisVideo');
  
  // Load analysis data
  loadAnalysisData(analysisId);
  
  // Setup event listeners
  videoPlayer.addEventListener('timeupdate', onVideoTimeUpdate);
  videoPlayer.addEventListener('play', () => {
    document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è';
  });
  videoPlayer.addEventListener('pause', () => {
    document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è';
  });
  
  // Setup timeline click
  document.getElementById('timelineTrack').addEventListener('click', onTimelineClick);
}

async function loadAnalysisData(analysisId) {
  try {
    const response = await fetch(`/api/analysis/${analysisId}/enhanced`);
    analysisData = await response.json();
    
    // Set video source
    videoPlayer.src = `/api/analysis/${analysisId}/video`;
    
    // Render all components
    renderTranscript();
    renderWaveform();
    renderTimeline();
    renderVoiceStress();
    renderScenes();
    renderQuality();
    renderCompliance();
    renderAnnotations();
    
  } catch (error) {
    console.error('Error loading analysis:', error);
  }
}

function onVideoTimeUpdate() {
  const currentTime = videoPlayer.currentTime;
  const duration = videoPlayer.duration;
  
  // Update timestamp overlay
  document.getElementById('timestampOverlay').textContent = formatTime(currentTime);
  
  // Update timeline progress
  const progress = (currentTime / duration) * 100;
  document.getElementById('timelineProgress').style.width = `${progress}%`;
  
  // Update waveform playhead
  document.getElementById('waveformPlayhead').style.left = `${progress}%`;
  
  // Highlight current transcript segment
  highlightCurrentSegment(currentTime);
  
  // Update scene indicator
  updateSceneIndicator(currentTime);
}

function highlightCurrentSegment(currentTime) {
  if (!analysisData) return;
  
  const segments = document.querySelectorAll('.transcript-segment');
  let activeSegment = null;
  
  segments.forEach(segment => {
    const start = parseFloat(segment.dataset.start);
    const end = parseFloat(segment.dataset.end);
    
    if (currentTime >= start && currentTime <= end) {
      segment.classList.add('active');
      activeSegment = segment;
    } else {
      segment.classList.remove('active');
    }
  });
  
  // Auto-scroll to active segment
  if (activeSegment && autoScroll) {
    activeSegment.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function updateSceneIndicator(currentTime) {
  if (!analysisData?.enhanced_features?.scene_detection) return;
  
  const currentScene = analysisData.enhanced_features.scene_detection.find(
    scene => currentTime >= scene.start_time && currentTime <= scene.end_time
  );
  
  if (currentScene) {
    document.querySelector('.scene-type').textContent = 
      currentScene.type.replace('_', ' ').toUpperCase();
  }
}

function renderTranscript() {
  if (!analysisData?.transcript?.segments) return;
  
  const container = document.getElementById('transcriptSync');
  container.innerHTML = '';
  
  analysisData.transcript.segments.forEach(segment => {
    const div = document.createElement('div');
    div.className = 'transcript-segment';
    div.dataset.start = segment.start_time;
    div.dataset.end = segment.end_time;
    
    div.innerHTML = `
      <div class="segment-meta">
        <span class="segment-speaker">${segment.speaker}</span>
        <span class="segment-time" onclick="seekTo(${segment.start_time})">
          ${formatTime(segment.start_time)}
        </span>
      </div>
      <div class="segment-text">${segment.text}</div>
    `;
    
    container.appendChild(div);
  });
}

function renderWaveform() {
  const canvas = document.getElementById('waveformCanvas');
  const ctx = canvas.getContext('2d');
  
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  if (!analysisData?.enhanced_features?.audio_waveform) return;
  
  const waveform = analysisData.enhanced_features.audio_waveform;
  const width = canvas.width;
  const height = canvas.height;
  const samplesPerPixel = Math.ceil(waveform.length / width);
  
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(0, 0, width, height);
  
  ctx.fillStyle = '#3b82f6';
  ctx.strokeStyle = '#60a5fa';
  ctx.lineWidth = 1;
  
  ctx.beginPath();
  for (let x = 0; x < width; x++) {
    const startIdx = x * samplesPerPixel;
    const endIdx = startIdx + samplesPerPixel;
    const samples = waveform.slice(startIdx, endIdx);
    
    if (samples.length > 0) {
      const avgAmp = samples.reduce((sum, s) => sum + s.amplitude, 0) / samples.length;
      const barHeight = avgAmp * height;
      const y = (height - barHeight) / 2;
      
      ctx.fillRect(x, y, 1, barHeight);
    }
  }
}

function renderTimeline() {
  if (!analysisData) return;
  
  const markersContainer = document.getElementById('timelineMarkers');
  const scenesContainer = document.getElementById('timelineScenes');
  const duration = analysisData.metadata.duration;
  
  markersContainer.innerHTML = '';
  scenesContainer.innerHTML = '';
  
  // Render scene segments
  if (analysisData.enhanced_features?.scene_detection) {
    analysisData.enhanced_features.scene_detection.forEach(scene => {
      const left = (scene.start_time / duration) * 100;
      const width = ((scene.end_time - scene.start_time) / duration) * 100;
      
      const sceneDiv = document.createElement('div');
      sceneDiv.className = 'scene-segment';
      sceneDiv.style.left = `${left}%`;
      sceneDiv.style.width = `${width}%`;
      sceneDiv.title = scene.type;
      
      scenesContainer.appendChild(sceneDiv);
    });
  }
  
  // Render annotation markers
  currentAnnotations.forEach(annotation => {
    const left = (annotation.timestamp / duration) * 100;
    
    const marker = document.createElement('div');
    marker.className = `timeline-marker ${annotation.type.replace('_marker', '')}`;
    marker.style.left = `${left}%`;
    marker.title = annotation.text;
    marker.onclick = () => seekTo(annotation.timestamp);
    
    markersContainer.appendChild(marker);
  });
}

function renderVoiceStress() {
  if (!analysisData?.enhanced_features?.voice_stress_analysis) return;
  
  const summary = analysisData.enhanced_features.summary;
  const stressSummary = document.getElementById('stressSummary');
  
  stressSummary.innerHTML = `
    <div class="stress-metric">
      <span>Average Stress</span>
      <span class="stress-level ${getStressClass(summary.average_stress_level)}">
        ${(summary.average_stress_level * 100).toFixed(0)}%
      </span>
    </div>
    <div class="stress-metric">
      <span>High Stress Moments</span>
      <strong>${summary.high_stress_moments}</strong>
    </div>
  `;
  
  // Render stress chart (simplified)
  const canvas = document.getElementById('stressChart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = 200;
  
  const stressData = analysisData.enhanced_features.voice_stress_analysis;
  const width = canvas.width;
  const height = canvas.height;
  
  ctx.fillStyle = '#f8f9fa';
  ctx.fillRect(0, 0, width, height);
  
  ctx.strokeStyle = '#ef4444';
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  stressData.forEach((point, idx) => {
    const x = (idx / stressData.length) * width;
    const y = height - (point.stress_level * height);
    
    if (idx === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  
  ctx.stroke();
}

function renderScenes() {
  if (!analysisData?.enhanced_features?.scene_detection) return;
  
  const scenesList = document.getElementById('scenesList');
  scenesList.innerHTML = '';
  
  analysisData.enhanced_features.scene_detection.forEach(scene => {
    const div = document.createElement('div');
    div.className = 'scene-card';
    div.onclick = () => seekTo(scene.start_time);
    
    div.innerHTML = `
      <div class="scene-header">
        <span class="scene-type">${scene.type.replace('_', ' ')}</span>
        <span class="scene-duration">${formatTime(scene.start_time)} - ${formatTime(scene.end_time)}</span>
      </div>
      <div class="scene-details">
        ${scene.characteristics.lighting} ‚Ä¢ ${scene.characteristics.motion_level} motion
      </div>
    `;
    
    scenesList.appendChild(div);
  });
}

function renderQuality() {
  if (!analysisData?.enhanced_features?.audio_quality) return;
  
  const quality = analysisData.enhanced_features.audio_quality;
  const metricsContainer = document.getElementById('qualityMetrics');
  
  metricsContainer.innerHTML = `
    <div class="quality-card">
      <div class="quality-label">Overall Quality</div>
      <div class="quality-value">${quality.overall_quality.toUpperCase()}</div>
      <div class="quality-bar">
        <div class="quality-bar-fill" style="width: ${getQualityPercent(quality.overall_quality)}%"></div>
      </div>
    </div>
    <div class="quality-card">
      <div class="quality-label">Signal-to-Noise Ratio</div>
      <div class="quality-value">${quality.metrics.signal_to_noise_ratio} dB</div>
    </div>
    <div class="quality-card">
      <div class="quality-label">Clarity Score</div>
      <div class="quality-value">${(quality.metrics.clarity_score * 100).toFixed(0)}%</div>
    </div>
  `;
}

function renderCompliance() {
  if (!analysisData?.enhanced_features?.compliance_check) return;
  
  const compliance = analysisData.enhanced_features.compliance_check;
  const resultsContainer = document.getElementById('complianceResults');
  
  resultsContainer.innerHTML = '';
  
  Object.entries(compliance.checks).forEach(([name, check]) => {
    const div = document.createElement('div');
    div.className = `compliance-item ${check.status}`;
    
    div.innerHTML = `
      <div class="compliance-name">${name.replace('_', ' ').toUpperCase()}</div>
      <div class="compliance-status">${check.status.toUpperCase()}</div>
    `;
    
    resultsContainer.appendChild(div);
  });
}

function renderAnnotations() {
  const annotationsList = document.getElementById('annotationsList');
  annotationsList.innerHTML = '';
  
  currentAnnotations.forEach((annotation, idx) => {
    const div = document.createElement('div');
    div.className = 'annotation-item';
    div.dataset.type = annotation.type;
    
    div.innerHTML = `
      <div class="annotation-time" onclick="seekTo(${annotation.timestamp})">
        ${formatTime(annotation.timestamp)}
      </div>
      <div class="annotation-content">${annotation.text}</div>
      <button class="annotation-delete" onclick="deleteAnnotation(${idx})">√ó</button>
    `;
    
    annotationsList.appendChild(div);
  });
}

// Control functions
function playPause() {
  if (videoPlayer.paused) {
    videoPlayer.play();
  } else {
    videoPlayer.pause();
  }
}

function skipBackward() {
  videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
}

function skipForward() {
  videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
}

function toggleSpeed() {
  const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
  const currentIndex = speeds.indexOf(playbackSpeed);
  playbackSpeed = speeds[(currentIndex + 1) % speeds.length];
  videoPlayer.playbackRate = playbackSpeed;
  document.getElementById('speedBtn').textContent = `${playbackSpeed}x`;
}

function toggleMute() {
  videoPlayer.muted = !videoPlayer.muted;
  document.getElementById('muteBtn').textContent = videoPlayer.muted ? 'üîá' : 'üîä';
}

function setVolume(value) {
  videoPlayer.volume = value / 100;
}

function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.querySelector('.video-player-wrapper').requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}

function seekTo(time) {
  videoPlayer.currentTime = time;
}

function onTimelineClick(e) {
  const rect = e.target.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  const time = percent * videoPlayer.duration;
  seekTo(time);
}

function toggleAutoScroll() {
  autoScroll = !autoScroll;
  document.getElementById('autoScrollBtn').style.opacity = autoScroll ? '1' : '0.5';
}

function switchTool(toolName) {
  document.querySelectorAll('.tool-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.tool === toolName);
  });
  
  document.querySelectorAll('.tool-panel').forEach(panel => {
    panel.classList.toggle('active', panel.id === `tool-${toolName}`);
  });
}

function addAnnotation() {
  const type = document.getElementById('annotationType').value;
  const text = document.getElementById('annotationText').value;
  
  if (!text.trim()) {
    alert('Please enter annotation text');
    return;
  }
  
  const annotation = {
    type: type,
    timestamp: videoPlayer.currentTime,
    text: text,
    created_at: new Date().toISOString()
  };
  
  currentAnnotations.push(annotation);
  currentAnnotations.sort((a, b) => a.timestamp - b.timestamp);
  
  renderAnnotations();
  renderTimeline();
  
  document.getElementById('annotationText').value = '';
}

function deleteAnnotation(index) {
  currentAnnotations.splice(index, 1);
  renderAnnotations();
  renderTimeline();
}

function exportTranscript() {
  // Implementation for transcript export
  alert('Export functionality coming soon');
}

// Utility functions
function formatTime(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

function getStressClass(level) {
  if (level < 0.4) return 'low';
  if (level < 0.7) return 'medium';
  return 'high';
}

function getQualityPercent(quality) {
  const map = { excellent: 100, good: 75, fair: 50, poor: 25 };
  return map[quality] || 50;
}
</script>
