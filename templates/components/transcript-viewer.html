<!-- Transcript Viewer Component -->
<div class="transcript-viewer" id="transcriptViewer" style="display:none;">
  <div class="transcript-header">
    <h3>Analysis Transcript</h3>
    <div class="transcript-controls">
      <button class="btn-control" onclick="filterSpeaker('all')">All Speakers</button>
      <select id="speakerFilter" class="speaker-select" onchange="filterSpeaker(this.value)">
        <option value="all">All Speakers</option>
      </select>
      <button class="btn-control" onclick="downloadTranscript()">Download</button>
      <button class="btn-control" onclick="closeTranscript()">Close</button>
    </div>
  </div>

  <div class="transcript-stats">
    <div class="stat-item">
      <span class="stat-label">Duration:</span>
      <span class="stat-value" id="transcriptDuration">-</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Speakers:</span>
      <span class="stat-value" id="transcriptSpeakers">-</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Segments:</span>
      <span class="stat-value" id="transcriptSegments">-</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Discrepancies:</span>
      <span class="stat-value" id="transcriptDiscrepancies">-</span>
    </div>
  </div>

  <div class="transcript-content" id="transcriptContent">
    <!-- Segments will be inserted here -->
  </div>
</div>

<style>
.transcript-viewer {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  padding: 2rem;
}

.transcript-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.transcript-header h3 {
  color: #fff;
  margin: 0;
  font-size: 1.5rem;
}

.transcript-controls {
  display: flex;
  gap: 0.75rem;
}

.btn-control {
  padding: 0.5rem 1rem;
  background: #c41e3a;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.btn-control:hover {
  background: #a01729;
  transform: translateY(-2px);
}

.speaker-select {
  padding: 0.5rem 1rem;
  border-radius: 6px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  font-weight: 600;
}

.transcript-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
}

.stat-item {
  display: flex;
  flex-direction: column;
}

.stat-label {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.875rem;
  margin-bottom: 0.25rem;
}

.stat-value {
  color: #fff;
  font-size: 1.25rem;
  font-weight: 700;
}

.transcript-content {
  flex: 1;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
  padding: 1.5rem;
}

.transcript-segment {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border-left: 4px solid;
  border-radius: 6px;
  transition: all 0.2s;
}

.transcript-segment:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: translateX(4px);
}

.transcript-segment.speaker-officer {
  border-left-color: #3b82f6;
}

.transcript-segment.speaker-civilian {
  border-left-color: #10b981;
}

.transcript-segment.speaker-dispatcher {
  border-left-color: #f59e0b;
}

.segment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.speaker-label {
  font-weight: 700;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.speaker-officer {
  color: #3b82f6;
}

.speaker-civilian {
  color: #10b981;
}

.speaker-dispatcher {
  color: #f59e0b;
}

.segment-timestamp {
  font-size: 0.875rem;
  color: rgba(255, 255, 255, 0.5);
  font-family: 'Courier New', monospace;
}

.segment-text {
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.6;
  font-size: 1rem;
}

.segment-confidence {
  margin-top: 0.5rem;
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.4);
}

.confidence-bar {
  display: inline-block;
  width: 60px;
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  margin-left: 0.5rem;
  position: relative;
  overflow: hidden;
}

.confidence-fill {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  background: #10b981;
  border-radius: 2px;
}

/* Scrollbar styling */
.transcript-content::-webkit-scrollbar {
  width: 8px;
}

.transcript-content::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

.transcript-content::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
}

.transcript-content::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

@media (max-width: 768px) {
  .transcript-viewer {
    padding: 1rem;
  }
  
  .transcript-header {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }
  
  .transcript-controls {
    flex-wrap: wrap;
  }
  
  .transcript-stats {
    grid-template-columns: 1fr 1fr;
  }
}
</style>

<script>
let currentTranscriptData = null;
let currentSpeakerFilter = 'all';

function showTranscript(analysisId) {
  // Fetch analysis data
  fetch(`/api/analysis/${analysisId}`)
    .then(response => response.json())
    .then(data => {
      if (!data.report_json_path) {
        alert('Analysis report not available yet');
        return;
      }
      
      // Fetch the actual report
      return fetch(`/api/analysis/${analysisId}/report/json`);
    })
    .then(response => response.json())
    .then(report => {
      currentTranscriptData = report;
      renderTranscript(report);
      document.getElementById('transcriptViewer').style.display = 'flex';
    })
    .catch(error => {
      console.error('Error loading transcript:', error);
      alert('Failed to load transcript');
    });
}

function renderTranscript(report) {
  // Update stats
  document.getElementById('transcriptDuration').textContent = 
    formatDuration(report.metadata.duration);
  document.getElementById('transcriptSpeakers').textContent = 
    report.transcript.speakers.length;
  document.getElementById('transcriptSegments').textContent = 
    report.transcript.total_segments;
  document.getElementById('transcriptDiscrepancies').textContent = 
    report.discrepancies.total;
  
  // Populate speaker filter
  const speakerSelect = document.getElementById('speakerFilter');
  speakerSelect.innerHTML = '<option value="all">All Speakers</option>';
  report.transcript.speakers.forEach(speaker => {
    const option = document.createElement('option');
    option.value = speaker;
    option.textContent = getSpeakerLabel(speaker);
    speakerSelect.appendChild(option);
  });
  
  // Render segments
  renderSegments(report.transcript.segments);
}

function renderSegments(segments) {
  const content = document.getElementById('transcriptContent');
  content.innerHTML = '';
  
  segments.forEach((segment, index) => {
    if (currentSpeakerFilter !== 'all' && segment.speaker !== currentSpeakerFilter) {
      return;
    }
    
    const div = document.createElement('div');
    div.className = `transcript-segment speaker-${getSpeakerClass(segment.speaker)}`;
    div.innerHTML = `
      <div class="segment-header">
        <span class="speaker-label speaker-${getSpeakerClass(segment.speaker)}">
          ${segment.speaker_label || segment.speaker}
        </span>
        <span class="segment-timestamp">
          ${formatTimestamp(segment.start_time)} - ${formatTimestamp(segment.end_time)}
        </span>
      </div>
      <div class="segment-text">${segment.text}</div>
      <div class="segment-confidence">
        Confidence: ${(segment.confidence * 100).toFixed(1)}%
        <span class="confidence-bar">
          <span class="confidence-fill" style="width: ${segment.confidence * 100}%"></span>
        </span>
      </div>
    `;
    content.appendChild(div);
  });
  
  if (content.children.length === 0) {
    content.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No segments match the selected filter</p>';
  }
}

function filterSpeaker(speaker) {
  currentSpeakerFilter = speaker;
  if (currentTranscriptData) {
    renderSegments(currentTranscriptData.transcript.segments);
  }
}

function getSpeakerClass(speaker) {
  if (speaker.includes('OFFICER')) return 'officer';
  if (speaker.includes('CIVILIAN')) return 'civilian';
  if (speaker.includes('DISPATCHER')) return 'dispatcher';
  return 'officer';
}

function getSpeakerLabel(speaker) {
  const labels = {
    'OFFICER_01': 'Primary Officer',
    'OFFICER_02': 'Backup Officer',
    'CIVILIAN': 'Subject',
    'DISPATCHER': 'Radio Dispatch'
  };
  return labels[speaker] || speaker;
}

function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatTimestamp(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = (seconds % 60).toFixed(1);
  return `${mins}:${secs.padStart(4, '0')}`;
}

function downloadTranscript() {
  if (!currentTranscriptData) return;
  
  let text = 'BWC FORENSIC ANALYSIS TRANSCRIPT\n';
  text += '='.repeat(60) + '\n\n';
  text += `Case Number: ${currentTranscriptData.metadata.case_number}\n`;
  text += `Duration: ${formatDuration(currentTranscriptData.metadata.duration)}\n\n`;
  text += 'TRANSCRIPT\n';
  text += '-'.repeat(60) + '\n\n';
  
  currentTranscriptData.transcript.segments.forEach(segment => {
    text += `[${formatTimestamp(segment.start_time)}] ${segment.speaker_label}: ${segment.text}\n`;
  });
  
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `transcript_${currentTranscriptData.metadata.case_number}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

function closeTranscript() {
  document.getElementById('transcriptViewer').style.display = 'none';
  currentTranscriptData = null;
  currentSpeakerFilter = 'all';
}
</script>
