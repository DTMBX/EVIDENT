<!-- PWA Install Prompt -->
<div id="pwaInstallPrompt" class="pwa-install-prompt" style="display: none;">
  <div class="pwa-install-content">
    <div class="pwa-install-icon">
      <i class="fas fa-mobile-alt"></i>
    </div>
    <div class="pwa-install-text">
      <h4>Install BarberX</h4>
      <p>Access BarberX faster with offline support</p>
    </div>
    <div class="pwa-install-actions">
      <button id="pwaInstallBtn" class="btn btn-primary">
        <i class="fas fa-download"></i> Install
      </button>
      <button id="pwaInstallDismiss" class="btn btn-link">
        Later
      </button>
    </div>
  </div>
</div>

<style>
.pwa-install-prompt {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  animation: slideUp 0.3s ease-out;
}

.pwa-install-content {
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  max-width: 400px;
}

.dark-mode .pwa-install-content {
  background: #161b22;
  border: 1px solid #30363d;
}

.pwa-install-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
  flex-shrink: 0;
}

.pwa-install-text h4 {
  margin: 0 0 4px 0;
  font-size: 16px;
  font-weight: 600;
}

.pwa-install-text p {
  margin: 0;
  font-size: 13px;
  color: #6b7280;
}

.pwa-install-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

@media (max-width: 480px) {
  .pwa-install-prompt {
    left: 10px;
    right: 10px;
    transform: none;
  }
  
  .pwa-install-content {
    max-width: none;
  }
}
</style>

<script>
// PWA Installation & Service Worker Registration
(function() {
  let deferredPrompt;
  const installPrompt = document.getElementById('pwaInstallPrompt');
  const installBtn = document.getElementById('pwaInstallBtn');
  const dismissBtn = document.getElementById('pwaInstallDismiss');
  
  // Register service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/assets/js/sw.js')
        .then(registration => {
          console.log('[PWA] Service Worker registered:', registration.scope);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateNotification();
              }
            });
          });
        })
        .catch(err => {
          console.error('[PWA] Service Worker registration failed:', err);
        });
    });
  }
  
  // Capture install prompt
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show install prompt if not dismissed before
    if (!localStorage.getItem('pwaInstallDismissed')) {
      setTimeout(() => {
        installPrompt.style.display = 'block';
      }, 3000); // Show after 3 seconds
    }
  });
  
  // Install button click
  if (installBtn) {
    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      console.log('[PWA] Install outcome:', outcome);
      
      if (outcome === 'accepted') {
        showToast('BarberX installed successfully!', 'success');
      }
      
      deferredPrompt = null;
      installPrompt.style.display = 'none';
    });
  }
  
  // Dismiss button click
  if (dismissBtn) {
    dismissBtn.addEventListener('click', () => {
      installPrompt.style.display = 'none';
      localStorage.setItem('pwaInstallDismissed', 'true');
    });
  }
  
  // App installed event
  window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed');
    showToast('Welcome to BarberX! You can now use the app offline.', 'success');
    installPrompt.style.display = 'none';
  });
  
  // Request notification permission
  if ('Notification' in window && 'serviceWorker' in navigator) {
    // Only request after user interaction
    setTimeout(() => {
      if (Notification.permission === 'default') {
        requestNotificationPermission();
      }
    }, 10000); // 10 seconds after load
  }
  
  async function requestNotificationPermission() {
    const permission = await Notification.requestPermission();
    
    if (permission === 'granted') {
      console.log('[PWA] Notification permission granted');
      subscribeUserToPush();
    } else {
      console.log('[PWA] Notification permission denied');
    }
  }
  
  async function subscribeUserToPush() {
    try {
      const registration = await navigator.serviceWorker.ready;
      
      // Check if already subscribed
      const existingSubscription = await registration.pushManager.getSubscription();
      if (existingSubscription) {
        console.log('[PWA] Already subscribed to push');
        return;
      }
      
      // Subscribe to push
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(
          'YOUR_PUBLIC_VAPID_KEY_HERE' // TODO: Replace with actual key
        )
      });
      
      // Send subscription to server
      await fetch('/api/push/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(subscription)
      });
      
      console.log('[PWA] Push subscription successful');
    } catch (err) {
      console.error('[PWA] Push subscription failed:', err);
    }
  }
  
  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
      .replace(/\-/g, '+')
      .replace(/_/g, '/');
    
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }
  
  function showUpdateNotification() {
    const toast = document.createElement('div');
    toast.className = 'pwa-update-toast';
    toast.innerHTML = `
      <div style="padding: 16px; background: #3b82f6; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
        <div style="font-weight: 600; margin-bottom: 4px;">Update Available</div>
        <div style="font-size: 14px; margin-bottom: 12px;">A new version of BarberX is available.</div>
        <button onclick="window.location.reload()" style="background: white; color: #3b82f6; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">
          Reload Now
        </button>
      </div>
    `;
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
    document.body.appendChild(toast);
  }
  
  function showToast(message, type = 'info') {
    console.log(`[Toast] ${type}: ${message}`);
    // TODO: Integrate with existing toast notification system
  }
  
  // Background sync registration
  async function registerBackgroundSync() {
    if ('serviceWorker' in navigator && 'sync' in navigator.serviceWorker) {
      try {
        const registration = await navigator.serviceWorker.ready;
        await registration.sync.register('sync-evidence');
        console.log('[PWA] Background sync registered');
      } catch (err) {
        console.error('[PWA] Background sync failed:', err);
      }
    }
  }
  
  // Offline detection
  window.addEventListener('online', () => {
    console.log('[PWA] Back online');
    showToast('Connection restored', 'success');
    registerBackgroundSync();
  });
  
  window.addEventListener('offline', () => {
    console.log('[PWA] Offline mode');
    showToast('Working offline - changes will sync when online', 'warning');
  });
  
  // Expose PWA utilities globally
  window.pwa = {
    registerBackgroundSync,
    requestNotificationPermission
  };
})();
</script>
