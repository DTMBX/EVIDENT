{% extends "base.html" %}
{% block title %}Integrated Evidence Analysis{% endblock %}

{% block content %}
{% include 'components/premium-styles.html' %}

<div class="container-fluid mt-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="glass-card">
        <div class="glass-card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="mb-2">üîç Integrated Evidence Analysis</h2>
              <p class="text-muted mb-0">Upload ‚Üí Analyze ‚Üí Chat ‚Üí Generate Documents</p>
            </div>
            <div>
              <button class="btn btn-glass" onclick="showQuickStart()">
                <i class="fas fa-info-circle"></i> Quick Start
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Panel: Upload & Analysis -->
    <div class="col-lg-4">
      <!-- Upload Section -->
      <div class="glass-card mb-3">
        <div class="glass-card-header">
          <h5><i class="fas fa-upload"></i> 1. Upload Evidence</h5>
        </div>
        <div class="glass-card-body">
          <div class="mb-3">
            <label class="form-label">Case ID</label>
            <input type="text" id="caseId" class="glass-input" placeholder="Enter case identifier">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Case Type</label>
            <select id="caseType" class="glass-input">
              <option value="criminal">Criminal</option>
              <option value="civil">Civil</option>
              <option value="family">Family Law</option>
              <option value="corporate">Corporate</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Upload Files</label>
            <input type="file" id="evidenceFiles" class="glass-input" multiple 
                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.mp4,.mov,.wav,.mp3">
            <small class="text-muted">PDF, Word, Images, Audio, Video</small>
          </div>
          
          <button class="btn btn-glass-primary w-100" onclick="processEvidence()">
            <i class="fas fa-magic"></i> Process with AI
          </button>
        </div>
      </div>

      <!-- Processing Status -->
      <div class="glass-card mb-3" id="processingStatus" style="display: none;">
        <div class="glass-card-header">
          <h5><i class="fas fa-cog fa-spin"></i> Processing...</h5>
        </div>
        <div class="glass-card-body">
          <div id="statusSteps">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>

      <!-- Analysis Results Summary -->
      <div class="glass-card" id="resultsSummary" style="display: none;">
        <div class="glass-card-header">
          <h5><i class="fas fa-chart-pie"></i> Analysis Summary</h5>
        </div>
        <div class="glass-card-body">
          <div id="summaryContent">
            <!-- Populated after processing -->
          </div>
        </div>
      </div>
    </div>

    <!-- Center Panel: AI Chat -->
    <div class="col-lg-4">
      <div class="glass-card" style="height: 85vh; display: flex; flex-direction: column;">
        <div class="glass-card-header">
          <h5><i class="fas fa-comments"></i> 2. AI Evidence Assistant</h5>
        </div>
        <div class="glass-card-body flex-grow-1" style="overflow-y: auto;" id="chatMessages">
          <div class="text-center text-muted py-5">
            <i class="fas fa-robot" style="font-size: 48px; opacity: 0.3;"></i>
            <p class="mt-3">Process evidence to enable AI chat</p>
          </div>
        </div>
        <div class="glass-card-footer">
          <div class="input-group">
            <input type="text" id="chatInput" class="glass-input" 
                   placeholder="Ask about your evidence..." disabled>
            <button class="btn btn-glass-primary" onclick="sendChatMessage()" id="chatSendBtn" disabled>
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          
          <!-- Quick Questions -->
          <div id="quickQuestions" class="mt-2" style="display: none;">
            <small class="text-muted">Quick questions:</small><br>
            <button class="btn btn-glass btn-sm mt-1" onclick="askQuickQuestion('What are the key documents?')">
              Key documents
            </button>
            <button class="btn btn-glass btn-sm mt-1" onclick="askQuickQuestion('Are there compliance issues?')">
              Compliance
            </button>
            <button class="btn btn-glass btn-sm mt-1" onclick="askQuickQuestion('Build a timeline')">
              Timeline
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel: Actions & Documents -->
    <div class="col-lg-4">
      <!-- Suggested Actions -->
      <div class="glass-card mb-3" id="suggestedActions" style="display: none;">
        <div class="glass-card-header">
          <h5><i class="fas fa-lightbulb"></i> Suggested Actions</h5>
        </div>
        <div class="glass-card-body">
          <div id="actionsContent">
            <!-- Populated after processing -->
          </div>
        </div>
      </div>

      <!-- Generate Documents -->
      <div class="glass-card mb-3">
        <div class="glass-card-header">
          <h5><i class="fas fa-file-alt"></i> 3. Generate Documents</h5>
        </div>
        <div class="glass-card-body">
          <div class="mb-3">
            <label class="form-label">Document Type</label>
            <select id="documentType" class="glass-input" disabled>
              <optgroup label="Motions">
                <option value="motion_to_dismiss">Motion to Dismiss</option>
                <option value="motion_for_summary_judgment">Motion for Summary Judgment</option>
                <option value="motion_in_limine">Motion in Limine</option>
              </optgroup>
              <optgroup label="Briefs">
                <option value="memorandum">Memorandum</option>
                <option value="trial_brief">Trial Brief</option>
                <option value="appellate_brief">Appellate Brief</option>
              </optgroup>
              <optgroup label="Letters">
                <option value="demand_letter">Demand Letter</option>
                <option value="cease_and_desist">Cease & Desist</option>
                <option value="opinion_letter">Opinion Letter</option>
              </optgroup>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Jurisdiction</label>
            <select id="jurisdiction" class="glass-input" disabled>
              <option value="federal">Federal</option>
              <option value="california">California</option>
              <option value="new_york">New York</option>
              <option value="texas">Texas</option>
              <option value="florida">Florida</option>
            </select>
          </div>
          
          <button class="btn btn-glass-primary w-100" onclick="generateDocument()" id="generateBtn" disabled>
            <i class="fas fa-file-contract"></i> Generate Document
          </button>
        </div>
      </div>

      <!-- Generated Documents -->
      <div class="glass-card" id="generatedDocs" style="display: none;">
        <div class="glass-card-header">
          <h5><i class="fas fa-folder"></i> Generated Documents</h5>
        </div>
        <div class="glass-card-body">
          <div id="docsContent">
            <!-- Populated after generation -->
          </div>
        </div>
      </div>

      <!-- Active Agents -->
      <div class="glass-card mt-3" id="activeAgents" style="display: none;">
        <div class="glass-card-header">
          <h5><i class="fas fa-robot"></i> Active AI Agents</h5>
        </div>
        <div class="glass-card-body">
          <div id="agentsContent">
            <!-- Populated after deployment -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Start Modal -->
<div class="modal fade" id="quickStartModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content glass-modal">
      <div class="modal-header">
        <h5 class="modal-title">üöÄ Quick Start Guide</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6>1Ô∏è‚É£ Upload Evidence</h6>
        <p>Upload PDFs, images, audio, or video files. AI will automatically process them.</p>
        
        <h6 class="mt-3">2Ô∏è‚É£ AI Analysis</h6>
        <p>Behind the scenes, AI agents will:</p>
        <ul>
          <li>üìÇ Categorize documents</li>
          <li>üîç Extract entities (names, dates, amounts)</li>
          <li>üîí Flag privileged communications</li>
          <li>‚≠ê Identify key documents</li>
          <li>üìÖ Build timeline</li>
          <li>‚úÖ Check compliance</li>
        </ul>
        
        <h6 class="mt-3">3Ô∏è‚É£ Chat with AI</h6>
        <p>Ask questions about your evidence:</p>
        <ul>
          <li>"What are the key documents?"</li>
          <li>"Are there compliance issues?"</li>
          <li>"Build a timeline of events"</li>
          <li>"What should I review first?"</li>
        </ul>
        
        <h6 class="mt-3">4Ô∏è‚É£ Generate Documents</h6>
        <p>Create legal documents based on your evidence:</p>
        <ul>
          <li>‚öñÔ∏è Motions with case law citations</li>
          <li>üìÑ Legal briefs with table of authorities</li>
          <li>‚úâÔ∏è Demand letters and cease & desist</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-glass-primary" data-bs-dismiss="modal">Got it!</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentWorkflowId = null;

function showQuickStart() {
  new bootstrap.Modal(document.getElementById('quickStartModal')).show();
}

async function processEvidence() {
  const caseId = document.getElementById('caseId').value;
  const caseType = document.getElementById('caseType').value;
  const files = document.getElementById('evidenceFiles').files;
  
  if (!caseId) {
    alert('Please enter a case ID');
    return;
  }
  
  if (files.length === 0) {
    alert('Please select files to upload');
    return;
  }
  
  // Show processing status
  document.getElementById('processingStatus').style.display = 'block';
  updateProcessingStatus('Uploading files...', 'loading');
  
  // Prepare file data
  const fileData = [];
  for (let i = 0; i < files.length; i++) {
    fileData.push({
      name: files[i].name,
      size: files[i].size,
      type: files[i].type
    });
  }
  
  try {
    // Call unified workflow API
    updateProcessingStatus('Deploying AI agents...', 'loading');
    
    const response = await fetch('/api/workflow/process-evidence', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        id: caseId,
        case_id: caseId,
        case_type: caseType,
        files: fileData
      })
    });
    
    const result = await response.json();
    
    if (result.error) {
      updateProcessingStatus('Error: ' + result.error, 'error');
      return;
    }
    
    // Save workflow ID
    currentWorkflowId = result.workflow_id;
    
    // Update UI with results
    updateProcessingStatus('‚úÖ Processing complete!', 'success');
    displayResults(result);
    enableChat();
    enableDocumentGeneration();
    showSuggestedActions(result.suggested_actions);
    showActiveAgents(result.agents_deployed);
    
  } catch (error) {
    updateProcessingStatus('Error: ' + error.message, 'error');
  }
}

function updateProcessingStatus(message, status) {
  const statusDiv = document.getElementById('statusSteps');
  const icon = status === 'loading' ? '<i class="fas fa-spinner fa-spin"></i>' :
               status === 'success' ? '<i class="fas fa-check text-success"></i>' :
               '<i class="fas fa-times text-danger"></i>';
  
  statusDiv.innerHTML += `<div class="mb-2">${icon} ${message}</div>`;
}

function displayResults(result) {
  const summary = document.getElementById('resultsSummary');
  const content = document.getElementById('summaryContent');
  
  summary.style.display = 'block';
  
  const discovery = result.discovery || {};
  const compliance = result.compliance || {};
  
  content.innerHTML = `
    <div class="stat-item mb-2">
      <i class="fas fa-file"></i> 
      <strong>${discovery.processed || 0}</strong> documents processed
    </div>
    <div class="stat-item mb-2">
      <i class="fas fa-star"></i> 
      <strong>${(discovery.key_documents || []).length}</strong> key documents
    </div>
    <div class="stat-item mb-2">
      <i class="fas fa-lock"></i> 
      <strong>${(discovery.privileged_docs || []).length}</strong> privileged
    </div>
    <div class="stat-item mb-2">
      <i class="fas fa-check-circle"></i> 
      <strong>${compliance.compliance_rate || 0}%</strong> compliance
    </div>
  `;
}

function enableChat() {
  document.getElementById('chatInput').disabled = false;
  document.getElementById('chatSendBtn').disabled = false;
  document.getElementById('quickQuestions').style.display = 'block';
  
  // Clear placeholder
  document.getElementById('chatMessages').innerHTML = `
    <div class="alert alert-info">
      <i class="fas fa-robot"></i> Hi! I've analyzed your evidence. Ask me anything!
    </div>
  `;
}

function enableDocumentGeneration() {
  document.getElementById('documentType').disabled = false;
  document.getElementById('jurisdiction').disabled = false;
  document.getElementById('generateBtn').disabled = false;
}

function showSuggestedActions(actions) {
  if (!actions || actions.length === 0) return;
  
  const actionsDiv = document.getElementById('suggestedActions');
  const content = document.getElementById('actionsContent');
  
  actionsDiv.style.display = 'block';
  
  content.innerHTML = actions.map(action => `
    <div class="alert alert-${action.priority === 'critical' ? 'danger' : action.priority === 'high' ? 'warning' : 'info'} mb-2">
      <div class="d-flex align-items-center">
        <div style="font-size: 24px; margin-right: 10px;">${action.icon}</div>
        <div class="flex-grow-1">
          <strong>${action.description}</strong>
        </div>
      </div>
    </div>
  `).join('');
}

function showActiveAgents(agents) {
  if (!agents) return;
  
  const agentsDiv = document.getElementById('activeAgents');
  const content = document.getElementById('agentsContent');
  
  agentsDiv.style.display = 'block';
  
  const agentNames = {
    discovery: 'üìÇ Discovery Processor',
    organizer: 'üìÅ Evidence Organizer',
    timeline: 'üìÖ Timeline Builder',
    compliance: '‚úÖ Compliance Checker'
  };
  
  content.innerHTML = Object.entries(agents)
    .filter(([type, id]) => id)
    .map(([type, id]) => `
      <div class="badge bg-success mb-1 me-1">
        ${agentNames[type] || type}
      </div>
    `).join('');
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const query = input.value.trim();
  
  if (!query || !currentWorkflowId) return;
  
  // Add user message
  addChatMessage(query, 'user');
  input.value = '';
  
  // Show loading
  addChatMessage('Thinking...', 'bot', true);
  
  try {
    const response = await fetch('/api/workflow/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        workflow_id: currentWorkflowId,
        query: query
      })
    });
    
    const result = await response.json();
    
    // Remove loading message
    document.querySelector('.chat-loading')?.remove();
    
    // Add bot response
    addChatMessage(result.response, 'bot');
    
  } catch (error) {
    document.querySelector('.chat-loading')?.remove();
    addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
  }
}

function addChatMessage(text, sender, isLoading = false) {
  const messagesDiv = document.getElementById('chatMessages');
  const messageClass = sender === 'user' ? 'bg-primary text-white' : 'bg-light';
  const align = sender === 'user' ? 'text-end' : 'text-start';
  const loadingClass = isLoading ? 'chat-loading' : '';
  
  const messageHtml = `
    <div class="${align} mb-3 ${loadingClass}">
      <div class="d-inline-block ${messageClass} px-3 py-2 rounded" style="max-width: 80%;">
        ${text}
      </div>
    </div>
  `;
  
  messagesDiv.innerHTML += messageHtml;
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function askQuickQuestion(question) {
  document.getElementById('chatInput').value = question;
  sendChatMessage();
}

async function generateDocument() {
  const docType = document.getElementById('documentType').value;
  const jurisdiction = document.getElementById('jurisdiction').value;
  
  if (!currentWorkflowId) {
    alert('Please process evidence first');
    return;
  }
  
  // Show loading
  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
  
  try {
    const response = await fetch('/api/workflow/generate-document', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        workflow_id: currentWorkflowId,
        document_type: docType,
        custom_inputs: {
          jurisdiction: jurisdiction
        }
      })
    });
    
    const result = await response.json();
    
    if (result.error) {
      alert('Error: ' + result.error);
    } else {
      showGeneratedDocument(result);
    }
    
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-file-contract"></i> Generate Document';
  }
}

function showGeneratedDocument(result) {
  const docsDiv = document.getElementById('generatedDocs');
  const content = document.getElementById('docsContent');
  
  docsDiv.style.display = 'block';
  
  const docHtml = `
    <div class="alert alert-success mb-2">
      <h6><i class="fas fa-file-alt"></i> Document Generated!</h6>
      <p class="mb-2 small">${result.document_type || 'Legal Document'}</p>
      <button class="btn btn-sm btn-glass" onclick="viewDocument('${result.file_path}')">
        <i class="fas fa-eye"></i> View
      </button>
      <button class="btn btn-sm btn-glass" onclick="downloadDocument('${result.file_path}')">
        <i class="fas fa-download"></i> Download
      </button>
    </div>
  `;
  
  content.innerHTML = docHtml + content.innerHTML;
}

function viewDocument(filePath) {
  window.open('/view/' + filePath, '_blank');
}

function downloadDocument(filePath) {
  window.location.href = '/download/' + filePath;
}

// Enable Enter key for chat
document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendChatMessage();
  }
});
</script>

<style>
.stat-item {
  padding: 8px 12px;
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
}

.chat-loading {
  opacity: 0.6;
}

#chatMessages {
  min-height: 300px;
}
</style>

{% endblock %}
